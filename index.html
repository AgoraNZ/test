<!DOCTYPE html>
<html lang="en">

<head>
    <!-- ... [Same as before up to the script tags] ... -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <!-- IndexedDB library for offline storage -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
</head>

<body>
    <!-- ... [Same as before] ... -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            // ... [Same as before] ...
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const firestore = firebase.firestore();

        // Initialize IndexedDB using Dexie
        const db = new Dexie("OfflineData");
        db.version(1).stores({
            forms: "++id, dairyNumber, formData, pdfBlob"
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/test/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(err => {
                    console.error('Service Worker registration failed:', err);
                });
        }

        // ... [Rest of your JavaScript code] ...

        async function generatePDF() {
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const dairyNumber = formData.get('dairy-number');

            await saveFarmDetails(formData); // Save farm details if not found

            const { jsPDF } = window.jspdf;
            let pdf = new jsPDF('p', 'pt', 'a4');

            // Add logo centered
            const logoStorageRef = storage.ref('Picture3.jpg');
            try {
                const logoUrl = await logoStorageRef.getDownloadURL();
                const logo = await fetch(logoUrl).then((res) => res.blob());
                const reader = new FileReader();
                reader.readAsDataURL(logo);
                reader.onload = function () {
                    const imgData = reader.result;
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgWidth = pageWidth - 80; // Leave some margins
                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                    const x = (pageWidth - imgWidth) / 2; // Center the image
                    pdf.addImage(imgData, 'JPEG', x, 40, imgWidth, imgHeight);

                    // ... [Rest of the PDF generation code] ...

                    // Save PDF and upload to Firebase
                    const pdfBlob = pdf.output('blob');

                    if (navigator.onLine) {
                        uploadPDF(dairyNumber, pdfBlob);
                    } else {
                        // Save data to IndexedDB
                        db.forms.add({
                            dairyNumber: dairyNumber,
                            formData: Object.fromEntries(formData.entries()),
                            pdfBlob: pdfBlob
                        }).then(() => {
                            console.log('Data saved locally. Will sync when back online.');
                        }).catch((error) => {
                            console.error('Error saving data locally:', error);
                        });
                    }

                    pdf.save('Dairy_Shed_Hygiene_Checklist.pdf');
                };
            } catch (error) {
                console.error('Error fetching logo:', error);
            }
        }

        function uploadPDF(dairyNumber, pdfBlob) {
            const timestamp = new Date().toISOString().split('T')[0];
            const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
            const storageRef = storage.ref(`customers/${dairyNumber}/${fileName}`);

            storageRef.put(pdfBlob).then(() => {
                console.log('PDF uploaded successfully');
            }).catch((error) => {
                console.error('Error uploading PDF:', error);
            });
        }

        window.addEventListener('online', syncDataWithFirebase);

        async function syncDataWithFirebase() {
            const offlineForms = await db.forms.toArray();

            for (const record of offlineForms) {
                const dairyNumber = record.dairyNumber;
                const pdfBlob = record.pdfBlob;

                uploadPDF(dairyNumber, pdfBlob);

                // Remove the record from IndexedDB after uploading
                db.forms.delete(record.id);
            }

            console.log('All offline data has been synced with Firebase.');
        }

        function createChecklistItems() {
            const checklistItems = [
                // ... [Same as before] ...
            ];

            const itemsToAutoFill = [
                "Inlet Valve",
                "Non-Return Valve",
                "Spray Ball",
                "Agitator",
                "Silo Door",
                "Manhole Seal",
                "Vat Outlet",
                "Walls in Silo"
            ];

            const checklistContainer = document.getElementById('checklist-items');
            checklistContainer.innerHTML = '';

            checklistItems.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('checklist-item');

                const label = document.createElement('label');
                label.textContent = item;
                itemContainer.appendChild(label);

                const statusSelect = document.createElement('select');
                statusSelect.classList.add('form-select');
                statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
                itemContainer.appendChild(statusSelect);

                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.classList.add('form-control');
                commentsInput.placeholder = 'Comments';
                itemContainer.appendChild(commentsInput);

                const imageUpload = document.createElement('input');
                imageUpload.type = 'file';
                imageUpload.classList.add('form-control', 'image-upload');
                imageUpload.style.display = 'none';
                itemContainer.appendChild(imageUpload);

                statusSelect.addEventListener('change', () => {
                    if (statusSelect.value === 'attention-required') {
                        imageUpload.style.display = 'block';
                    } else {
                        imageUpload.style.display = 'none';
                    }

                    if (statusSelect.value === 'not-checked' && itemsToAutoFill.includes(item)) {
                        commentsInput.value = "Milk in Vat";
                    } else if (commentsInput.value === "Milk in Vat") {
                        commentsInput.value = ""; // Clear the field if it was auto-filled
                    }
                });

                checklistContainer.appendChild(itemContainer);
            });
        }

        // ... [Rest of your JavaScript code] ...
    </script>
</body>

</html>
