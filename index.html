<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta tags and CSS links -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Shed Hygiene Checklist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <!-- Your existing styles here -->
    <style>
        /* [Your existing styles here] */
        body {
            background-color: #002B5C;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }

        .container {
            background-color: #002B5C;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
        }

        h1,
        h2 {
            color: #a7ab01;
            text-align: center;
        }

        h1 {
            margin-bottom: 40px;
        }

        label {
            margin-top: 10px;
        }

        button {
            background-color: #FF851B;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            border-radius: 5px;
        }

        button:hover {
            background-color: #FF4136;
        }

        .checklist-item {
            margin-bottom: 30px;
        }

        .form-control,
        .form-select {
            margin-top: 5px;
        }

        .version {
            text-align: center;
            margin-top: 20px;
            color: #FFFFFF;
            font-size: 12px;
        }

        .logo {
            display: block;
            margin: 0 auto 20px;
            width: 250px;
        }

        .record-container {
            background-color: #FFFFFF;
            color: #000000;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            max-width: 1000px;
            width: 100%;
            margin: 20px auto;
        }

        .record-container h2 {
            color: #002B5C;
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-list a {
            text-decoration: none;
            color: #007bff;
            display: block;
            margin-bottom: 10px;
        }

        .back-button {
            margin-top: 20px;
            background-color: #002B5C;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .search-container {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container" id="form-container">
        <img src="https://i.postimg.cc/htZPjx5g/logo-89.png" alt="Logo" class="logo">
        <h1>Dairy Shed Hygiene Checklist</h1>

        <form id="hygiene-checklist-form">
            <!-- Form Fields -->
            <!-- Farm Details Section -->
            <div class="section mb-4">
                <h2>Farm Details</h2>
                <label for="dairy-number">Dairy Number:</label>
                <input type="text" 
                       class="form-control" 
                       id="dairy-number" 
                       name="dairy-number" 
                       onblur="fetchFarmDetails()"
                       autocapitalize="words" 
                       autocorrect="off" 
                       spellcheck="false">

                <label for="dairy-company">Dairy Company:</label>
                <select id="dairy-company" name="dairy-company" class="form-select">
                    <option value="fonterra">Fonterra</option>
                    <option value="dairy-goat-coop">Dairy Goat Co-op</option>
                    <option value="green-valley">Green Valley Dairies</option>
                    <option value="maui-milk">Maui Milk</option>
                    <option value="oceania">Oceania</option>
                    <option value="ofi">OFI</option>
                    <option value="synlait">Synlait Milk LTD</option>
                    <option value="tatua">Tatua</option>
                </select>
                <label for="address">Address:</label>
                <input type="text" 
                       class="form-control" 
                       id="address" 
                       name="address"
                       autocapitalize="words" 
                       autocorrect="off" 
                       spellcheck="false">
                <label for="customer-name">Customer Name:</label>
                <input type="text" 
                       class="form-control" 
                       id="customer-name" 
                       name="customer-name"
                       autocapitalize="words" 
                       autocorrect="off" 
                       spellcheck="false">
                <label for="region">Region:</label>
                <select id="region" name="region" class="form-select">
                    <option value="northland">Northland</option>
                    <option value="auckland">Auckland</option>
                    <option value="waikato">Waikato</option>
                    <option value="bay-of-plenty">Bay of Plenty</option>
                    <option value="gisborne">Gisborne</option>
                    <option value="hawkes-bay">Hawke's Bay</option>
                    <option value="taranaki">Taranaki</option>
                    <option value="manawatu-wanganui">Manawatu-Wanganui</option>
                    <option value="wellington">Wellington</option>
                    <option value="nelson">Nelson</option>
                    <option value="marlborough">Marlborough</option>
                    <option value="west-coast">West Coast</option>
                    <option value="canterbury">Canterbury</option>
                    <option value="otago">Otago</option>
                    <option value="southland">Southland</option>
                </select>
                <label for="farm-name">Farm Name:</label>
                <input type="text" 
                       class="form-control" 
                       id="farm-name" 
                       name="farm-name"
                       autocapitalize="words" 
                       autocorrect="off" 
                       spellcheck="false">
                <label for="island">Island:</label>
                <select id="island" name="island" class="form-select">
                    <option value="north-island">North Island</option>
                    <option value="south-island">South Island</option>
                </select>
                <label for="visit-date">Visit Date:</label>
                <input type="date" 
                       class="form-control" 
                       id="visit-date" 
                       name="visit-date">

                <label for="visit-type">Visit Type:</label>
                <input type="text" 
                       class="form-control" 
                       id="visit-type" 
                       name="visit-type" 
                       value="Milking Plant & Milk Vat Check" 
                       readonly
                       autocapitalize="words" 
                       autocorrect="off" 
                       spellcheck="false">

                <label for="inspection-start-time">Inspection Start Time:</label>
                <input type="time" 
                       class="form-control" 
                       id="inspection-start-time" 
                       name="inspection-start-time">

                <label for="inspection-end-time">Inspection End Time:</label>
                <input type="time" 
                       class="form-control" 
                       id="inspection-end-time" 
                       name="inspection-end-time">

                <label for="inspection-completed-by">Inspection Completed By:</label>
                <input type="text" 
                       class="form-control" 
                       id="inspection-completed-by" 
                       name="inspection-completed-by"
                       autocapitalize="words" 
                       autocorrect="off" 
                       spellcheck="false">

                <label for="call-type">Call Type:</label>
                <select id="call-type" name="call-type" class="form-select">
                    <option value="alert">Alert</option>
                    <option value="grade-call">Grade Call</option>
                    <option value="regular-scheduled-visit" selected>Regular Scheduled Visit</option>
                </select>
            </div>

            <!-- NEW Health & Safety Section (above the main checklist items) -->
            <div class="section mb-4">
                <h2>Health & Safety</h2>
                <div id="health-safety-top"></div>
            </div>

            <!-- Checklist Items Section -->
            <div class="section mb-4">
                <h2>Checklist Items</h2>
                <div id="checklist-items">
                    <!-- Main Checklist items will be dynamically added here -->
                </div>
            </div>

            <!-- Another Health & Safety Section (repeated at end as requested) -->
            <div class="section mb-4">
                <h2>Health & Safety (End)</h2>
                <div id="health-safety-bottom"></div>
            </div>

            <!-- Additional Checks: Teat Spray Check & Chemical Check -->
            <div class="section mb-4">
                <h2>Additional Checks</h2>
                <div id="additional-checks"></div>
            </div>

            <!-- Temperature Measurements Section -->
            <div class="section mb-4">
                <h2>Temperature Measurements</h2>
                <div class="checklist-item">
                    <label for="hot-water-temp">Hot Water Temp (°C):</label>
                    <input type="text" 
                           class="form-control" 
                           id="hot-water-temp" 
                           name="hot-water-temp" 
                           step="0.1"
                           autocapitalize="words" 
                           autocorrect="off" 
                           spellcheck="false">
                    <label for="hot-water-time">Time Taken:</label>
                    <input type="time" class="form-control" id="hot-water-time" name="hot-water-time">
                </div>
                <div class="checklist-item">
                    <label for="milk-temp">Milk Temp (°C):</label>
                    <input type="text" 
                           class="form-control" 
                           id="milk-temp" 
                           name="milk-temp" 
                           step="0.1"
                           autocapitalize="words" 
                           autocorrect="off" 
                           spellcheck="false">
                    <label for="milk-time">Time Taken:</label>
                    <input type="time" class="form-control" id="milk-time" name="milk-time">
                </div>
            </div>

            <button type="button" onclick="generatePDF()">Generate PDF</button>
            <button type="button" onclick="viewRecords()">View All Records</button>
        </form>
        <div class="version">Version 5.4</div>
    </div>

    <!-- Records Viewing Page -->
    <div id="record-container" class="record-container" style="display: none;">
        <h2>All Dairy Shed Hygiene Records</h2>
        <div class="search-container">
            <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number" oninput="filterRecords()">
        </div>
        <div id="record-list" class="record-list"></div>
        <button class="back-button" onclick="goBack()">Back to Checklist</button>
    </div>

    <!-- Include scripts at the end of the body for better performance -->
    <!-- Include Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- Include external libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- Your main script -->
    <script>
        // Ensure that jsPDF is properly initialized
        const { jsPDF } = window.jspdf;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
            authDomain: "dairy-farm-record-system.firebaseapp.com",
            projectId: "dairy-farm-record-system",
            storageBucket: "dairy-farm-record-system.appspot.com",
            messagingSenderId: "422124188212",
            appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const firestore = firebase.firestore();

        // Initialize IndexedDB using Dexie
        const db = new Dexie("OfflineData");
        db.version(2).stores({
            forms: "++id, dairyNumber, formData, pdfBlob",
            formFields: "id, data",
            // Optionally store custom fields such as dilution rates
            teatSprayRatios: "++id, ratio"
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(err => {
                    console.error('Service Worker registration failed:', err);
                });
        }

        // Function definitions

        async function fetchFarmDetails() {
            // Fetch farm details from Firebase Storage
            const dairyNumber = document.getElementById('dairy-number').value;
            if (dairyNumber) {
                const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
                try {
                    const url = await storageRef.getDownloadURL();
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('Failed to fetch the farm details');
                    }
                    const data = await response.json();
                    if (data) {
                        document.getElementById('dairy-company').value = data.dairyCompany || '';
                        document.getElementById('address').value = data.address || '';
                        document.getElementById('customer-name').value = data.customerName || '';
                        document.getElementById('region').value = data.region || '';
                        document.getElementById('farm-name').value = data.farmName || '';
                        document.getElementById('island').value = data.island || '';
                    }
                } catch (error) {
                    console.error('Error fetching farm details:', error);
                }
            }
        }

        async function saveFarmDetails(formData) {
            // Save farm details to Firebase Storage
            const dairyNumber = formData.get('dairy-number');
            const farmDetails = {
                dairyCompany: formData.get('dairy-company'),
                address: formData.get('address'),
                customerName: formData.get('customer-name'),
                region: formData.get('region'),
                farmName: formData.get('farm-name'),
                island: formData.get('island'),
            };
            const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
            const metadata = {
                contentType: 'application/json',
            };
            try {
                await storageRef.put(new Blob([JSON.stringify(farmDetails)], { type: 'application/json' }), metadata);
                console.log('Farm details saved successfully.');
            } catch (error) {
                console.error('Error saving farm details:', error);
            }
        }

        async function generatePDF() {
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const dairyNumber = formData.get('dairy-number');

            await saveFarmDetails(formData); // Save farm details if not found

            const pdf = new jsPDF('p', 'pt', 'a4');

            // Add logo centered
            const logoStorageRef = storage.ref('Picture3.jpg');
            try {
                const logoUrl = await logoStorageRef.getDownloadURL();
                const logo = await fetch(logoUrl).then((res) => res.blob());
                const reader = new FileReader();
                reader.readAsDataURL(logo);
                reader.onload = function () {
                    const imgData = reader.result;
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgWidth = pageWidth - 80; // Leave some margins
                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                    const x = (pageWidth - imgWidth) / 2; // Center the image
                    pdf.addImage(imgData, 'JPEG', x, 40, imgWidth, imgHeight);

                    pdf.setFontSize(12);
                    pdf.setTextColor('#000000');
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Farm Details:', 40, imgHeight + 60);

                    let currentY = imgHeight + 80;

                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Dairy Company: ${formData.get('dairy-company')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Dairy Number: ${formData.get('dairy-number')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Address: ${formData.get('address')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Customer Name: ${formData.get('customer-name')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Region: ${formData.get('region')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Farm Name: ${formData.get('farm-name')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Island: ${formData.get('island')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Visit Date: ${formData.get('visit-date')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Visit Type: ${formData.get('visit-type')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection Start Time: ${formData.get('inspection-start-time')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection End Time: ${formData.get('inspection-end-time')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection Completed By: ${formData.get('inspection-completed-by')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Call Type: ${formData.get('call-type')}`, 40, currentY);
                    currentY += 30;

                    // Collect dynamic items (both Health & Safety + main items + additional checks)
                    // We gather them from the container that holds them
                    const containersToCheck = [
                        document.getElementById('health-safety-top').children,
                        document.getElementById('checklist-items').children,
                        document.getElementById('health-safety-bottom').children,
                        document.getElementById('additional-checks').children
                    ];

                    const checklistTable = [];
                    const photos = [];

                    let pendingImages = 0;

                    // Helper function to process each item container
                    function processItemContainer(item) {
                        // The first label is the item name:
                        const itemName = item.querySelector('label').textContent;
                        const statusSelect = item.querySelector('select');
                        if (!statusSelect) return; // Skip if no select found

                        const status = statusSelect.value;
                        // Comments may or may not exist (for Teat Spray, we might have more fields)
                        // So let's find all text inputs that are not type="file"
                        let commentsField = item.querySelector('input[type="text"]');
                        let comments = commentsField ? commentsField.value : '';

                        if (status === 'attention-required') {
                            // Check if there's an image or not
                            const imageUploads = item.querySelectorAll('input[type="file"]');
                            if (imageUploads[0].files[0] || imageUploads[1].files[0]) {
                                comments += " (See attached photo below)";
                            }
                        }

                        // For Teat Spray Check, we also have a dilution rate
                        const dilutionRateSelect = item.querySelector('.teat-dilution-select');
                        const dilutionRateInput = item.querySelector('.teat-dilution-input');
                        if (dilutionRateSelect && dilutionRateInput) {
                            let ratioText = `Ratio: ${dilutionRateSelect.value}`;
                            if (dilutionRateInput.value) {
                                ratioText += ` (New ratio: ${dilutionRateInput.value})`;
                            }
                            // Append ratio info to the comments for PDF
                            comments += comments ? ` | ${ratioText}` : ratioText;
                        }

                        checklistTable.push([itemName, status, comments]);

                        // If attention-required and images exist, handle them
                        if (status === 'attention-required') {
                            const imageUploads = item.querySelectorAll('input[type="file"]');
                            const imageFile1 = imageUploads[0] ? imageUploads[0].files[0] : null;
                            const imageFile2 = imageUploads[1] ? imageUploads[1].files[0] : null;

                            if (imageFile1 || imageFile2) {
                                const photoItem = {
                                    itemName: itemName,
                                    images: []
                                };

                                if (imageFile1) {
                                    pendingImages++;
                                    const imgReader1 = new FileReader();
                                    imgReader1.onload = function (event) {
                                        photoItem.images[0] = event.target.result;
                                        pendingImages--;
                                        if (pendingImages === 0) {
                                            finalizePDF();
                                        }
                                    };
                                    imgReader1.readAsDataURL(imageFile1);
                                }

                                if (imageFile2) {
                                    pendingImages++;
                                    const imgReader2 = new FileReader();
                                    imgReader2.onload = function (event) {
                                        photoItem.images[1] = event.target.result;
                                        pendingImages--;
                                        if (pendingImages === 0) {
                                            finalizePDF();
                                        }
                                    };
                                    imgReader2.readAsDataURL(imageFile2);
                                }
                                photos.push(photoItem);
                            }
                        }
                    }

                    // Process each container
                    containersToCheck.forEach(container => {
                        for (let item of container) {
                            processItemContainer(item);
                        }
                    });

                    // If no images are pending, finalize right away
                    if (pendingImages === 0) {
                        finalizePDF();
                    }

                    function finalizePDF() {
                        // Generate checklist items table
                        pdf.autoTable({
                            startY: currentY,
                            head: [['Item', 'Status', 'Comments']],
                            body: checklistTable,
                            styles: {
                                fontSize: 10,
                                cellPadding: 5,
                            },
                            headStyles: {
                                fillColor: '#002B5C',
                                textColor: '#FFFFFF'
                            }
                        });

                        // Add temperature data
                        let tempY = pdf.lastAutoTable.finalY + 20;

                        pdf.setFont('helvetica', 'bold');
                        pdf.text('Temperature Measurements:', 40, tempY);
                        tempY += 20;

                        pdf.setFont('helvetica', 'normal');

                        const hotWaterTemp = document.getElementById('hot-water-temp').value;
                        const hotWaterTime = document.getElementById('hot-water-time').value;

                        pdf.text(`Hot Water Temp: ${hotWaterTemp} °C`, 40, tempY);
                        tempY += 15;
                        pdf.text(`Time Taken: ${hotWaterTime}`, 40, tempY);
                        tempY += 20;

                        const milkTemp = document.getElementById('milk-temp').value;
                        const milkTime = document.getElementById('milk-time').value;

                        pdf.text(`Milk Temp: ${milkTemp} °C`, 40, tempY);
                        tempY += 15;
                        pdf.text(`Time Taken: ${milkTime}`, 40, tempY);
                        tempY += 20;

                        // Add photos after the checklist
                        let photoY = tempY + 20; // Start placing photos after the temperature data
                        const pageWidth = pdf.internal.pageSize.getWidth();

                        photos.forEach(photoItem => {
                            const images = photoItem.images;
                            pdf.setFontSize(12);
                            pdf.text(photoItem.itemName, 40, photoY - 10); // Add the title above the photo

                            if (images.length === 1) {
                                if (photoY > pdf.internal.pageSize.getHeight() - 220) {
                                    pdf.addPage();
                                    photoY = 60;
                                }
                                pdf.addImage(images[0], 'JPEG', 40, photoY, 250, 200);
                                photoY += 220;
                            } else if (images.length === 2) {
                                if (photoY > pdf.internal.pageSize.getHeight() - 220) {
                                    pdf.addPage();
                                    photoY = 60;
                                }
                                const imageWidth = (pageWidth - 120) / 2; // Adjust margins
                                pdf.addImage(images[0], 'JPEG', 40, photoY, imageWidth, 200);
                                pdf.addImage(images[1], 'JPEG', 60 + imageWidth, photoY, imageWidth, 200);
                                photoY += 220;
                            }
                        });

                        // Save PDF and upload to Firebase
                        const pdfBlob = pdf.output('blob');

                        if (navigator.onLine) {
                            uploadPDF(dairyNumber, pdfBlob);
                        } else {
                            // Save data to IndexedDB
                            db.forms.add({
                                dairyNumber: dairyNumber,
                                formData: Object.fromEntries(formData.entries()),
                                pdfBlob: pdfBlob
                            }).then(() => {
                                console.log('Data saved locally. Will sync when back online.');
                            }).catch((error) => {
                                console.error('Error saving data locally:', error);
                            });
                        }

                        pdf.save('Dairy_Shed_Hygiene_Checklist.pdf');
                    }
                };
            } catch (error) {
                console.error('Error fetching logo:', error);
            }
        }

        function uploadPDF(dairyNumber, pdfBlob) {
            // Upload PDF to Firebase Storage
            const timestamp = new Date().toISOString().split('T')[0];
            const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
            const storageRef = storage.ref(`customers/${dairyNumber}/${fileName}`);

            storageRef.put(pdfBlob).then(() => {
                console.log('PDF uploaded successfully');
            }).catch((error) => {
                console.error('Error uploading PDF:', error);
            });
        }

        window.addEventListener('online', syncDataWithFirebase);

        async function syncDataWithFirebase() {
            // Sync offline data with Firebase when back online
            const offlineForms = await db.forms.toArray();

            for (const record of offlineForms) {
                const dairyNumber = record.dairyNumber;
                const pdfBlob = record.pdfBlob;

                uploadPDF(dairyNumber, pdfBlob);

                // Remove the record from IndexedDB after uploading
                db.forms.delete(record.id);
            }

            console.log('All offline data has been synced with Firebase.');
        }

        // ============ CREATE HEALTH & SAFETY ITEMS (top + bottom) ============
        function createHealthSafetyItems(containerId) {
            // We'll just create a single "Health & Safety" item for demonstration
            // (If you want more, put them in an array).
            const itemContainer = document.createElement('div');
            itemContainer.classList.add('checklist-item');

            const label = document.createElement('label');
            label.textContent = "Health & Safety";
            itemContainer.appendChild(label);

            const statusSelect = document.createElement('select');
            statusSelect.classList.add('form-select');
            statusSelect.name = `status-health-safety-${containerId}`;
            statusSelect.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
            itemContainer.appendChild(statusSelect);

            const commentsInput = document.createElement('input');
            commentsInput.type = 'text';
            commentsInput.classList.add('form-control');
            commentsInput.name = `comments-health-safety-${containerId}`;
            commentsInput.placeholder = 'Comments';
            // auto-cap / off
            commentsInput.setAttribute('autocapitalize','words');
            commentsInput.setAttribute('autocorrect','off');
            commentsInput.setAttribute('spellcheck','false');
            itemContainer.appendChild(commentsInput);

            // Create first image upload input
            const imageUpload1 = document.createElement('input');
            imageUpload1.type = 'file';
            imageUpload1.classList.add('form-control', 'image-upload');
            imageUpload1.style.display = 'none';
            itemContainer.appendChild(imageUpload1);

            // Create second image upload input
            const imageUpload2 = document.createElement('input');
            imageUpload2.type = 'file';
            imageUpload2.classList.add('form-control', 'image-upload');
            imageUpload2.style.display = 'none';
            itemContainer.appendChild(imageUpload2);

            statusSelect.addEventListener('change', () => {
                if (statusSelect.value === 'attention-required') {
                    imageUpload1.style.display = 'block';
                    imageUpload2.style.display = 'block';
                } else {
                    imageUpload1.style.display = 'none';
                    imageUpload2.style.display = 'none';
                }
            });

            document.getElementById(containerId).appendChild(itemContainer);
        }

        // ============ CREATE MAIN CHECKLIST ITEMS ============
        function createChecklistItems() {
            const checklistItems = [
                "Pulsator Airline", "Long Bend Elbows", "Automatic Cup and Remover", "Diaphragm", "Receiving Can",
                "Sanitary Trap", "Main Milk Line", "Milk Line Seals in Good Condition", "Stainless Droppers", "Long Milk Rubber",
                "Liner", "Cluster", "Cluster Seal", "Cluster Button", "Non Return Valve at Milk Pump", "Milk Pump",
                "Filter Housing", "Plate Cooler", "Interceptor", "Receiver Airline", "Flushing Pulsator", "Air Purge Valve",
                "Vacuum Level", "Main Airline", "Plant Drainage - Milk Pump", "Plant Drainage - Filter/s", "Plant Drainage - Plate Cooler",
                "Plant Drainage - Vat Entry", "Plant Wash Tap", "Wash Jetters", "Centre Gland", "Test Bucket",
                "Inlet Valve", "Non-Return Valve", "Spray Ball", "Agitator", "Silo Door", "Manhole Seal", "Vat Outlet", "Walls in Silo"
            ];

            const itemsToAutoFill = [
                "Inlet Valve",
                "Non-Return Valve",
                "Spray Ball",
                "Agitator",
                "Silo Door",
                "Manhole Seal",
                "Vat Outlet",
                "Walls in Silo"
            ];

            const checklistContainer = document.getElementById('checklist-items');
            checklistContainer.innerHTML = '';

            checklistItems.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('checklist-item');

                const label = document.createElement('label');
                label.textContent = item;
                itemContainer.appendChild(label);

                const statusSelect = document.createElement('select');
                statusSelect.classList.add('form-select');
                statusSelect.name = `status-${item}`;
                statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
                itemContainer.appendChild(statusSelect);

                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.classList.add('form-control');
                commentsInput.name = `comments-${item}`;
                commentsInput.placeholder = 'Comments';
                // auto-cap / off
                commentsInput.setAttribute('autocapitalize','words');
                commentsInput.setAttribute('autocorrect','off');
                commentsInput.setAttribute('spellcheck','false');
                itemContainer.appendChild(commentsInput);

                // Create first image upload input
                const imageUpload1 = document.createElement('input');
                imageUpload1.type = 'file';
                imageUpload1.classList.add('form-control', 'image-upload');
                imageUpload1.style.display = 'none';
                itemContainer.appendChild(imageUpload1);

                // Create second image upload input
                const imageUpload2 = document.createElement('input');
                imageUpload2.type = 'file';
                imageUpload2.classList.add('form-control', 'image-upload');
                imageUpload2.style.display = 'none';
                itemContainer.appendChild(imageUpload2);

                statusSelect.addEventListener('change', () => {
                    if (statusSelect.value === 'attention-required') {
                        imageUpload1.style.display = 'block';
                        imageUpload2.style.display = 'block';
                    } else {
                        imageUpload1.style.display = 'none';
                        imageUpload2.style.display = 'none';
                    }

                    if (statusSelect.value === 'not-checked' && itemsToAutoFill.includes(item)) {
                        commentsInput.value = "Milk in Vat";
                    } else if (commentsInput.value === "Milk in Vat") {
                        commentsInput.value = ""; // Clear the field if it was auto-filled
                    }
                });

                checklistContainer.appendChild(itemContainer);
            });
        }

        // ============ CREATE ADDITIONAL CHECKS (Teat Spray & Chemical) ============
        async function createAdditionalChecks() {
            const additionalContainer = document.getElementById('additional-checks');
            additionalContainer.innerHTML = '';

            // -- Teat Spray Check --
            const teatSprayContainer = document.createElement('div');
            teatSprayContainer.classList.add('checklist-item');

            const labelTeat = document.createElement('label');
            labelTeat.textContent = "Teat Spray Check";
            teatSprayContainer.appendChild(labelTeat);

            const statusSelectTeat = document.createElement('select');
            statusSelectTeat.classList.add('form-select');
            statusSelectTeat.name = "status-teat-spray-check";
            statusSelectTeat.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
            teatSprayContainer.appendChild(statusSelectTeat);

            // Teat spray - Comments
            const commentsInputTeat = document.createElement('input');
            commentsInputTeat.type = 'text';
            commentsInputTeat.classList.add('form-control');
            commentsInputTeat.name = "comments-teat-spray-check";
            commentsInputTeat.placeholder = 'Comments';
            // auto-cap / off
            commentsInputTeat.setAttribute('autocapitalize','words');
            commentsInputTeat.setAttribute('autocorrect','off');
            commentsInputTeat.setAttribute('spellcheck','false');
            teatSprayContainer.appendChild(commentsInputTeat);

            // Image uploads
            const imageUploadTeat1 = document.createElement('input');
            imageUploadTeat1.type = 'file';
            imageUploadTeat1.classList.add('form-control', 'image-upload');
            imageUploadTeat1.style.display = 'none';
            teatSprayContainer.appendChild(imageUploadTeat1);

            const imageUploadTeat2 = document.createElement('input');
            imageUploadTeat2.type = 'file';
            imageUploadTeat2.classList.add('form-control', 'image-upload');
            imageUploadTeat2.style.display = 'none';
            teatSprayContainer.appendChild(imageUploadTeat2);

            statusSelectTeat.addEventListener('change', () => {
                if (statusSelectTeat.value === 'attention-required') {
                    imageUploadTeat1.style.display = 'block';
                    imageUploadTeat2.style.display = 'block';
                } else {
                    imageUploadTeat1.style.display = 'none';
                    imageUploadTeat2.style.display = 'none';
                }
            });

            // Teat spray - Dilution rate
            const ratioContainer = document.createElement('div');
            ratioContainer.classList.add('mt-2');

            // The dropdown for previously used ratios
            const ratioSelect = document.createElement('select');
            ratioSelect.classList.add('form-select', 'teat-dilution-select');
            ratioSelect.innerHTML = `<option value="1:4">1:4</option>`;
            // Load existing ratios from IndexedDB
            const existingRatios = await db.teatSprayRatios.toArray();
            existingRatios.forEach(r => {
                if (r.ratio !== '1:4') {
                    const opt = document.createElement('option');
                    opt.value = r.ratio;
                    opt.textContent = r.ratio;
                    ratioSelect.appendChild(opt);
                }
            });
            ratioContainer.appendChild(ratioSelect);

            // The text input to add a new ratio
            const ratioInput = document.createElement('input');
            ratioInput.type = 'text';
            ratioInput.placeholder = 'Enter new ratio e.g. 1:5';
            ratioInput.classList.add('form-control', 'mt-2', 'teat-dilution-input');
            // auto-cap / off (not strictly needed for ratio, but we’ll do it for consistency)
            ratioInput.setAttribute('autocapitalize','words');
            ratioInput.setAttribute('autocorrect','off');
            ratioInput.setAttribute('spellcheck','false');

            ratioInput.addEventListener('blur', async () => {
                const newRatio = ratioInput.value.trim();
                if (newRatio && !Array.from(ratioSelect.options).some(opt => opt.value === newRatio)) {
                    // Save to IndexedDB
                    await db.teatSprayRatios.add({ ratio: newRatio });
                    // Then add to select
                    const newOpt = document.createElement('option');
                    newOpt.value = newRatio;
                    newOpt.textContent = newRatio;
                    ratioSelect.appendChild(newOpt);
                    ratioSelect.value = newRatio;
                }
            });

            ratioContainer.appendChild(ratioInput);

            teatSprayContainer.appendChild(ratioContainer);

            additionalContainer.appendChild(teatSprayContainer);

            // -- Chemical Check --
            const chemicalContainer = document.createElement('div');
            chemicalContainer.classList.add('checklist-item');

            const labelChemical = document.createElement('label');
            labelChemical.textContent = "Chemical Check";
            chemicalContainer.appendChild(labelChemical);

            const statusSelectChemical = document.createElement('select');
            statusSelectChemical.classList.add('form-select');
            statusSelectChemical.name = "status-chemical-check";
            statusSelectChemical.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
            chemicalContainer.appendChild(statusSelectChemical);

            const commentsInputChemical = document.createElement('input');
            commentsInputChemical.type = 'text';
            commentsInputChemical.classList.add('form-control');
            commentsInputChemical.name = "comments-chemical-check";
            commentsInputChemical.placeholder = 'Comments';
            // auto-cap / off
            commentsInputChemical.setAttribute('autocapitalize','words');
            commentsInputChemical.setAttribute('autocorrect','off');
            commentsInputChemical.setAttribute('spellcheck','false');
            chemicalContainer.appendChild(commentsInputChemical);

            // Dual image (if needed)
            const imageUploadChem1 = document.createElement('input');
            imageUploadChem1.type = 'file';
            imageUploadChem1.classList.add('form-control', 'image-upload');
            imageUploadChem1.style.display = 'none';
            chemicalContainer.appendChild(imageUploadChem1);

            const imageUploadChem2 = document.createElement('input');
            imageUploadChem2.type = 'file';
            imageUploadChem2.classList.add('form-control', 'image-upload');
            imageUploadChem2.style.display = 'none';
            chemicalContainer.appendChild(imageUploadChem2);

            statusSelectChemical.addEventListener('change', () => {
                if (statusSelectChemical.value === 'attention-required') {
                    imageUploadChem1.style.display = 'block';
                    imageUploadChem2.style.display = 'block';
                } else {
                    imageUploadChem1.style.display = 'none';
                    imageUploadChem2.style.display = 'none';
                }
            });

            additionalContainer.appendChild(chemicalContainer);
        }

        // View Records Functions

        function viewRecords() {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('record-container').style.display = 'block';
            loadAllRecords();
        }

        async function loadAllRecords() {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const storageRef = storage.ref('customers');

            try {
                const folderSnapshot = await storageRef.listAll();
                folderSnapshot.prefixes.forEach(folderRef => {
                    const dairyNumber = folderRef.name;
                    const folderLink = document.createElement('a');
                    folderLink.textContent = dairyNumber;
                    folderLink.href = '#';
                    folderLink.addEventListener('click', () => {
                        loadRecordFiles(dairyNumber);
                    });
                    recordList.appendChild(folderLink);
                });
            } catch (error) {
                console.error('Error fetching records:', error);
            }
        }

        async function loadRecordFiles(dairyNumber) {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const storageRef = storage.ref(`customers/${dairyNumber}`);

            try {
                const fileSnapshot = await storageRef.listAll();
                fileSnapshot.items.forEach(fileRef => {
                    const fileName = fileRef.name;
                    const dateOnly = fileName.match(/(\d{4}-\d{2}-\d{2})/);
                    const displayName = dateOnly ? dateOnly[0] : fileName;

                    const fileLink = document.createElement('a');
                    fileLink.textContent = displayName;
                    fileLink.href = '#';
                    fileLink.addEventListener('click', async () => {
                        try {
                            const url = await fileRef.getDownloadURL();
                            window.open(url, '_blank');
                        } catch (error) {
                            console.error('Error fetching file:', error);
                        }
                    });
                    recordList.appendChild(fileLink);
                });

                const backButton = document.createElement('button');
                backButton.textContent = 'Back to Records';
                backButton.className = 'back-button';
                backButton.addEventListener('click', goBackToRecords);
                recordList.appendChild(backButton);
            } catch (error) {
                console.error('Error fetching record files:', error);
            }
        }

        function goBack() {
            document.getElementById('form-container').style.display = 'block';
            document.getElementById('record-container').style.display = 'none';
        }

        function goBackToRecords() {
            loadAllRecords();
        }

        function filterRecords() {
            const searchInput = document.getElementById('search-dairy-number').value.toLowerCase();
            const recordList = document.getElementById('record-list');
            const records = recordList.getElementsByTagName('a');

            for (let i = 0; i < records.length; i++) {
                const record = records[i];
                const textValue = record.textContent || record.innerText;
                if (textValue.toLowerCase().indexOf(searchInput) > -1) {
                    record.style.display = "";
                } else {
                    record.style.display = "none";
                }
            }
        }

        // Save form data locally
        function saveFormData() {
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Save data from dynamic checklist items
            const checklistItemsData = [];

            // Containers
            const containersToCheck = [
                document.getElementById('health-safety-top').children,
                document.getElementById('checklist-items').children,
                document.getElementById('health-safety-bottom').children,
                document.getElementById('additional-checks').children
            ];

            for (let container of containersToCheck) {
                for (let item of container) {
                    const label = item.querySelector('label');
                    if (!label) continue;
                    const itemName = label.textContent;
                    const statusSelect = item.querySelector('select');
                    let status = '';
                    let comments = '';

                    if (statusSelect) {
                        status = statusSelect.value;
                    }
                    const commentsInput = item.querySelector('input[type="text"]');
                    if (commentsInput) {
                        comments = commentsInput.value;
                    }

                    checklistItemsData.push({
                        itemName: itemName,
                        status: status,
                        comments: comments
                    });
                }
            }

            data.checklistItems = checklistItemsData;

            // Save data to IndexedDB
            db.formFields.put({ id: 'formData', data: data });
        }

        // Load form data from local storage
        function loadFormData() {
            db.formFields.get('formData').then(record => {
                if (record && record.data) {
                    const data = record.data;
                    const form = document.getElementById('hygiene-checklist-form');

                    for (let key in data) {
                        if (key !== 'checklistItems') {
                            const field = form.elements[key];
                            if (field) {
                                field.value = data[key];
                            }
                        }
                    }

                    // Load the checklist items data
                    if (data.checklistItems) {
                        const containersToCheck = [
                            document.getElementById('health-safety-top').children,
                            document.getElementById('checklist-items').children,
                            document.getElementById('health-safety-bottom').children,
                            document.getElementById('additional-checks').children
                        ];

                        let i = 0;
                        for (let container of containersToCheck) {
                            for (let item of container) {
                                if (!data.checklistItems[i]) break;
                                const itemData = data.checklistItems[i];
                                const statusSelect = item.querySelector('select');
                                const commentsInput = item.querySelector('input[type="text"]');

                                if (statusSelect) {
                                    statusSelect.value = itemData.status;
                                    // Trigger change event to show/hide image uploads if necessary
                                    statusSelect.dispatchEvent(new Event('change'));
                                }

                                if (commentsInput) {
                                    commentsInput.value = itemData.comments;
                                }
                                i++;
                            }
                        }
                    }
                }
            }).catch(error => {
                console.error('Error loading form data:', error);
            });
        }

        document.addEventListener("DOMContentLoaded", async () => {
            // Create the top Health & Safety item
            createHealthSafetyItems('health-safety-top');

            // Create the main checklist items
            createChecklistItems();

            // Create the bottom Health & Safety item
            createHealthSafetyItems('health-safety-bottom');

            // Create additional checks (Teat Spray & Chemical)
            await createAdditionalChecks();

            // Load any saved data
            loadFormData();

            const form = document.getElementById('hygiene-checklist-form');
            form.addEventListener('input', saveFormData);
        });
    </script>
</body>

</html>
