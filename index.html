<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Shed Hygiene Checklist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        body {
            background-color: #002B5C;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }
        .container {
            background-color: #002B5C;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
        }
        h1, h2 {
            color: #a7ab01;
            text-align: center;
        }
        h1 {
            margin-bottom: 40px;
        }
        label {
            margin-top: 10px;
        }
        button {
            background-color: #FF851B;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            border-radius: 5px;
        }
        button:hover {
            background-color: #FF4136;
        }
        .checklist-item {
            margin-bottom: 30px;
        }
        .form-control, .form-select {
            margin-top: 5px;
        }
        .version {
            text-align: center;
            margin-top: 20px;
            color: #FFFFFF;
            font-size: 12px;
        }
        .logo {
            display: block;
            margin: 0 auto 40px;
            width: 250px;
        }
        .record-container {
            background-color: #FFFFFF;
            color: #000000;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            max-width: 1000px;
            width: 100%;
            margin: 20px auto;
        }
        .record-container h2 {
            color: #002B5C;
        }
        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .record-list a {
            text-decoration: none;
            color: #007bff;
            display: block;
            margin-bottom: 10px;
        }
        .back-button {
            margin-top: 20px;
            background-color: #002B5C;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .search-container {
            margin-bottom: 20px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
</head>
<body>
    <div class="container" id="form-container">
        <img src="https://i.postimg.cc/htZPjx5g/logo-89.png" alt="Logo" class="logo">
        <h1>Dairy Shed Hygiene Checklist</h1>
        
        <form id="hygiene-checklist-form">
            <!-- Form Fields -->
            <div class="section mb-4">
                <h2>Farm Details</h2>
                <label for="dairy-number">Dairy Number:</label>
                <input type="text" class="form-control" id="dairy-number" name="dairy-number" onblur="fetchFarmDetails()">
                
                <label for="dairy-company">Dairy Company:</label>
                <select id="dairy-company" name="dairy-company" class="form-select">
                    <option value="fonterra">Fonterra</option>
                    <option value="dairy-goat-coop">Dairy Goat Co-op</option>
                    <option value="green-valley">Green Valley Dairies</option>
                    <option value="maui-milk">Maui Milk</option>
                    <option value="oceania">Oceania</option>
                    <option value="ofi">OFI</option>
                    <option value="synlait">Synlait Milk LTD</option>
                    <option value="tatua">Tatua</option>
                </select>
                <label for="address">Address:</label>
                <input type="text" class="form-control" id="address" name="address">
                <label for="customer-name">Customer Name:</label>
                <input type="text" class="form-control" id="customer-name" name="customer-name">
                <label for="region">Region:</label>
                <select id="region" name="region" class="form-select">
                    <option value="northland">Northland</option>
                    <option value="auckland">Auckland</option>
                    <option value="waikato">Waikato</option>
                    <option value="bay-of-plenty">Bay of Plenty</option>
                    <option value="gisborne">Gisborne</option>
                    <option value="hawkes-bay">Hawke's Bay</option>
                    <option value="taranaki">Taranaki</option>
                    <option value="manawatu-wanganui">Manawatu-Wanganui</option>
                    <option value="wellington">Wellington</option>
                    <option value="nelson">Nelson</option>
                    <option value="marlborough">Marlborough</option>
                    <option value="west-coast">West Coast</option>
                    <option value="canterbury">Canterbury</option>
                    <option value="otago">Otago</option>
                    <option value="southland">Southland</option>
                </select>
                <label for="farm-name">Farm Name:</label>
                <input type="text" class="form-control" id="farm-name" name="farm-name">
                <label for="island">Island:</label>
                <select id="island" name="island" class="form-select">
                    <option value="north-island">North Island</option>
                    <option value="south-island">South Island</option>
                </select>
                <label for="visit-date">Visit Date:</label>
                <input type="date" class="form-control" id="visit-date" name="visit-date">
                <label for="visit-type">Visit Type:</label>
                <input type="text" class="form-control" id="visit-type" name="visit-type" value="Milking Plant & Milk Vat Check" readonly>
                <label for="inspection-start-time">Inspection Start Time:</label>
                <input type="time" class="form-control" id="inspection-start-time" name="inspection-start-time">
                <label for="inspection-end-time">Inspection End Time:</label>
                <input type="time" class="form-control" id="inspection-end-time" name="inspection-end-time">
                <label for="inspection-completed-by">Inspection Completed By:</label>
                <input type="text" class="form-control" id="inspection-completed-by" name="inspection-completed-by">
                <label for="call-type">Call Type:</label>
                <select id="call-type" name="call-type" class="form-select">
                    <option value="alert">Alert</option>
                    <option value="grade-call">Grade Call</option>
                    <option value="regular-scheduled-visit" selected>Regular Scheduled Visit</option>
                </select>
            </div>

            <!-- Checklist Items Section -->
            <div class="section mb-4">
                <h2>Checklist Items</h2>
                <div id="checklist-items">
                    <!-- Checklist items will be dynamically added here -->
                </div>
            </div>

            <!-- Temperature Measurements Section -->
            <div class="section mb-4">
                <h2>Temperature Measurements</h2>
                <div class="checklist-item">
                    <label for="hot-water-temp">Hot Water Temp (째C):</label>
                    <input type="number" class="form-control" id="hot-water-temp" name="hot-water-temp" step="0.1">
                    <label for="hot-water-time">Time Taken:</label>
                    <input type="time" class="form-control" id="hot-water-time" name="hot-water-time">
                </div>
                <div class="checklist-item">
                    <label for="milk-temp">Milk Temp (째C):</label>
                    <input type="number" class="form-control" id="milk-temp" name="milk-temp" step="0.1">
                    <label for="milk-time">Time Taken:</label>
                    <input type="time" class="form-control" id="milk-time" name="milk-time">
                </div>
            </div>

            <button type="button" onclick="generatePDF()">Generate PDF</button>
            <button type="button" onclick="viewRecords()">View All Records</button>
        </form>
        <div class="version">Version 4.4</div>
    </div>

    <!-- Records Viewing Page -->
    <div id="record-container" class="record-container" style="display: none;">
        <h2>All Dairy Shed Hygiene Records</h2>
        <div class="search-container">
            <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number" oninput="filterRecords()">
        </div>
        <div id="record-list" class="record-list"></div>
        <button class="back-button" onclick="goBack()">Back to Checklist</button>
        <button class="back-button" onclick="goBackToRecords()">Back to Dairy Records</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
            authDomain: "dairy-farm-record-system.firebaseapp.com",
            projectId: "dairy-farm-record-system",
            storageBucket: "dairy-farm-record-system.appspot.com",
            messagingSenderId: "422124188212",
            appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();

        document.addEventListener("DOMContentLoaded", () => {
            createChecklistItems();
        });

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const form = document.getElementById('hygiene-checklist-form');
            const dairyNumber = form.querySelector('#dairy-number').value;

            let pdf = new jsPDF('p', 'pt', 'a4');
            pdf.setFontSize(22);
            pdf.setTextColor('#002B5C');

            const logoImage = document.querySelector('.logo').src;
            pdf.addImage(logoImage, 'PNG', 170, 20, 240, 80);

            pdf.setFontSize(12);
            pdf.setTextColor('#000000');
            pdf.setFont('helvetica', 'bold');
            pdf.text('Farm Details:', 40, 150);

            pdf.setFont('helvetica', 'normal');
            pdf.text(`Dairy Company: ${form.querySelector('#dairy-company').value || ''}`, 40, 170);
            pdf.text(`Dairy Number: ${form.querySelector('#dairy-number').value || ''}`, 40, 185);
            pdf.text(`Address: ${form.querySelector('#address').value || ''}`, 40, 200);
            pdf.text(`Customer Name: ${form.querySelector('#customer-name').value || ''}`, 40, 215);
            pdf.text(`Region: ${form.querySelector('#region').value || ''}`, 40, 230);
            pdf.text(`Farm Name: ${form.querySelector('#farm-name').value || ''}`, 40, 245);
            pdf.text(`Island: ${form.querySelector('#island').value || ''}`, 40, 260);
            pdf.text(`Visit Date: ${form.querySelector('#visit-date').value || ''}`, 40, 275);
            pdf.text(`Visit Type: ${form.querySelector('#visit-type').value || ''}`, 40, 290);
            pdf.text(`Inspection Start Time: ${form.querySelector('#inspection-start-time').value || ''}`, 40, 305);
            pdf.text(`Inspection End Time: ${form.querySelector('#inspection-end-time').value || ''}`, 40, 320);
            pdf.text(`Inspection Completed By: ${form.querySelector('#inspection-completed-by').value || ''}`, 40, 335);
            pdf.text(`Call Type: ${form.querySelector('#call-type').value || ''}`, 40, 350);

            // Add checklist items to PDF
            const checklistItems = document.getElementById('checklist-items').children;
            const checklistData = [];
            const images = [];

            for (let item of checklistItems) {
                const itemName = item.querySelector('label').textContent;
                const status = item.querySelector('select').value;
                const comments = item.querySelector('input[type="text"]').value;
                let notes = '';

                if (status === 'attention-required') {
                    notes = 'See attached photo below';
                }

                const imageFile = item.querySelector('input[type="file"]').files[0];
                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        images.push({ image: event.target.result, itemName });
                    };
                    reader.readAsDataURL(imageFile);
                    await new Promise((resolve) => (reader.onloadend = resolve));
                }

                checklistData.push([itemName, status, comments, notes]);
            }

            // Checklist items section
            pdf.autoTable({
                startY: 370,
                head: [['Item', 'Status', 'Comments', 'Notes']],
                body: checklistData,
                theme: 'striped',
                styles: { fontSize: 10, textColor: '#000000' },
                headStyles: { fillColor: '#002B5C', textColor: '#FFFFFF' }
            });

            // Add temperature data
            let currentY = pdf.lastAutoTable.finalY + 20;

            pdf.setFont('helvetica', 'bold');
            pdf.text('Temperature Measurements:', 40, currentY);
            currentY += 20;

            pdf.setFont('helvetica', 'normal');
            pdf.text(`Hot Water Temp: ${form.querySelector('#hot-water-temp').value || ''} 째C`, 40, currentY);
            currentY += 15;
            pdf.text(`Time Taken: ${form.querySelector('#hot-water-time').value || ''}`, 40, currentY);
            currentY += 20;

            pdf.text(`Milk Temp: ${form.querySelector('#milk-temp').value || ''} 째C`, 40, currentY);
            currentY += 15;
            pdf.text(`Time Taken: ${form.querySelector('#milk-time').value || ''}`, 40, currentY);
            currentY += 20;

            // Add photos
            if (images.length > 0) {
                pdf.setFont('helvetica', 'bold');
                pdf.text('Photos:', 40, currentY);
                currentY += 20;

                for (const imgDetail of images) {
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Item: ${imgDetail.itemName}`, 40, currentY);
                    currentY += 10;

                    const pageHeight = pdf.internal.pageSize.height;

                    if (currentY + 160 > pageHeight) {
                        pdf.addPage();
                        currentY = 50; // Reset Y position for new page
                    }

                    pdf.addImage(imgDetail.image, 'JPEG', 40, currentY, 150, 150);
                    currentY += 160; // Spacing for the next image
                }
            }

            // Upload PDF to Firebase
            const pdfBlob = pdf.output('blob');
            const timestamp = new Date().toISOString().split('T')[0];
            const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
            const storageRef = storage.ref(`customers/${dairyNumber}/${fileName}`);

            storageRef.put(pdfBlob).then(() => {
                console.log('PDF uploaded successfully');
            }).catch((error) => {
                console.error('Error uploading PDF:', error);
            });

            pdf.save('Dairy_Shed_Hygiene_Checklist.pdf');
        }

        // View Records
        async function viewRecords() {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('record-container').style.display = 'block';

            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';

            try {
                const listRef = storage.ref('customers');
                const folders = await listRef.listAll();
                folders.prefixes.forEach(folderRef => {
                    const dairyNumber = folderRef.name;
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = dairyNumber;
                    link.onclick = () => loadReports(dairyNumber);
                    recordList.appendChild(link);
                });
            } catch (error) {
                console.error('Error loading records:', error);
            }
        }

        async function loadReports(dairyNumber) {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';

            try {
                const listRef = storage.ref(`customers/${dairyNumber}`);
                const reports = await listRef.listAll();
                reports.items.forEach(itemRef => {
                    const link = document.createElement('a');
                    link.href = '#';
                    const fileName = itemRef.name.split('-form-')[1].replace('.pdf', '');
                    link.textContent = `${fileName}`;
                    link.onclick = () => itemRef.getDownloadURL().then(url => window.open(url));
                    recordList.appendChild(link);
                });
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        function goBack() {
            document.getElementById('record-container').style.display = 'none';
            document.getElementById('form-container').style.display = 'block';
        }

        function goBackToRecords() {
            const recordList = document.getElementById('record-list');
            if (recordList.innerHTML) {
                recordList.innerHTML = '';
            }
            viewRecords();
        }

        // Checklist Items Generation
        function createChecklistItems() {
            const checklistItems = [
                "Pulsator Airline", "Long Bend Elbows", "Automatic Cup and Remover", "Diaphragm", "Receiving Can",
                "Sanitary Trap", "Main Milk Line", "Milk Line Seals in Good Condition", "Stainless Droppers", "Long Milk Rubber",
                "Liner", "Cluster", "Cluster Seal", "Cluster Button", "Non Return Valve at Milk Pump", "Milk Pump",
                "Filter Housing", "Plate Cooler", "Interceptor", "Receiver Airline", "Flushing Pulsator", "Air Purge Valve",
                "Vacuum Level", "Main Airline", "Plant Drainage - Milk Pump", "Plant Drainage - Filter/s", "Plant Drainage - Plate Cooler",
                "Plant Drainage - Vat Entry", "Plant Wash Tap", "Wash Jetters", "Centre Gland", "Test Bucket", "Inlet Valve",
                "Non-Return Valve", "Spray Ball", "Agitator", "Silo Door", "Manhole Seal", "Vat Outlet", "Walls in Silo"
            ];

            const checklistContainer = document.getElementById('checklist-items');
            checklistContainer.innerHTML = '';

            checklistItems.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('checklist-item');

                const label = document.createElement('label');
                label.textContent = item;
                itemContainer.appendChild(label);

                const statusSelect = document.createElement('select');
                statusSelect.classList.add('form-select');
                statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
                itemContainer.appendChild(statusSelect);

                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.classList.add('form-control');
                commentsInput.placeholder = 'Comments';
                itemContainer.appendChild(commentsInput);

                const imageUpload = document.createElement('input');
                imageUpload.type = 'file';
                imageUpload.classList.add('form-control', 'image-upload');
                imageUpload.style.display = 'none';
                itemContainer.appendChild(imageUpload);

                statusSelect.addEventListener('change', () => {
                    if (statusSelect.value === 'attention-required') {
                        imageUpload.style.display = 'block';
                    } else {
                        imageUpload.style.display = 'none';
                    }

                    if (statusSelect.value === 'not-checked') {
                        commentsInput.value = "Milk in Vat";
                    } else {
                        if (commentsInput.value === "Milk in Vat") {
                            commentsInput.value = ""; // Clear the field if it was auto-filled by 'Not Checked'
                        }
                    }
                });

                checklistContainer.appendChild(itemContainer);
            });
        }
    </script>
</body>
</html>
