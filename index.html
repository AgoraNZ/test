<!DOCTYPE html>
<html lang="en">
<head>
  <!-- PART 1: META & STYLES -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dairy Shed Hygiene Checklist</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* ===== MAIN STYLES ===== */
    body {
      background-color: #002B5C;
      color: #FFFFFF;
      font-family: Arial, sans-serif;
      margin: 0;
    }
    #login-container, #app-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #login-container {
      background: rgba(0,0,0,0.8);
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 1000;
    }
    .login-box {
      background: #FFFFFF;
      color: #000;
      padding: 30px;
      border-radius: 8px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .container {
      background-color: #002B5C;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      max-width: 800px;
      width: 100%;
    }
    h1, h2 { color: #a7ab01; text-align: center; }
    label { margin-top: 10px; }
    button {
      background-color: #FF851B;
      color: #FFFFFF;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      display: block;
      margin: 20px auto;
      border-radius: 5px;
    }
    button:hover { background-color: #FF4136; }
    .checklist-item { margin-bottom: 30px; }
    .form-control, .form-select { margin-top: 5px; }
    .version { text-align: center; margin-top: 20px; color: #FFFFFF; font-size: 12px; }
    .logo { display: block; margin: 0 auto 20px; width: 250px; }
    .record-container {
      background-color: #FFFFFF;
      color: #000000;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      max-width: 1000px;
      width: 100%;
      margin: 20px auto;
    }
    .record-container h2 { color: #002B5C; }
    .record-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .record-list a {
      text-decoration: none;
      color: #007bff;
      display: block;
      margin-bottom: 10px;
    }
    .back-button {
      margin-top: 20px;
      background-color: #002B5C;
      color: #FFFFFF;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    #map {
      height: 400px;
      margin: 20px auto;
      width: 100%;
      border-radius: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="login-container">
    <div class="login-box">
      <h2>Sign In</h2>
      <input id="login-email" type="email" class="form-control" placeholder="Email" /><br/>
      <input id="login-password" type="password" class="form-control" placeholder="Password" /><br/>
      <button id="login-button">Login</button>
      <div id="login-error" class="text-danger mt-2"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="app-container" style="display:none; width:100%;">
    <!-- MAIN FORM CONTAINER -->
    <div class="container" id="form-container">
      <img src="https://i.postimg.cc/htZPjx5g/logo-89.png" alt="Logo" class="logo">
      <h1>Dairy Shed Hygiene Checklist</h1>
      <form id="hygiene-checklist-form">
        <!-- SECTION: Farm Details -->
        <div class="section mb-4">
          <h2>Farm Details</h2>
          <label for="dairy-number">Dairy Number:</label>
          <input type="text" class="form-control" id="dairy-number" name="dairy-number"
                 onblur="handleDairyNumberBlur();" autocapitalize="words" autocorrect="off" spellcheck="false">
          <label for="dairy-company">Dairy Company:</label>
          <input type="text" class="form-control" id="dairy-company" name="dairy-company"
                 list="dairy-company-list" placeholder="Type or select..." autocapitalize="words" autocorrect="off" spellcheck="false">
          <datalist id="dairy-company-list"></datalist>
          <label for="address">Address:</label>
          <input type="text" class="form-control" id="address" name="address" autocapitalize="words" autocorrect="off" spellcheck="false">
          <label for="customer-name">Customer Name:</label>
          <input type="text" class="form-control" id="customer-name" name="customer-name" autocapitalize="words" autocorrect="off" spellcheck="false">
          <label for="region">Region:</label>
          <select id="region" name="region" class="form-select">
            <option value="northland">Northland</option>
            <option value="auckland">Auckland</option>
            <option value="waikato">Waikato</option>
            <option value="bay-of-plenty">Bay of Plenty</option>
            <option value="gisborne">Gisborne</option>
            <option value="hawkes-bay">Hawke's Bay</option>
            <option value="taranaki">Taranaki</option>
            <option value="manawatu-wanganui">Manawatu-Wanganui</option>
            <option value="wellington">Wellington</option>
            <option value="nelson">Nelson</option>
            <option value="marlborough">Marlborough</option>
            <option value="west-coast">West Coast</option>
            <option value="canterbury">Canterbury</option>
            <option value="otago">Otago</option>
            <option value="southland">Southland</option>
          </select>
          <label for="farm-name">Farm Name:</label>
          <input type="text" class="form-control" id="farm-name" name="farm-name" autocapitalize="words" autocorrect="off" spellcheck="false">
          <label for="island">Island:</label>
          <select id="island" name="island" class="form-select">
            <option value="north-island">North Island</option>
            <option value="south-island">South Island</option>
          </select>
          <label for="visit-date">Visit Date:</label>
          <input type="date" class="form-control" id="visit-date" name="visit-date">
          <label for="visit-type">Visit Type:</label>
          <input type="text" class="form-control" id="visit-type" name="visit-type"
                 value="Milking Plant & Milk Vat Check" readonly autocapitalize="words" autocorrect="off" spellcheck="false">
          <label for="inspection-start-time">Inspection Start Time:</label>
          <input type="time" class="form-control" id="inspection-start-time" name="inspection-start-time">
          <label for="inspection-end-time">Inspection End Time:</label>
          <input type="time" class="form-control" id="inspection-end-time" name="inspection-end-time">
          <label for="inspection-completed-by">Inspection Completed By:</label>
          <input type="text" class="form-control" id="inspection-completed-by" name="inspection-completed-by"
                 autocapitalize="words" autocorrect="off" spellcheck="false">
          <label for="call-type">Call Type:</label>
          <select id="call-type" name="call-type" class="form-select">
            <option value="alert">Alert</option>
            <option value="grade-call">Grade Call</option>
            <option value="regular-scheduled-visit" selected>Regular Scheduled Visit</option>
          </select>
        </div>

        <!-- HEALTH & SAFETY -->
        <div class="section mb-4">
          <h2>Health & Safety</h2>
          <div id="health-safety-top"></div>
        </div>

        <!-- PLANT CHECKLIST -->
        <div class="section mb-4">
          <h2>Plant Checklist</h2>
          <div id="checklist-items"></div>
        </div>

        <!-- SILO CHECKLIST -->
        <div class="section mb-4">
          <h2>Silo Checklist</h2>
          <div id="silo-checklist"></div>
        </div>

        <!-- ADDITIONAL CHECKS -->
        <div class="section mb-4">
          <h2>Additional Checks</h2>
          <div id="additional-checks"></div>
        </div>

        <!-- TEMPERATURE MEASUREMENTS -->
        <div class="section mb-4">
          <h2>Temperature Measurements</h2>
          <div class="checklist-item">
            <label for="hot-water-temp">Hot Water Temp (°C):</label>
            <input type="text" class="form-control" id="hot-water-temp" name="hot-water-temp" step="0.1"
                   autocapitalize="sentences" autocorrect="off" spellcheck="true">
            <label for="hot-water-time">Time Taken:</label>
            <input type="time" class="form-control" id="hot-water-time" name="hot-water-time">
          </div>
          <div class="checklist-item">
            <label for="milk-temp">Milk Temp (°C):</label>
            <input type="text" class="form-control" id="milk-temp" name="milk-temp" step="0.1"
                   autocapitalize="sentences" autocorrect="off" spellcheck="true">
            <label for="milk-time">Time Taken:</label>
            <input type="time" class="form-control" id="milk-time" name="milk-time">
          </div>
        </div>

        <button type="button" onclick="generatePDF()">Generate PDF</button>
        <button type="button" onclick="viewRecords()">View All Records</button>
        <button type="button" id="show-map">Show Farms Map</button>
      </form>
      <div class="version">Version 6.1</div>
      <div id="map"></div>
    </div>

    <!-- RECORDS VIEW -->
    <div id="record-container" class="record-container" style="display: none;">
      <h2>All Dairy Shed Hygiene Records</h2>
      <div class="search-container">
        <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number"
               oninput="filterRecords()">
      </div>
      <div id="record-list" class="record-list"></div>
      <button class="back-button" onclick="goBack()">Back to Checklist</button>
    </div>
  </div>

  <!-- PART 4: SCRIPTS -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /*******************************************
     * AUTH & MAP SETUP
     *******************************************/
    const auth = firebase.auth();
    auth.onAuthStateChanged(async user => {
      if (user) {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        const idToken = await user.getIdTokenResult();
        window.currentRole = idToken.claims.role || 'customer';
        if (window.currentRole === 'customer') {
          await setupCustomerView(user.uid);
        }
        attachAppListeners();
      } else {
        document.getElementById('login-container').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
      }
    });

    document.getElementById('login-button').addEventListener('click', () => {
      const email = document.getElementById('login-email').value;
      const pass  = document.getElementById('login-password').value;
      auth.signInWithEmailAndPassword(email, pass)
        .catch(err => document.getElementById('login-error').textContent = err.message);
    });

    function attachAppListeners() {
      document.getElementById('show-map').addEventListener('click', initMap);
    }

    async function setupCustomerView(uid) {
      const permDoc = await firebase.firestore().collection('user_permissions').doc(uid).get();
      const allowed = permDoc.exists ? permDoc.data().dairyNumbers || [] : [];
      const dnInput = document.getElementById('dairy-number');
      const parent = dnInput.parentNode;
      const select = document.createElement('select');
      select.id = 'dairy-number';
      select.className = 'form-select';
      allowed.forEach(dn => {
        const opt = document.createElement('option');
        opt.value = dn; opt.textContent = dn;
        select.appendChild(opt);
      });
      parent.replaceChild(select, dnInput);
    }

    let mapInitialized = false;
    async function initMap() {
      if (!mapInitialized) {
        document.getElementById('map').style.display = 'block';
        window.map = L.map('map').setView([-36.8485, 174.7633], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(window.map);
        await loadFarmMarkers();
        mapInitialized = true;
      } else {
        window.map.invalidateSize();
      }
    }

    async function loadFarmMarkers() {
      const storageRef = firebase.storage().ref('farm_details');
      const list = await storageRef.listAll();
      for (let itemRef of list.items) {
        const url = await itemRef.getDownloadURL();
        const data = await fetch(url).then(r=>r.json());
        if (data.lat && data.lng) {
          const marker = L.marker([data.lat, data.lng]).addTo(window.map);
          const dairy = itemRef.name.replace('.json','');
          const html = `
            <strong>Dairy #${dairy}</strong><br/>
            Company: ${data.dairyCompany||''}<br/>
            Address: ${data.address||''}<br/>
            <textarea id="note-${dairy}" placeholder="Enter note..."></textarea><br/>
            <button id="save-${dairy}">Save Note</button>
            <div id="notes-list-${dairy}"></div>
          `;
          marker.bindPopup(html);
          marker.on('popupopen', () => {
            document.getElementById(`save-${dairy}`).onclick = () => saveNote(dairy);
            loadNotes(dairy);
          });
        }
      }
    }

    function saveNote(dairy) {
      const text = document.getElementById(`note-${dairy}`).value.trim();
      if (!text) return alert('Enter a note');
      firebase.firestore()
        .collection('farm_notes').doc(dairy)
        .collection('notes')
        .add({ text, timestamp: firebase.firestore.FieldValue.serverTimestamp(), uid: auth.currentUser.uid })
        .then(() => {
          document.getElementById(`note-${dairy}`).value = '';
          loadNotes(dairy);
        });
    }

    async function loadNotes(dairy) {
      const listDiv = document.getElementById(`notes-list-${dairy}`);
      listDiv.innerHTML = '';
      const snaps = await firebase.firestore()
        .collection('farm_notes').doc(dairy)
        .collection('notes').orderBy('timestamp','desc').get();
      snaps.forEach(doc => {
        const d = doc.data();
        const time = d.timestamp?.toDate().toLocaleString() || '';
        const div = document.createElement('div');
        div.textContent = `[${time}] ${d.text}`;
        listDiv.appendChild(div);
      });
    }

    /*******************************************
     * A: FIREBASE & DEXIE INIT
     *******************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
      authDomain: "dairy-farm-record-system.firebaseapp.com",
      projectId: "dairy-farm-record-system",
      storageBucket: "dairy-farm-record-system.appspot.com",
      messagingSenderId: "422124188212",
      appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
    };
    // Already initialized above for auth
    const storage = firebase.storage();
    const firestore = firebase.firestore();
    const db = new Dexie("OfflineData");
    db.version(5).stores({
      forms: "dairyNumber",
      dairyCompanies: "++id, name",
      teatSprayRatios: "++id, ratio",
      pdfQueue: "++id,dairyNumber,fileName,uploaded"
    });
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registered:', reg.scope))
        .catch(err => console.error('SW registration failed:', err));
    }

    /*******************************************
     * A1: Title Case Utility
     *******************************************/
    function toTitleCase(str) {
      return str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
      });
    }
    function autoCapitalizeInput(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('blur', () => { el.value = toTitleCase(el.value); });
    }

    /*******************************************
     * B: SETUP DAIRY COMPANY DATALIST
     *******************************************/
    async function setupDairyCompanyDatalist() {
      const defaultCompanies = [
        "Fonterra", "Dairy Goat Co-op", "Green Valley Dairies", "Maui Milk",
        "Oceania", "OFI", "Synlait Milk LTD", "Tatua", "Danone", "Fresha Valley LTD",
        "Mataura Valley Milk", "Open Country Dairy LTD", "Waiu", "Westland Milk Products"
      ];
      const userCompanies = await db.dairyCompanies.toArray();
      const allCompanies = [...defaultCompanies];
      userCompanies.forEach(u => { if (!allCompanies.includes(u.name)) allCompanies.push(u.name); });
      const datalist = document.getElementById('dairy-company-list');
      datalist.innerHTML = "";
      allCompanies.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        datalist.appendChild(opt);
      });
      const dairyCompanyInput = document.getElementById('dairy-company');
      dairyCompanyInput.addEventListener('blur', async () => {
        dairyCompanyInput.value = toTitleCase(dairyCompanyInput.value.trim());
        const typedValue = dairyCompanyInput.value;
        if (typedValue && !allCompanies.includes(typedValue)) {
          await db.dairyCompanies.add({ name: typedValue });
          allCompanies.push(typedValue);
          const newOpt = document.createElement('option');
          newOpt.value = typedValue;
          datalist.appendChild(newOpt);
        }
      });
    }

    /*******************************************
     * C: FETCH FARM DETAILS
     *******************************************/
    async function fetchFarmDetails() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
      try {
        const url = await storageRef.getDownloadURL();
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch the farm details');
        const data = await response.json();
        if (data) {
          document.getElementById('dairy-company').value = toTitleCase(data.dairyCompany || '');
          document.getElementById('address').value = toTitleCase(data.address || '');
          document.getElementById('customer-name').value = toTitleCase(data.customerName || '');
          document.getElementById('region').value = data.region || '';
          document.getElementById('farm-name').value = toTitleCase(data.farmName || '');
          document.getElementById('island').value = data.island || '';
        }
      } catch (error) {
        console.log('No farm details found or error fetching from Firebase.');
      }
    }

    /*******************************************
     * D: CHECK/CREATE FORM RECORD
     *******************************************/
    async function checkOrCreateFormRecord() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      let record = await db.forms.get(dairyNumber);
      if (!record) {
        record = { dairyNumber: dairyNumber, formData: {}, creationTime: Date.now() };
        await db.forms.put(record);
      }
    }

    /*******************************************
     * NEW: On Page Load, Prompt for a Cached Draft
     *******************************************/
    async function checkForCachedFormOnLoad() {
      const records = await db.forms.toArray();
      let recordToPrompt = null;
      for (const record of records) {
        if (record.formData && record.formData.checklistItems && Object.keys(record.formData.checklistItems).length > 0) {
          const hasDraft = Object.values(record.formData.checklistItems).some(item => item.status !== "ok");
          if (hasDraft) {
            recordToPrompt = record;
            break;
          }
        }
      }
      if (recordToPrompt) {
        const continueForm = confirm(
          `Draft data exists for Dairy #${recordToPrompt.dairyNumber}.\n\nClick OK to restore the draft.\nClick Cancel to start a new form (the draft will be deleted).`
        );
        if (continueForm) {
          loadFormDataFromRecord(recordToPrompt);
          window.restoredDraft = recordToPrompt.formData.checklistItems;
        } else {
          await db.forms.delete(recordToPrompt.dairyNumber);
          clearEntireForm();
        }
      }
    }

    async function handleDairyNumberBlur() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      fetchFarmDetails();
      await checkOrCreateFormRecord();
    }

    /*******************************************
     * E1: CREATE HEALTH & SAFETY ITEMS
     *******************************************/
    function createHealthSafetyItems(containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      const itemContainer = document.createElement("div");
      itemContainer.classList.add("checklist-item");
      const label = document.createElement("label");
      label.textContent = "Health & Safety Notes";
      itemContainer.appendChild(label);
      const statusSelect = document.createElement("select");
      statusSelect.classList.add("form-select");
      statusSelect.name = "status-health-safety-notes";
      statusSelect.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
      itemContainer.appendChild(statusSelect);
      const commentsInput = document.createElement("input");
      commentsInput.type = "text";
      commentsInput.classList.add("form-control");
      commentsInput.name = "comments-health-safety-notes";
      commentsInput.placeholder = "Comments";
      commentsInput.setAttribute("spellcheck", "true");
      commentsInput.setAttribute("autocorrect", "off");
      itemContainer.appendChild(commentsInput);
      const imageUpload1 = document.createElement("input");
      imageUpload1.type = "file";
      imageUpload1.classList.add("form-control", "image-upload");
      imageUpload1.style.display = "none";
      itemContainer.appendChild(imageUpload1);
      const imagePreview1 = document.createElement("img");
      imagePreview1.classList.add("image-preview");
      itemContainer.appendChild(imagePreview1);
      const imageUpload2 = document.createElement("input");
      imageUpload2.type = "file";
      imageUpload2.classList.add("form-control", "image-upload");
      imageUpload2.style.display = "none";
      itemContainer.appendChild(imageUpload2);
      const imagePreview2 = document.createElement("img");
      imagePreview2.classList.add("image-preview");
      itemContainer.appendChild(imagePreview2);
      statusSelect.addEventListener("change", () => {
        if (statusSelect.value === "attention-required") {
          imageUpload1.style.display = "block";
          imageUpload2.style.display = "block";
        } else {
          imageUpload1.style.display = "none";
          imageUpload2.style.display = "none";
        }
      });
      container.appendChild(itemContainer);
    }

    /*******************************************
     * E2: CREATE PLANT CHECKLIST
     *******************************************/
    function createChecklistItems() {
      const checklistItems = [
        "Pulsator Airline", "Long Bend Elbows", "Automatic Cup and Remover", "Diaphragm", "Receiving Can",
        "Sanitary Trap", "Main Milk Line", "Milk Line Seals in Good Condition", "Stainless Droppers", "Long Milk Rubber",
        "Liner", "Cluster", "Cluster Seal", "Cluster Button", "Non Return Valve at Milk Pump", "Milk Pump",
        "Filter Housing", "Plate Cooler", "Interceptor", "Receiver Airline", "Flushing Pulsator", "Air Purge Valve",
        "Vacuum Level", "Main Airline", "Plant Drainage - Milk Pump", "Plant Drainage - Filter/s", "Plant Drainage - Plate Cooler",
        "Plant Drainage - Vat Entry", "Plant Wash Tap", "Wash Jetters", "Centre Gland", "Test Bucket"
      ];
      const container = document.getElementById("checklist-items");
      container.innerHTML = "";
      checklistItems.forEach(item => {
        const itemContainer = document.createElement("div");
        itemContainer.classList.add("checklist-item");
        const label = document.createElement("label");
        label.textContent = item;
        itemContainer.appendChild(label);
        const statusSelect = document.createElement("select");
        statusSelect.classList.add("form-select");
        statusSelect.name = `status-${item}`;
        statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
        itemContainer.appendChild(statusSelect);
        const commentsInput = document.createElement("input");
        commentsInput.type = "text";
        commentsInput.classList.add("form-control");
        commentsInput.name = `comments-${item}`;
        commentsInput.placeholder = "Comments";
        commentsInput.setAttribute("spellcheck", "true");
        commentsInput.setAttribute("autocorrect", "off");
        itemContainer.appendChild(commentsInput);
        for (let i = 1; i <= 2; i++) {
          const imageUpload = document.createElement("input");
          imageUpload.type = "file";
          imageUpload.classList.add("form-control", "image-upload");
          imageUpload.style.display = "none";
          itemContainer.appendChild(imageUpload);
          const imagePreview = document.createElement("img");
          imagePreview.classList.add("image-preview");
          itemContainer.appendChild(imagePreview);
        }
        statusSelect.addEventListener("change", () => {
          const allInputs = itemContainer.querySelectorAll('input[type="file"]');
          if (statusSelect.value === "attention-required") {
            allInputs.forEach(inp => inp.style.display = "block");
          } else {
            allInputs.forEach(inp => inp.style.display = "none");
          }
        });
        container.appendChild(itemContainer);
      });
    }

    /*******************************************
     * E3: CREATE SILO CHECKLIST
     *******************************************/
    function createSiloChecklist() {
      const siloItems = [
        "Inlet Valve", "Non-Return Valve", "Spray Ball", "Agitator",
        "Silo Door", "Manhole Seal", "Vat Outlet", "Walls in Silo"
      ];
      const siloItemsToAutoFill = [
        "Inlet Valve", "Non-Return Valve", "Spray Ball", "Agitator",
        "Silo Door", "Manhole Seal", "Vat Outlet", "Walls in Silo"
      ];
      const container = document.getElementById("silo-checklist");
      container.innerHTML = "";
      siloItems.forEach(item => {
        const itemContainer = document.createElement("div");
        itemContainer.classList.add("checklist-item");
        const label = document.createElement("label");
        label.textContent = item;
        itemContainer.appendChild(label);
        const statusSelect = document.createElement("select");
        statusSelect.classList.add("form-select");
        statusSelect.name = `status-${item}`;
        statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
        itemContainer.appendChild(statusSelect);
        const commentsInput = document.createElement("input");
        commentsInput.type = "text";
        commentsInput.classList.add("form-control");
        commentsInput.name = `comments-${item}`;
        commentsInput.placeholder = "Comments";
        commentsInput.setAttribute("spellcheck", "true");
        commentsInput.setAttribute("autocorrect", "off");
        itemContainer.appendChild(commentsInput);
        for (let i = 1; i <= 2; i++) {
          const imageUpload = document.createElement("input");
          imageUpload.type = "file";
          imageUpload.classList.add("form-control", "image-upload");
          imageUpload.style.display = "none";
          itemContainer.appendChild(imageUpload);
          const imagePreview = document.createElement("img");
          imagePreview.classList.add("image-preview");
          itemContainer.appendChild(imagePreview);
        }
        statusSelect.addEventListener("change", () => {
          const allInputs = itemContainer.querySelectorAll('input[type="file"]');
          if (statusSelect.value === "attention-required") {
            allInputs.forEach(inp => inp.style.display = "block");
          } else {
            allInputs.forEach(inp => inp.style.display = "none");
          }
          if (statusSelect.value === "not-checked" && siloItemsToAutoFill.includes(item)) {
            commentsInput.value = "Milk in Vat";
          } else if (commentsInput.value === "Milk in Vat") {
            commentsInput.value = "";
          }
        });
        container.appendChild(itemContainer);
      });
    }

    /*******************************************
     * E4: CREATE ADDITIONAL CHECKS
     *******************************************/
    async function createAdditionalChecks() {
      const container = document.getElementById("additional-checks");
      container.innerHTML = "";

      // Teat Spray Check
      const teatSprayContainer = document.createElement("div");
      teatSprayContainer.classList.add("checklist-item");
      const labelTeat = document.createElement("label");
      labelTeat.textContent = "Teat Spray Check";
      teatSprayContainer.appendChild(labelTeat);
      const statusSelectTeat = document.createElement("select");
      statusSelectTeat.classList.add("form-select");
      statusSelectTeat.name = "status-teat-spray-check";
      statusSelectTeat.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
      teatSprayContainer.appendChild(statusSelectTeat);
      const commentsInputTeat = document.createElement("input");
      commentsInputTeat.type = "text";
      commentsInputTeat.classList.add("form-control");
      commentsInputTeat.name = "comments-teat-spray-check";
      commentsInputTeat.placeholder = "Comments";
      commentsInputTeat.setAttribute("spellcheck", "true");
      commentsInputTeat.setAttribute("autocorrect", "off");
      teatSprayContainer.appendChild(commentsInputTeat);
      for (let i = 1; i <= 2; i++) {
        const imageUpload = document.createElement("input");
        imageUpload.type = "file";
        imageUpload.classList.add("form-control", "image-upload");
        imageUpload.style.display = "none";
        teatSprayContainer.appendChild(imageUpload);
        const imagePreview = document.createElement("img");
        imagePreview.classList.add("image-preview");
        teatSprayContainer.appendChild(imagePreview);
      }
      statusSelectTeat.addEventListener("change", () => {
        const allInputs = teatSprayContainer.querySelectorAll('input[type="file"]');
        if (statusSelectTeat.value === "attention-required") {
          allInputs.forEach(inp => inp.style.display = "block");
        } else {
          allInputs.forEach(inp => inp.style.display = "none");
        }
      });
      const ratioLabel = document.createElement("label");
      ratioLabel.textContent = "Teat Spray Dilution Ratio:";
      teatSprayContainer.appendChild(ratioLabel);
      const ratioInput = document.createElement("input");
      ratioInput.type = "text";
      ratioInput.classList.add("form-control");
      ratioInput.name = "teat-spray-dilution";
      ratioInput.id = "teat-dilution";
      ratioInput.setAttribute("list", "teat-dilution-list");
      ratioInput.placeholder = "Type or select e.g. 1:5";
      ratioInput.setAttribute("autocapitalize", "words");
      ratioInput.setAttribute("autocorrect", "off");
      ratioInput.setAttribute("spellcheck", "false");
      teatSprayContainer.appendChild(ratioInput);
      const ratioDataList = document.createElement("datalist");
      ratioDataList.id = "teat-dilution-list";
      teatSprayContainer.appendChild(ratioDataList);
      const existingRatios = await db.teatSprayRatios.toArray();
      const allRatios = ["1:4"];
      existingRatios.forEach(r => { if (!allRatios.includes(r.ratio)) allRatios.push(r.ratio); });
      ratioDataList.innerHTML = "";
      allRatios.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        ratioDataList.appendChild(opt);
      });
      ratioInput.addEventListener("blur", async () => {
        ratioInput.value = toTitleCase(ratioInput.value.trim());
        const typedRatio = ratioInput.value;
        if (typedRatio && !allRatios.includes(typedRatio)) {
          await db.teatSprayRatios.add({ ratio: typedRatio });
          allRatios.push(typedRatio);
          const newOpt = document.createElement("option");
          newOpt.value = typedRatio;
          ratioDataList.appendChild(newOpt);
        }
      });
      container.appendChild(teatSprayContainer);

      // Chemical Check
      const chemicalContainer = document.createElement("div");
      chemicalContainer.classList.add("checklist-item");
      const labelChemical = document.createElement("label");
      labelChemical.textContent = "Chemical Check";
      chemicalContainer.appendChild(labelChemical);
      const statusSelectChemical = document.createElement("select");
      statusSelectChemical.classList.add("form-select");
      statusSelectChemical.name = "status-chemical-check";
      statusSelectChemical.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
      chemicalContainer.appendChild(statusSelectChemical);
      const commentsInputChemical = document.createElement("input");
      commentsInputChemical.type = "text";
      commentsInputChemical.classList.add("form-control");
      commentsInputChemical.name = "comments-chemical-check";
      commentsInputChemical.placeholder = "Comments";
      commentsInputChemical.setAttribute("spellcheck", "true");
      commentsInputChemical.setAttribute("autocorrect", "off");
      chemicalContainer.appendChild(commentsInputChemical);
      for (let i = 1; i <= 2; i++) {
        const imageUpload = document.createElement("input");
        imageUpload.type = "file";
        imageUpload.classList.add("form-control", "image-upload");
        imageUpload.style.display = "none";
        chemicalContainer.appendChild(imageUpload);
        const imagePreview = document.createElement("img");
        imagePreview.classList.add("image-preview");
        chemicalContainer.appendChild(imagePreview);
      }
      statusSelectChemical.addEventListener("change", () => {
        const allInputs = chemicalContainer.querySelectorAll('input[type="file"]');
        if (statusSelectChemical.value === "attention-required") {
          allInputs.forEach(inp => inp.style.display = "block");
        } else {
          allInputs.forEach(inp => inp.style.display = "none");
        }
      });
      container.appendChild(chemicalContainer);
    }

    /*******************************************
     * F1: LOAD FORM DATA (including images)
     *******************************************/
    function loadFormDataFromRecord(record) {
      const data = record.formData || {};
      document.getElementById("dairy-number").value = record.dairyNumber;
      for (let key in data) {
        if (key === "checklistItems") continue;
        const field = document.getElementById(key) || document.getElementsByName(key)[0];
        if (field) { field.value = data[key]; }
      }
      if (data.checklistItems) {
        const containers = [
          ...document.getElementById("health-safety-top").children,
          ...document.getElementById("checklist-items").children,
          ...document.getElementById("additional-checks").children,
          ...document.getElementById("silo-checklist").children
        ];
        containers.forEach(container => {
          const label = container.querySelector("label");
          if (!label) return;
          const key = label.textContent.trim();
          if (data.checklistItems[key]) {
            const { status, comments, imagesBase64 } = data.checklistItems[key];
            const statusSelect = container.querySelector("select");
            if (statusSelect) {
              statusSelect.value = status;
              statusSelect.dispatchEvent(new Event("change"));
            }
            const commentsInput = container.querySelector('input[type="text"]');
            if (commentsInput) { commentsInput.value = comments; }
            if (imagesBase64 && imagesBase64.length > 0) {
              const previews = container.querySelectorAll(".image-preview");
              imagesBase64.forEach((img64, i) => {
                if (previews[i]) {
                  previews[i].src = img64;
                  previews[i].style.display = "block";
                }
              });
            }
          }
        });
      }
    }

    function clearEntireForm() {
      document.getElementById("hygiene-checklist-form").reset();
      document.querySelectorAll(".image-upload").forEach(inp => inp.style.display = "none");
      document.querySelectorAll(".image-preview").forEach(img => { img.src=""; img.style.display="none"; });
    }

    /*******************************************
     * G: SAVE FORM DATA ON INPUT (including images)
     *******************************************/
    async function saveFormData() {
      const dairyNumber = document.getElementById("dairy-number").value.trim();
      if (!dairyNumber) return;
      let record = await db.forms.get(dairyNumber);
      if (!record) record = { dairyNumber, formData: {}, creationTime: Date.now() };
      const form = document.getElementById("hygiene-checklist-form");
      const formDataObj = new FormData(form);
      const data = Object.fromEntries(Array.from(formDataObj.entries()).filter(([k,v])=>v.trim()!==""));
      const containersToCheck = [
        document.getElementById("health-safety-top").children,
        document.getElementById("checklist-items").children,
        document.getElementById("additional-checks").children,
        document.getElementById("silo-checklist").children
      ];
      const checklistItemsData = {};
      for (let containerGroup of containersToCheck) {
        for (let item of containerGroup) {
          const label = item.querySelector("label");
          if (!label) continue;
          const key = label.textContent.trim();
          const status = item.querySelector("select")?.value||"";
          const comments = item.querySelector('input[type="text"]')?.value||"";
          let imagesBase64 = [];
          for (let fi of item.querySelectorAll('input[type="file"]')) {
            if (fi.files?.[0]) {
              const base64 = await convertFileToBase64(fi.files[0]);
              imagesBase64.push(base64);
            }
          }
          if (record.formData.checklistItems?.[key] && imagesBase64.length===0) {
            imagesBase64 = record.formData.checklistItems[key].imagesBase64||[];
          }
          checklistItemsData[key] = { status, comments, imagesBase64 };
        }
      }
      data.checklistItems = checklistItemsData;
      record.formData = data;
      await db.forms.put(record);
    }

    function convertFileToBase64(file) {
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=>resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /*******************************************
     * H: SAVE FARM DETAILS TO FIREBASE
     *******************************************/
    async function saveFarmDetailsToFirebase(fd) {
      const dairyNumber = fd.get("dairy-number")||"";
      if (!dairyNumber) return;
      const farmDetails = {
        dairyCompany: fd.get("dairy-company")||"",
        address: fd.get("address")||"",
        customerName: fd.get("customer-name")||"",
        region: fd.get("region")||"",
        farmName: fd.get("farm-name")||"",
        island: fd.get("island")||"",
        lat: window.currentLat||null,
        lng: window.currentLng||null
      };
      const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
      const metadata = { contentType: "application/json" };
      try {
        await storageRef.put(new Blob([JSON.stringify(farmDetails)],{type:"application/json"}), metadata);
        console.log("Farm details saved to Firebase successfully.");
      } catch(err) {
        console.error("Error saving farm details to Firebase:", err);
      }
    }

    /*******************************************
     * H2: PDF UPLOAD RETRY LOGIC
     *******************************************/
    async function uploadPendingPDFs() {
      if (!navigator.onLine) return;
      const queuedPDFs = await db.pdfQueue.where("uploaded").equals(false).toArray();
      for (let pdfRecord of queuedPDFs) {
        try {
          await uploadSinglePDF(pdfRecord.dairyNumber, pdfRecord.fileName, pdfRecord.pdfBlob);
          await db.pdfQueue.update(pdfRecord.id,{uploaded:true});
          console.log(`Retried PDF for ${pdfRecord.dairyNumber} uploaded successfully.`);
        } catch(err) {
          console.error("Retry PDF upload failed:", err);
        }
      }
    }
    function uploadSinglePDF(dairyNumber,fileName,pdfBlob) {
      return new Promise((resolve,reject)=>{
        const uploadRef = storage.ref(`customers/${dairyNumber}/${fileName}`);
        const task = uploadRef.put(pdfBlob);
        task.on("state_changed",null,err=>reject(err),()=>resolve());
      });
    }
    window.addEventListener("online",uploadPendingPDFs);

    /*******************************************
     * I: GENERATE PDF
     *******************************************/
    async function generatePDF() {
      const dairyNumber = document.getElementById("dairy-number").value.trim();
      if (!dairyNumber) { alert("Please enter a Dairy Number."); return; }
      const form = document.getElementById("hygiene-checklist-form");
      const fd = new FormData(form);
      await saveFarmDetailsToFirebase(fd);
      const containers = [
        ...document.getElementById("health-safety-top").children,
        ...document.getElementById("checklist-items").children,
        ...document.getElementById("additional-checks").children,
        ...document.getElementById("silo-checklist").children
      ];
      const itemDataArray = [];
      containers.forEach(item=>{
        const labelEl = item.querySelector("label");
        if(!labelEl) return;
        const itemName = labelEl.textContent;
        const status = item.querySelector("select")?.value||"";
        let comments = item.querySelector('input[type="text"]')?.value||"";
        if(itemName==="Teat Spray Check") {
          const ratioField = item.querySelector("#teat-dilution");
          if(ratioField?.value) comments+=comments?` | Ratio: ${ratioField.value}`:`Ratio: ${ratioField.value}`;
        }
        let imageFiles = [];
        item.querySelectorAll('input[type="file"]').forEach(fi=>{
          if(fi.files?.[0]) imageFiles.push(fi.files[0]);
        });
        if(imageFiles.length===0 && window.restoredDraft){
          const key = itemName.trim();
          if(window.restoredDraft[key]?.imagesBase64) imageFiles = window.restoredDraft[key].imagesBase64;
        }
        if(status==="attention-required" && imageFiles.length>0){
          comments+= imageFiles.length>1?" (see attached photos)":" (see attached photo)";
        }
        itemDataArray.push({itemName,status,comments,imageFiles});
      });
      let pendingImages=0,photoStore=[];
      itemDataArray.forEach(obj=>{
        if(obj.imageFiles.length>0){
          const p={itemName:obj.itemName,images:[]};
          obj.imageFiles.forEach((file,idx)=>{
            if(typeof file==="string"){
              p.images[idx]=file;
            } else {
              pendingImages++;
              const reader=new FileReader();
              reader.onload=evt=>{
                p.images[idx]=evt.target.result;
                pendingImages--;
                if(pendingImages===0) finalizePDF();
              };
              reader.readAsDataURL(file);
            }
          });
          photoStore.push(p);
        }
      });
      if(pendingImages===0) finalizePDF();
      async function finalizePDF() {
        const pdf = new jsPDF("p","pt","a4");
        let currentY = 80;
        try {
          const logoRef = storage.ref("Picture3.jpg");
          const logoUrl = await logoRef.getDownloadURL();
          const logoBlob = await fetch(logoUrl).then(res=>res.blob());
          const logoBase64 = await blobToBase64(logoBlob);
          const pageWidth = pdf.internal.pageSize.getWidth();
          const imgProps = pdf.getImageProperties(logoBase64);
          const imgWidth = pageWidth - 80;
          const imgHeight = (imgProps.height*imgWidth)/imgProps.width;
          const x=(pageWidth-imgWidth)/2;
          pdf.addImage(logoBase64,"JPEG",x,40,imgWidth,imgHeight);
          pdf.setFontSize(12); pdf.setTextColor("#000000"); pdf.setFont("helvetica","bold");
          pdf.text("Farm Details:",40,imgHeight+60);
          currentY = imgHeight+80;
        } catch(err) {
          console.error("Error retrieving logo. Generating PDF without logo.");
          pdf.setFontSize(12); pdf.setTextColor("#000000"); pdf.setFont("helvetica","bold");
          pdf.text("Farm Details:",40,currentY); currentY+=20;
        }
        pdf.setFont("helvetica","normal");
        const addLine=text=>{ pdf.text(text,40,currentY); currentY+=15; };
        addLine(`Dairy Company: ${fd.get("dairy-company")||""}`);
        addLine(`Dairy Number: ${fd.get("dairy-number")||""}`);
        addLine(`Address: ${fd.get("address")||""}`);
        addLine(`Customer Name: ${fd.get("customer-name")||""}`);
        addLine(`Region: ${fd.get("region")||""}`);
        addLine(`Farm Name: ${fd.get("farm-name")||""}`);
        addLine(`Island: ${fd.get("island")||""}`);
        addLine(`Visit Date: ${fd.get("visit-date")||""}`);
        addLine(`Visit Type: ${fd.get("visit-type")||""}`);
        addLine(`Inspection Start Time: ${fd.get("inspection-start-time")||""}`);
        addLine(`Inspection End Time: ${fd.get("inspection-end-time")||""}`);
        addLine(`Inspection Completed By: ${fd.get("inspection-completed-by")||""}`);
        addLine(`Call Type: ${fd.get("call-type")||""}`);
        currentY+=15;
        const tableData=itemDataArray.map(obj=>[obj.itemName,obj.status,obj.comments]);
        pdf.autoTable({
          startY: currentY,
          head:[["Item","Status","Comments"]],
          body:tableData,
          styles:{fontSize:10,cellPadding:5},
          headStyles:{fillColor:"#002B5C",textColor:"#FFFFFF"}
        });
        let afterTableY=pdf.lastAutoTable.finalY+20;
        pdf.setFont("helvetica","bold"); pdf.text("Temperature Measurements:",40,afterTableY);
        afterTableY+=20; pdf.setFont("helvetica","normal");
        const hotW=fd.get("hot-water-temp")||"", hotT=fd.get("hot-water-time")||"";
        pdf.text(`Hot Water Temp: ${hotW} °C`,40,afterTableY); afterTableY+=15;
        pdf.text(`Time Taken: ${hotT}`,40,afterTableY); afterTableY+=20;
        const milkW=fd.get("milk-temp")||"", milkT=fd.get("milk-time")||"";
        pdf.text(`Milk Temp: ${milkW} °C`,40,afterTableY); afterTableY+=15;
        pdf.text(`Time Taken: ${milkT}`,40,afterTableY); afterTableY+=20;
        let photoY=afterTableY+20;
        const pw=pdf.internal.pageSize.getWidth();
        photoStore.forEach(photoObj=>{
          const reqH=15+200+10;
          if(photoY+reqH>pdf.internal.pageSize.getHeight()){
            pdf.addPage(); photoY=60;
          }
          pdf.setFontSize(12); pdf.text(photoObj.itemName,40,photoY);
          if(photoObj.images.length===1){
            pdf.addImage(photoObj.images[0],"JPEG",40,photoY+15,250,200);
          } else if(photoObj.images.length===2){
            const iw=(pw-120)/2;
            pdf.addImage(photoObj.images[0],"JPEG",40,photoY+15,iw,200);
            pdf.addImage(photoObj.images[1],"JPEG",60+iw,photoY+15,iw,200);
          }
          photoY+=reqH;
        });
        const pdfBlob=pdf.output("blob");
        const timestamp=new Date().toISOString().split("T")[0];
        const fileName=`${dairyNumber}-form-${timestamp}.pdf`;
        let uploadSuccessful=false;
        if(navigator.onLine){
          try{
            await uploadSinglePDF(dairyNumber,fileName,pdfBlob);
            uploadSuccessful=true;
            console.log("PDF uploaded successfully.");
          }catch(err){ console.error("Immediate PDF upload failed:",err); }
        }
        if(!uploadSuccessful){
          await db.pdfQueue.add({ dairyNumber, fileName, pdfBlob, uploaded:false });
          console.log("PDF queued for retry.");
        }
        await db.forms.delete(dairyNumber);
        pdf.save(`Dairy_Shed_Hygiene_Checklist_${dairyNumber}.pdf`);
        uploadPendingPDFs();
        clearEntireForm();
        location.reload();
      }
      function blobToBase64(blob){
        return new Promise((resolve,reject)=>{
          const reader=new FileReader();
          reader.onload=()=>resolve(reader.result);
          reader.onerror=reject;
          reader.readAsDataURL(blob);
        });
      }
    }

    /*******************************************
     * J: RECORDS VIEW PAGE
     *******************************************/
    function viewRecords() {
      document.getElementById("form-container").style.display = "none";
      document.getElementById("record-container").style.display = "block";
      loadAllRecords();
    }
    async function loadAllRecords() {
      const recordList = document.getElementById("record-list");
      recordList.innerHTML = "";
      const storageRef = storage.ref("customers");
      try {
        const folderSnapshot = await storageRef.listAll();
        folderSnapshot.prefixes.forEach(folderRef => {
          const dairyNumber = folderRef.name;
          const link = document.createElement("a");
          link.textContent = dairyNumber;
          link.href = "#";
          link.addEventListener("click", () => loadRecordFiles(dairyNumber));
          recordList.appendChild(link);
        });
      } catch (error) {
        console.error("Error fetching records:", error);
      }
    }
    async function loadRecordFiles(dairyNumber) {
      const recordList = document.getElementById("record-list");
      recordList.innerHTML = "";
      const folderRef = storage.ref(`customers/${dairyNumber}`);
      try {
        const fileSnapshot = await folderRef.listAll();
        fileSnapshot.items.forEach(fileRef => {
          const fileName = fileRef.name;
          const dateMatch = fileName.match(/(\d{4}-\d{2}-\d{2})/);
          const displayName = dateMatch ? dateMatch[0] : fileName;
          const fileLink = document.createElement("a");
          fileLink.textContent = displayName;
          fileLink.href = "#";
          fileLink.addEventListener("click", async () => {
            try {
              const url = await fileRef.getDownloadURL();
              window.open(url, "_blank");
            } catch (err) {
              console.error("Error fetching file:", err);
            }
          });
          recordList.appendChild(fileLink);
        });
        const backBtn = document.createElement("button");
        backBtn.textContent = "Back to Records";
        backBtn.className = "back-button";
        backBtn.addEventListener("click", goBackToRecords);
        recordList.appendChild(backBtn);
      } catch (err) {
        console.error("Error fetching record files:", err);
      }
    }
    function filterRecords() {
      const searchValue = document.getElementById("search-dairy-number").value.toLowerCase();
      const links = document.getElementById("record-list").getElementsByTagName("a");
      for (let link of links) {
        const txt = link.textContent || link.innerText;
        link.style.display = txt.toLowerCase().includes(searchValue) ? "" : "none";
      }
    }
    function goBack() {
      document.getElementById("form-container").style.display = "block";
      document.getElementById("record-container").style.display = "none";
    }
    function goBackToRecords() {
      loadAllRecords();
    }

    /*******************************************
     * K: DOMContentLoaded
     *******************************************/
    document.addEventListener("DOMContentLoaded", async () => {
      const fieldsToAutoCap = ["dairy-number","dairy-company","address","customer-name","farm-name","inspection-completed-by"];
      fieldsToAutoCap.forEach(autoCapitalizeInput);
      await setupDairyCompanyDatalist();
      createHealthSafetyItems("health-safety-top");
      createChecklistItems();
      createSiloChecklist();
      await createAdditionalChecks();
      await checkForCachedFormOnLoad();
      const form = document.getElementById("hygiene-checklist-form");
      form.addEventListener("input", saveFormData);
      form.addEventListener("change", saveFormData);
      uploadPendingPDFs();
    });
  </script>
</body>
</html>
