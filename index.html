<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Shed Hygiene Checklist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        /* Existing styles remain unchanged */
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
            authDomain: "dairy-farm-record-system.firebaseapp.com",
            projectId: "dairy-farm-record-system",
            storageBucket: "dairy-farm-record-system.appspot.com",
            messagingSenderId: "422124188212",
            appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const firestore = firebase.firestore();

        // Register service worker for offline functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(registration => {
                console.log('Service Worker registered with scope:', registration.scope);
            }).catch(error => {
                console.error('Service Worker registration failed:', error);
            });
        }

        // Functionality to create a new farm details record if not found
        async function saveFarmDetails(formData) {
            // Save to IndexedDB as a fallback
            saveFarmDetailsToLocal(formData);

            // Save to Firebase
            const dairyNumber = formData.get('dairy-number');
            const farmDetails = {
                dairyCompany: formData.get('dairy-company'),
                address: formData.get('address'),
                customerName: formData.get('customer-name'),
                region: formData.get('region'),
                farmName: formData.get('farm-name'),
                island: formData.get('island'),
            };
            const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
            const metadata = {
                contentType: 'application/json',
            };
            try {
                await storageRef.put(new Blob([JSON.stringify(farmDetails)], { type: 'application/json' }), metadata);
                console.log('Farm details saved successfully.');
            } catch (error) {
                console.error('Error saving farm details:', error);
            }
        }

        function saveFarmDetailsToLocal(formData) {
            const farmDetails = {
                dairyCompany: formData.get('dairy-company'),
                address: formData.get('address'),
                customerName: formData.get('customer-name'),
                region: formData.get('region'),
                farmName: formData.get('farm-name'),
                island: formData.get('island'),
            };

            const dbRequest = indexedDB.open("FarmDetailsDB", 1);
            dbRequest.onupgradeneeded = function(event) {
                const db = event.target.result;
                if (!db.objectStoreNames.contains("farmDetails")) {
                    db.createObjectStore("farmDetails", { keyPath: "dairyNumber" });
                }
            };

            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction("farmDetails", "readwrite");
                const store = transaction.objectStore("farmDetails");
                farmDetails.dairyNumber = formData.get('dairy-number');
                store.put(farmDetails);
            };
        }

        async function syncOfflineData() {
            const dbRequest = indexedDB.open("FarmDetailsDB", 1);
            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction("farmDetails", "readonly");
                const store = transaction.objectStore("farmDetails");
                const getAllRequest = store.getAll();

                getAllRequest.onsuccess = async function(event) {
                    const allFarmDetails = event.target.result;
                    for (const farmDetails of allFarmDetails) {
                        const storageRef = storage.ref(`farm_details/${farmDetails.dairyNumber}.json`);
                        const metadata = {
                            contentType: 'application/json',
                        };
                        try {
                            await storageRef.put(new Blob([JSON.stringify(farmDetails)], { type: 'application/json' }), metadata);
                            console.log(`Farm details for ${farmDetails.dairyNumber} synced successfully.`);
                        } catch (error) {
                            console.error(`Error syncing farm details for ${farmDetails.dairyNumber}:`, error);
                        }
                    }
                };
            };
        }

        window.addEventListener('online', syncOfflineData);

        async function generatePDF() {
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const dairyNumber = formData.get('dairy-number');

            await saveFarmDetails(formData); // Save farm details if not found

            const { jsPDF } = window.jspdf;
            let pdf = new jsPDF('p', 'pt', 'a4');

            // Add logo centered
            const logoUrl = "https://i.postimg.cc/htZPjx5g/logo-89.png";
            const logo = await fetch(logoUrl).then((res) => res.blob());
            const reader = new FileReader();
            reader.readAsDataURL(logo);
            reader.onload = function () {
                const imgData = reader.result;
                pdf.addImage(imgData, 'PNG', 180, 40, 240, 60);

                pdf.setFontSize(12);
                pdf.setTextColor('#000000');
                pdf.setFont('helvetica', 'bold');
                pdf.text('Farm Details:', 40, 130);

                pdf.setFont('helvetica', 'normal');
                pdf.text(`Dairy Company: ${formData.get('dairy-company')}`, 40, 150);
                pdf.text(`Dairy Number: ${formData.get('dairy-number')}`, 40, 165);
                pdf.text(`Address: ${formData.get('address')}`, 40, 180);
                pdf.text(`Customer Name: ${formData.get('customer-name')}`, 40, 195);
                pdf.text(`Region: ${formData.get('region')}`, 40, 210);
                pdf.text(`Farm Name: ${formData.get('farm-name')}`, 40, 225);
                pdf.text(`Island: ${formData.get('island')}`, 40, 240);
                pdf.text(`Visit Date: ${formData.get('visit-date')}`, 40, 255);
                pdf.text(`Visit Type: ${formData.get('visit-type')}`, 40, 270);
                pdf.text(`Inspection Start Time: ${formData.get('inspection-start-time')}`, 40, 285);
                pdf.text(`Inspection End Time: ${formData.get('inspection-end-time')}`, 40, 300);
                pdf.text(`Inspection Completed By: ${formData.get('inspection-completed-by')}`, 40, 315);
                pdf.text(`Call Type: ${formData.get('call-type')}`, 40, 330);

                // Checklist Items Section
                const checklistItemsDiv = document.getElementById('checklist-items').children;
                const checklistTable = [];
                const photos = [];

                for (let item of checklistItemsDiv) {
                    const itemName = item.querySelector('label').textContent;
                    const status = item.querySelector('select').value;
                    let comments = item.querySelector('input[type="text"]').value;
                    const imageFile = item.querySelector('input[type="file"]').files[0];

                    if (status === 'attention-required') {
                        comments += " (See attached photo below)";
                    }

                    checklistTable.push([itemName, status, comments]);

                    if (imageFile) {
                        const imgReader = new FileReader();
                        imgReader.onload = function (event) {
                            photos.push({
                                imageData: event.target.result,
                                title: itemName
                            });
                        };
                        imgReader.readAsDataURL(imageFile);
                    }
                }

                // Generate checklist items table
                pdf.autoTable({
                    startY: 350,
                    head: [['Item', 'Status', 'Comments']],
                    body: checklistTable,
                    styles: {
                        fontSize: 10,
                        cellPadding: 5,
                    },
                    headStyles: {
                        fillColor: '#002B5C',
                        textColor: '#FFFFFF'
                    }
                });

                // Add temperature data
                let currentY = pdf.lastAutoTable.finalY + 20;

                pdf.setFont('helvetica', 'bold');
                pdf.text('Temperature Measurements:', 40, currentY);
                currentY += 20;

                pdf.setFont('helvetica', 'normal');
                pdf.text(`Hot Water Temp: ${formData.get('hot-water-temp')} °C`, 40, currentY);
                currentY += 15;
                pdf.text(`Time Taken: ${formData.get('hot-water-time')}`, 40, currentY);
                currentY += 20;

                pdf.text(`Milk Temp: ${formData.get('milk-temp')} °C`, 40, currentY);
                currentY += 15;
                pdf.text(`Time Taken: ${formData.get('milk-time')}`, 40, currentY);
                currentY += 20;

                // Add photos after the checklist
                setTimeout(() => {
                    let photoY = pdf.lastAutoTable.finalY + 120; // Start placing photos after the last auto table
                    
                    photos.forEach((photo, index) => {
                        if (photoY > 700) {
                            // If we're getting close to the end of the page, add a new page
                            pdf.addPage();
                            photoY = 60; // Reset Y position for the new page
                        }
                        
                        pdf.addImage(photo.imageData, 'JPEG', 40, photoY, 250, 200); // Adjust the size to fit more photos
                        pdf.setFontSize(12);
                        pdf.text(photo.title, 40, photoY - 10); // Add the title above the photo
                        photoY += 220; // Move Y position down for the next photo (image height + spacing)
                    });

                    // Save PDF locally and sync to Firebase when back online
                    const pdfBlob = pdf.output('blob');
                    savePDFOffline(dairyNumber, pdfBlob);

                    const timestamp = new Date().toISOString().split('T')[0];
                    const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
                    const storageRef = storage.ref(`customers/${dairyNumber}/${fileName}`);

                    storageRef.put(pdfBlob).then(() => {
                        console.log('PDF uploaded successfully');
                    }).catch((error) => {
                        console.error('Error uploading PDF:', error);
                    });

                    pdf.save('Dairy_Shed_Hygiene_Checklist.pdf');
                }, 1000);
            };
        }

        function savePDFOffline(dairyNumber, pdfBlob) {
            const dbRequest = indexedDB.open("FarmDetailsDB", 1);
            dbRequest.onupgradeneeded = function(event) {
                const db = event.target.result;
                if (!db.objectStoreNames.contains("pdfRecords")) {
                    db.createObjectStore("pdfRecords", { keyPath: "fileName" });
                }
            };

            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction("pdfRecords", "readwrite");
                const store = transaction.objectStore("pdfRecords");
                const timestamp = new Date().toISOString().split('T')[0];
                const fileName = `${dairyNumber}-form-${timestamp}.pdf`;

                store.put({ fileName: fileName, pdfBlob: pdfBlob });
            };
        }

        window.addEventListener('online', async () => {
            const dbRequest = indexedDB.open("FarmDetailsDB", 1);
            dbRequest.onsuccess = async function(event) {
                const db = event.target.result;
                const transaction = db.transaction("pdfRecords", "readonly");
                const store = transaction.objectStore("pdfRecords");
                const getAllRequest = store.getAll();

                getAllRequest.onsuccess = async function(event) {
                    const allPDFRecords = event.target.result;
                    for (const record of allPDFRecords) {
                        const storageRef = storage.ref(`customers/${record.fileName}`);
                        try {
                            await storageRef.put(record.pdfBlob);
                            console.log(`PDF ${record.fileName} synced successfully.`);
                        } catch (error) {
                            console.error(`Error syncing PDF ${record.fileName}:`, error);
                        }
                    }
                };
            };
        });

        document.addEventListener("DOMContentLoaded", () => {
            createChecklistItems();
        });

        function createChecklistItems() {
            // Existing function remains unchanged
        }

        function viewRecords() {
            // Existing function remains unchanged
        }

        function loadAllRecords() {
            // Existing function remains unchanged
        }

        function loadRecordFiles(dairyNumber) {
            // Existing function remains unchanged
        }

        function goBack() {
            // Existing function remains unchanged
        }

        function goBackToRecords() {
            // Existing function remains unchanged
        }
    </script>
</body>

</html>
