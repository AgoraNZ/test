<!DOCTYPE html>
<html lang="en">

<head>
    <!-- 
    PART 1: META & STYLES
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Shed Hygiene Checklist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">

    <style>
        body {
            background-color: #002B5C;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }

        .container {
            background-color: #002B5C;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
        }

        h1,
        h2 {
            color: #a7ab01;
            text-align: center;
        }

        h1 {
            margin-bottom: 40px;
        }

        label {
            margin-top: 10px;
        }

        button {
            background-color: #FF851B;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            border-radius: 5px;
        }

        button:hover {
            background-color: #FF4136;
        }

        .checklist-item {
            margin-bottom: 30px;
        }

        .form-control,
        .form-select {
            margin-top: 5px;
        }

        .version {
            text-align: center;
            margin-top: 20px;
            color: #FFFFFF;
            font-size: 12px;
        }

        .logo {
            display: block;
            margin: 0 auto 20px;
            width: 250px;
        }

        .record-container {
            background-color: #FFFFFF;
            color: #000000;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            max-width: 1000px;
            width: 100%;
            margin: 20px auto;
        }

        .record-container h2 {
            color: #002B5C;
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-list a {
            text-decoration: none;
            color: #007bff;
            display: block;
            margin-bottom: 10px;
        }

        .back-button {
            margin-top: 20px;
            background-color: #002B5C;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .search-container {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <!-- 
    PART 2: MAIN FORM CONTAINER
    -->
    <div class="container" id="form-container">
        <img src="https://i.postimg.cc/htZPjx5g/logo-89.png" alt="Logo" class="logo">
        <h1>Dairy Shed Hygiene Checklist</h1>

        <form id="hygiene-checklist-form">
            <!-- 
            SECTION: Farm Details
            -->
            <div class="section mb-4">
                <h2>Farm Details</h2>

                <label for="dairy-number">Dairy Number:</label>
                <input type="text"
                       class="form-control"
                       id="dairy-number"
                       name="dairy-number"
                       onblur="fetchFarmDetails(); checkOrCreateFormRecord();"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="dairy-company">Dairy Company:</label>
                <input type="text"
                       class="form-control"
                       id="dairy-company"
                       name="dairy-company"
                       list="dairy-company-list"
                       placeholder="Type or select..."
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">
                <datalist id="dairy-company-list"></datalist>

                <label for="address">Address:</label>
                <input type="text"
                       class="form-control"
                       id="address"
                       name="address"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="customer-name">Customer Name:</label>
                <input type="text"
                       class="form-control"
                       id="customer-name"
                       name="customer-name"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="region">Region:</label>
                <select id="region" name="region" class="form-select">
                    <option value="northland">Northland</option>
                    <option value="auckland">Auckland</option>
                    <option value="waikato">Waikato</option>
                    <option value="bay-of-plenty">Bay of Plenty</option>
                    <option value="gisborne">Gisborne</option>
                    <option value="hawkes-bay">Hawke's Bay</option>
                    <option value="taranaki">Taranaki</option>
                    <option value="manawatu-wanganui">Manawatu-Wanganui</option>
                    <option value="wellington">Wellington</option>
                    <option value="nelson">Nelson</option>
                    <option value="marlborough">Marlborough</option>
                    <option value="west-coast">West Coast</option>
                    <option value="canterbury">Canterbury</option>
                    <option value="otago">Otago</option>
                    <option value="southland">Southland</option>
                </select>

                <label for="farm-name">Farm Name:</label>
                <input type="text"
                       class="form-control"
                       id="farm-name"
                       name="farm-name"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="island">Island:</label>
                <select id="island" name="island" class="form-select">
                    <option value="north-island">North Island</option>
                    <option value="south-island">South Island</option>
                </select>

                <label for="visit-date">Visit Date:</label>
                <input type="date"
                       class="form-control"
                       id="visit-date"
                       name="visit-date">

                <label for="visit-type">Visit Type:</label>
                <input type="text"
                       class="form-control"
                       id="visit-type"
                       name="visit-type"
                       value="Milking Plant & Milk Vat Check"
                       readonly
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="inspection-start-time">Inspection Start Time:</label>
                <input type="time"
                       class="form-control"
                       id="inspection-start-time"
                       name="inspection-start-time">

                <label for="inspection-end-time">Inspection End Time:</label>
                <input type="time"
                       class="form-control"
                       id="inspection-end-time"
                       name="inspection-end-time">

                <label for="inspection-completed-by">Inspection Completed By:</label>
                <input type="text"
                       class="form-control"
                       id="inspection-completed-by"
                       name="inspection-completed-by"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="call-type">Call Type:</label>
                <select id="call-type" name="call-type" class="form-select">
                    <option value="alert">Alert</option>
                    <option value="grade-call">Grade Call</option>
                    <option value="regular-scheduled-visit" selected>Regular Scheduled Visit</option>
                </select>
            </div>

            <!-- 
            Health & Safety
            -->
            <div class="section mb-4">
                <h2>Health & Safety</h2>
                <div id="health-safety-top"></div>
            </div>

            <!-- 
            Plant Checklist
            -->
            <div class="section mb-4">
                <h2>Plant Checklist</h2>
                <div id="plant-checklist"></div>
            </div>

            <!-- 
            Silo Checklist
            -->
            <div class="section mb-4">
                <h2>Silo Checklist</h2>
                <div id="silo-checklist"></div>
            </div>

            <!-- 
            Additional Checks
            -->
            <div class="section mb-4">
                <h2>Additional Checks</h2>
                <div id="additional-checks"></div>
            </div>

            <!-- 
            Temperature Measurements
            -->
            <div class="section mb-4">
                <h2>Temperature Measurements</h2>
                <div class="checklist-item">
                    <label for="hot-water-temp">Hot Water Temp (Â°C):</label>
                    <input type="text"
                           class="form-control"
                           id="hot-water-temp"
                           name="hot-water-temp"
                           step="0.1"
                           autocapitalize="words"
                           autocorrect="off"
                           spellcheck="false">

                    <label for="hot-water-time">Time Taken:</label>
                    <input type="time" class="form-control" id="hot-water-time" name="hot-water-time">
                </div>
                <div class="checklist-item">
                    <label for="milk-temp">Milk Temp (Â°C):</label>
                    <input type="text"
                           class="form-control"
                           id="milk-temp"
                           name="milk-temp"
                           step="0.1"
                           autocapitalize="words"
                           autocorrect="off"
                           spellcheck="false">

                    <label for="milk-time">Time Taken:</label>
                    <input type="time" class="form-control" id="milk-time" name="milk-time">
                </div>
            </div>

            <button type="button" onclick="generatePDF()">Generate PDF</button>
            <button type="button" onclick="viewRecords()">View All Records</button>
        </form>
        <div class="version">Version 5.4</div>
    </div>

    <!-- 
    RECORDS VIEW
    -->
    <div id="record-container" class="record-container" style="display: none;">
        <h2>All Dairy Shed Hygiene Records</h2>
        <div class="search-container">
            <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number" oninput="filterRecords()">
        </div>
        <div id="record-list" class="record-list"></div>
        <button class="back-button" onclick="goBack()">Back to Checklist</button>
    </div>

    <!-- 
    PART 4: SCRIPTS
    -->
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- Dexie -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        /*******************************************
         * A: FIREBASE & DEXIE INIT
         *******************************************/
        const { jsPDF } = window.jspdf;
        const firebaseConfig = {
            apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
            authDomain: "dairy-farm-record-system.firebaseapp.com",
            projectId: "dairy-farm-record-system",
            storageBucket: "dairy-farm-record-system.appspot.com",
            messagingSenderId: "422124188212",
            appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
        };
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const firestore = firebase.firestore();

        const db = new Dexie("OfflineData");
        db.version(3).stores({
            forms: "dairyNumber",
            dairyCompanies: "++id, name",
            teatSprayRatios: "++id, ratio"
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registered:', reg.scope))
                .catch(err => console.error('SW registration failed:', err));
        }

        /*******************************************
         * B: DAIRY COMPANY DATALIST
         *******************************************/
        async function setupDairyCompanyDatalist() {
            const defaultCompanies = [
                "Fonterra",
                "Dairy Goat Co-op",
                "Green Valley Dairies",
                "Maui Milk",
                "Oceania",
                "OFI",
                "Synlait Milk LTD",
                "Tatua"
            ];
            const userCompanies = await db.dairyCompanies.toArray();
            const allCompanies = [...defaultCompanies];

            userCompanies.forEach(u => {
                if (!allCompanies.includes(u.name)) allCompanies.push(u.name);
            });

            const datalist = document.getElementById('dairy-company-list');
            datalist.innerHTML = "";
            allCompanies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                datalist.appendChild(opt);
            });

            const dairyCompanyInput = document.getElementById('dairy-company');
            dairyCompanyInput.addEventListener('blur', async () => {
                const typedValue = dairyCompanyInput.value.trim();
                if (typedValue && !allCompanies.includes(typedValue)) {
                    await db.dairyCompanies.add({ name: typedValue });
                    allCompanies.push(typedValue);
                    const newOpt = document.createElement('option');
                    newOpt.value = typedValue;
                    datalist.appendChild(newOpt);
                }
            });
        }

        /*******************************************
         * C: FETCH FARM DETAILS FROM FIREBASE
         *******************************************/
        async function fetchFarmDetails() {
            const dairyNumber = document.getElementById('dairy-number').value.trim();
            if (!dairyNumber) return;
            const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
            try {
                const url = await storageRef.getDownloadURL();
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch the farm details');
                const data = await response.json();
                if (data) {
                    document.getElementById('dairy-company').value = data.dairyCompany || '';
                    document.getElementById('address').value = data.address || '';
                    document.getElementById('customer-name').value = data.customerName || '';
                    document.getElementById('region').value = data.region || '';
                    document.getElementById('farm-name').value = data.farmName || '';
                    document.getElementById('island').value = data.island || '';
                }
            } catch (error) {
                console.log('No farm details found or error fetching from Firebase.');
            }
        }

        /*******************************************
         * D: CHECK/CREATE FORM RECORD
         *******************************************/
        async function checkOrCreateFormRecord() {
            const dairyNumber = document.getElementById('dairy-number').value.trim();
            if (!dairyNumber) return;
            let existing = await db.forms.get(dairyNumber);
            if (!existing) {
                await db.forms.put({
                    dairyNumber: dairyNumber,
                    formData: {},
                    creationTime: Date.now()
                });
            }
        }

        /*******************************************
         * E: CREATE CHECKLIST ITEMS
         *******************************************/
        // All items are split: some go under Plant Checklist, some under Silo Checklist

        // Plant Items
        const plantItems = [
            "Pulsator Airline",
            "Long Bend Elbows",
            "Automatic Cup and Remover",
            "Diaphragm",
            "Receiving Can",
            "Sanitary Trap",
            "Main Milk Line",
            "Milk Line Seals in Good Condition",
            "Stainless Droppers",
            "Long Milk Rubber",
            "Liner",
            "Cluster",
            "Cluster Seal",
            "Cluster Button",
            "Non Return Valve at Milk Pump",
            "Milk Pump",
            "Filter Housing",
            "Plate Cooler",
            "Interceptor",
            "Receiver Airline",
            "Flushing Pulsator",
            "Air Purge Valve",
            "Vacuum Level",
            "Main Airline",
            "Plant Drainage - Milk Pump",
            "Plant Drainage - Filter/s",
            "Plant Drainage - Plate Cooler",
            "Plant Drainage - Vat Entry",
            "Plant Wash Tap",
            "Wash Jetters",
            "Centre Gland",
            "Test Bucket"
        ];

        // Silo Items
        const siloItems = [
            "Inlet Valve",
            "Non-Return Valve",
            "Spray Ball",
            "Agitator",
            "Silo Door",
            "Manhole Seal",
            "Vat Outlet",
            "Walls in Silo"
        ];

        // For 'Milk in Vat' auto-fill (if status = "not-checked")
        const itemsToAutoFill = [
            "Inlet Valve",
            "Non-Return Valve",
            "Spray Ball",
            "Agitator",
            "Silo Door",
            "Manhole Seal",
            "Vat Outlet",
            "Walls in Silo"
        ];

        function createPlantChecklistItems() {
            const container = document.getElementById('plant-checklist');
            container.innerHTML = '';

            plantItems.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('checklist-item');

                const label = document.createElement('label');
                label.textContent = item;
                itemContainer.appendChild(label);

                const statusSelect = document.createElement('select');
                statusSelect.classList.add('form-select');
                statusSelect.name = `status-${item}`;
                statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
                itemContainer.appendChild(statusSelect);

                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.classList.add('form-control');
                commentsInput.name = `comments-${item}`;
                commentsInput.placeholder = 'Comments';
                commentsInput.setAttribute('autocapitalize','words');
                commentsInput.setAttribute('autocorrect','off');
                commentsInput.setAttribute('spellcheck','false');
                itemContainer.appendChild(commentsInput);

                // Image fields
                const imageUpload1 = document.createElement('input');
                imageUpload1.type = 'file';
                imageUpload1.classList.add('form-control', 'image-upload');
                imageUpload1.style.display = 'none';
                itemContainer.appendChild(imageUpload1);

                const imageUpload2 = document.createElement('input');
                imageUpload2.type = 'file';
                imageUpload2.classList.add('form-control', 'image-upload');
                imageUpload2.style.display = 'none';
                itemContainer.appendChild(imageUpload2);

                statusSelect.addEventListener('change', () => {
                    if (statusSelect.value === 'attention-required') {
                        imageUpload1.style.display = 'block';
                        imageUpload2.style.display = 'block';
                    } else {
                        imageUpload1.style.display = 'none';
                        imageUpload2.style.display = 'none';
                    }
                });

                container.appendChild(itemContainer);
            });
        }

        function createSiloChecklistItems() {
            const container = document.getElementById('silo-checklist');
            container.innerHTML = '';

            siloItems.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('checklist-item');

                const label = document.createElement('label');
                label.textContent = item;
                itemContainer.appendChild(label);

                const statusSelect = document.createElement('select');
                statusSelect.classList.add('form-select');
                statusSelect.name = `status-${item}`;
                statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
                itemContainer.appendChild(statusSelect);

                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.classList.add('form-control');
                commentsInput.name = `comments-${item}`;
                commentsInput.placeholder = 'Comments';
                commentsInput.setAttribute('autocapitalize','words');
                commentsInput.setAttribute('autocorrect','off');
                commentsInput.setAttribute('spellcheck','false');
                itemContainer.appendChild(commentsInput);

                // Image fields
                const imageUpload1 = document.createElement('input');
                imageUpload1.type = 'file';
                imageUpload1.classList.add('form-control', 'image-upload');
                imageUpload1.style.display = 'none';
                itemContainer.appendChild(imageUpload1);

                const imageUpload2 = document.createElement('input');
                imageUpload2.type = 'file';
                imageUpload2.classList.add('form-control', 'image-upload');
                imageUpload2.style.display = 'none';
                itemContainer.appendChild(imageUpload2);

                statusSelect.addEventListener('change', () => {
                    if (statusSelect.value === 'attention-required') {
                        imageUpload1.style.display = 'block';
                        imageUpload2.style.display = 'block';
                    } else {
                        imageUpload1.style.display = 'none';
                        imageUpload2.style.display = 'none';
                    }

                    // "Milk in Vat" auto-fill if not-checked
                    if (statusSelect.value === 'not-checked' && itemsToAutoFill.includes(item)) {
                        commentsInput.value = "Milk in Vat";
                    } else if (commentsInput.value === "Milk in Vat") {
                        commentsInput.value = "";
                    }
                });

                container.appendChild(itemContainer);
            });
        }

        /*******************************************
         * F: ADDITIONAL CHECKS
         *******************************************/
        async function createAdditionalChecks() {
            const container = document.getElementById('additional-checks');
            container.innerHTML = '';

            // Teat Spray
            const teatSprayContainer = document.createElement('div');
            teatSprayContainer.classList.add('checklist-item');

            const labelTeat = document.createElement('label');
            labelTeat.textContent = "Teat Spray Check";
            teatSprayContainer.appendChild(labelTeat);

            const statusSelectTeat = document.createElement('select');
            statusSelectTeat.classList.add('form-select');
            statusSelectTeat.name = "status-teat-spray-check";
            statusSelectTeat.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
            teatSprayContainer.appendChild(statusSelectTeat);

            const commentsInputTeat = document.createElement('input');
            commentsInputTeat.type = 'text';
            commentsInputTeat.classList.add('form-control');
            commentsInputTeat.name = "comments-teat-spray-check";
            commentsInputTeat.placeholder = 'Comments';
            commentsInputTeat.setAttribute('autocapitalize','words');
            commentsInputTeat.setAttribute('autocorrect','off');
            commentsInputTeat.setAttribute('spellcheck','false');
            teatSprayContainer.appendChild(commentsInputTeat);

            const imageUploadTeat1 = document.createElement('input');
            imageUploadTeat1.type = 'file';
            imageUploadTeat1.classList.add('form-control', 'image-upload');
            imageUploadTeat1.style.display = 'none';
            teatSprayContainer.appendChild(imageUploadTeat1);

            const imageUploadTeat2 = document.createElement('input');
            imageUploadTeat2.type = 'file';
            imageUploadTeat2.classList.add('form-control', 'image-upload');
            imageUploadTeat2.style.display = 'none';
            teatSprayContainer.appendChild(imageUploadTeat2);

            statusSelectTeat.addEventListener('change', () => {
                if (statusSelectTeat.value === 'attention-required') {
                    imageUploadTeat1.style.display = 'block';
                    imageUploadTeat2.style.display = 'block';
                } else {
                    imageUploadTeat1.style.display = 'none';
                    imageUploadTeat2.style.display = 'none';
                }
            });

            // Single-line editable ratio
            const ratioLabel = document.createElement('label');
            ratioLabel.textContent = "Teat Spray Dilution Ratio:";
            teatSprayContainer.appendChild(ratioLabel);

            const ratioInput = document.createElement('input');
            ratioInput.type = 'text';
            ratioInput.classList.add('form-control');
            ratioInput.name = "teat-spray-dilution";
            ratioInput.id = "teat-dilution";
            ratioInput.setAttribute('list', 'teat-dilution-list');
            ratioInput.placeholder = "Type or select e.g. 1:5";
            ratioInput.setAttribute('autocapitalize','words');
            ratioInput.setAttribute('autocorrect','off');
            ratioInput.setAttribute('spellcheck','false');
            teatSprayContainer.appendChild(ratioInput);

            const ratioDataList = document.createElement('datalist');
            ratioDataList.id = 'teat-dilution-list';
            teatSprayContainer.appendChild(ratioDataList);

            // Load existing ratios
            const existingRatios = await db.teatSprayRatios.toArray();
            const allRatios = ["1:4"];
            existingRatios.forEach(r => {
                if (!allRatios.includes(r.ratio)) {
                    allRatios.push(r.ratio);
                }
            });
            ratioDataList.innerHTML = "";
            allRatios.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                ratioDataList.appendChild(opt);
            });

            ratioInput.addEventListener('blur', async () => {
                const typedRatio = ratioInput.value.trim();
                if (typedRatio && !allRatios.includes(typedRatio)) {
                    await db.teatSprayRatios.add({ ratio: typedRatio });
                    allRatios.push(typedRatio);
                    const newOpt = document.createElement('option');
                    newOpt.value = typedRatio;
                    ratioDataList.appendChild(newOpt);
                }
            });

            container.appendChild(teatSprayContainer);

            // Chemical Check
            const chemicalContainer = document.createElement('div');
            chemicalContainer.classList.add('checklist-item');

            const labelChemical = document.createElement('label');
            labelChemical.textContent = "Chemical Check";
            chemicalContainer.appendChild(labelChemical);

            const statusSelectChemical = document.createElement('select');
            statusSelectChemical.classList.add('form-select');
            statusSelectChemical.name = "status-chemical-check";
            statusSelectChemical.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
            chemicalContainer.appendChild(statusSelectChemical);

            const commentsInputChemical = document.createElement('input');
            commentsInputChemical.type = 'text';
            commentsInputChemical.classList.add('form-control');
            commentsInputChemical.name = "comments-chemical-check";
            commentsInputChemical.placeholder = 'Comments';
            commentsInputChemical.setAttribute('autocapitalize','words');
            commentsInputChemical.setAttribute('autocorrect','off');
            commentsInputChemical.setAttribute('spellcheck','false');
            chemicalContainer.appendChild(commentsInputChemical);

            const imageUploadChem1 = document.createElement('input');
            imageUploadChem1.type = 'file';
            imageUploadChem1.classList.add('form-control', 'image-upload');
            imageUploadChem1.style.display = 'none';
            chemicalContainer.appendChild(imageUploadChem1);

            const imageUploadChem2 = document.createElement('input');
            imageUploadChem2.type = 'file';
            imageUploadChem2.classList.add('form-control', 'image-upload');
            imageUploadChem2.style.display = 'none';
            chemicalContainer.appendChild(imageUploadChem2);

            statusSelectChemical.addEventListener('change', () => {
                if (statusSelectChemical.value === 'attention-required') {
                    imageUploadChem1.style.display = 'block';
                    imageUploadChem2.style.display = 'block';
                } else {
                    imageUploadChem1.style.display = 'none';
                    imageUploadChem2.style.display = 'none';
                }
            });

            container.appendChild(chemicalContainer);
        }

        /*******************************************
         * G: ONE-HOUR CACHING & PROMPT ON PAGE LOAD
         *******************************************/
        async function cleanupExpiredForms() {
            const oneHour = 60 * 60 * 1000;
            const now = Date.now();
            const allForms = await db.forms.toArray();
            for (let f of allForms) {
                if (now - f.creationTime > oneHour) {
                    await db.forms.delete(f.dairyNumber);
                }
            }
        }

        async function checkForExistingForm() {
            await cleanupExpiredForms();
            const allForms = await db.forms.toArray();
            if (allForms.length === 1) {
                const existing = allForms[0];
                const confirmContinue = confirm(`Would you like to continue form #${existing.dairyNumber}?`);
                if (confirmContinue) {
                    loadFormDataFromRecord(existing);
                } else {
                    await db.forms.delete(existing.dairyNumber);
                    clearEntireForm();
                }
            }
        }

        /*******************************************
         * H: LOAD + CLEAR FORM
         *  -- KEY FIX: We match items by "itemName" so data reappears
         *******************************************/
        function loadFormDataFromRecord(record) {
            // Basic field data
            const data = record.formData || {};
            // Put the Dairy Number into the input
            document.getElementById('dairy-number').value = record.dairyNumber;

            // For everything except the checklist items
            for (let key in data) {
                if (key === 'checklistItems') continue;
                const field = document.getElementById(key) || document.getElementsByName(key)[0];
                if (field) {
                    field.value = data[key];
                }
            }

            // Now handle the checklist items
            if (data.checklistItems) {
                // Grab ALL items from these sections
                const containers = [
                    ...document.getElementById('health-safety-top').children,
                    ...document.getElementById('plant-checklist').children,
                    ...document.getElementById('silo-checklist').children,
                    ...document.getElementById('additional-checks').children
                ];

                // For each container item, find the matching itemName in the saved data
                containers.forEach(itemEl => {
                    const labelEl = itemEl.querySelector('label');
                    if (!labelEl) return;
                    const itemName = labelEl.textContent;
                    // Find the object from data.checklistItems
                    const found = data.checklistItems.find(ci => ci.itemName === itemName);
                    if (found) {
                        const statusSelect = itemEl.querySelector('select');
                        const commentsInput = itemEl.querySelector('input[type="text"]');
                        if (statusSelect) {
                            statusSelect.value = found.status;
                            // Trigger 'change' so photo fields appear if needed
                            statusSelect.dispatchEvent(new Event('change'));
                        }
                        if (commentsInput) {
                            commentsInput.value = found.comments;
                        }
                    }
                });
            }
        }

        function clearEntireForm() {
            document.getElementById('hygiene-checklist-form').reset();
            const imageUploads = document.querySelectorAll('.image-upload');
            imageUploads.forEach(inp => { inp.style.display = 'none'; });
        }

        /*******************************************
         * I: SAVE FORM DATA
         *******************************************/
        async function saveFormData() {
            const dairyNumber = document.getElementById('dairy-number').value.trim();
            if (!dairyNumber) return;

            let record = await db.forms.get(dairyNumber);
            if (!record) {
                record = {
                    dairyNumber: dairyNumber,
                    formData: {},
                    creationTime: Date.now()
                };
            }

            // Gather data from the form
            const form = document.getElementById('hygiene-checklist-form');
            const formDataObj = new FormData(form);
            const data = Object.fromEntries(formDataObj.entries());

            // Build the array of checklist items
            const containersToCheck = [
                document.getElementById('health-safety-top').children,
                document.getElementById('plant-checklist').children,
                document.getElementById('silo-checklist').children,
                document.getElementById('additional-checks').children
            ];
            const checklistItemsData = [];
            for (let container of containersToCheck) {
                for (let itemEl of container) {
                    const labelEl = itemEl.querySelector('label');
                    if (!labelEl) continue;
                    const itemName = labelEl.textContent;
                    const statusSelect = itemEl.querySelector('select');
                    let status = '';
                    let comments = '';
                    if (statusSelect) status = statusSelect.value;
                    const commentsInput = itemEl.querySelector('input[type="text"]');
                    if (commentsInput) comments = commentsInput.value;
                    checklistItemsData.push({ itemName, status, comments });
                }
            }
            data.checklistItems = checklistItemsData;
            record.formData = data;

            // Save to Dexie
            await db.forms.put(record);
        }

        /*******************************************
         * J: SAVE FARM DETAILS & GENERATE PDF
         *******************************************/
        async function saveFarmDetailsToFirebase(fd) {
            const dairyNumber = fd.get('dairy-number') || '';
            if (!dairyNumber) return;

            const farmDetails = {
                dairyCompany: fd.get('dairy-company') || '',
                address: fd.get('address') || '',
                customerName: fd.get('customer-name') || '',
                region: fd.get('region') || '',
                farmName: fd.get('farm-name') || '',
                island: fd.get('island') || ''
            };

            const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
            const metadata = { contentType: 'application/json' };
            try {
                await storageRef.put(
                    new Blob([JSON.stringify(farmDetails)], { type: 'application/json' }),
                    metadata
                );
                console.log('Farm details saved to Firebase successfully.');
            } catch (err) {
                console.error('Error saving farm details to Firebase:', err);
            }
        }

        async function generatePDF() {
            const dairyNumber = document.getElementById('dairy-number').value.trim();
            if (!dairyNumber) {
                alert("Please enter a Dairy Number.");
                return;
            }

            // Save farm details for future auto-fill
            const form = document.getElementById('hygiene-checklist-form');
            const fd = new FormData(form);
            await saveFarmDetailsToFirebase(fd);

            // Build the item data (including photos)
            const containers = [
                ...document.getElementById('health-safety-top').children,
                ...document.getElementById('plant-checklist').children,
                ...document.getElementById('silo-checklist').children,
                ...document.getElementById('additional-checks').children
            ];
            const itemDataArray = [];
            containers.forEach(itemEl => {
                const labelEl = itemEl.querySelector('label');
                if (!labelEl) return;
                const itemName = labelEl.textContent;
                const statusSelect = itemEl.querySelector('select');
                const status = statusSelect ? statusSelect.value : '';
                let commentsInput = itemEl.querySelector('input[type="text"]');
                let comments = commentsInput ? commentsInput.value : '';

                // If item is "Teat Spray Check", also fetch ratio
                if (itemName === "Teat Spray Check") {
                    const ratioField = itemEl.querySelector('#teat-dilution');
                    if (ratioField && ratioField.value.trim()) {
                        comments += comments
                          ? ` | Ratio: ${ratioField.value}`
                          : `Ratio: ${ratioField.value}`;
                    }
                }

                // Gather images
                const imgs = itemEl.querySelectorAll('input[type="file"]');
                const imageFiles = [];
                if (imgs.length > 0) {
                    if (imgs[0].files[0]) imageFiles.push(imgs[0].files[0]);
                    if (imgs[1].files[0]) imageFiles.push(imgs[1].files[0]);
                }

                // If attention-required + images => add note
                if (status === 'attention-required' && imageFiles.length > 0) {
                    comments += comments
                      ? ` (Photo Attached Below)`
                      : `(Photo Attached Below)`;
                }

                itemDataArray.push({ itemName, status, comments, imageFiles });
            });

            // Convert images asynchronously, then finalize PDF
            let pendingImages = 0;
            let photoStore = []; 
            itemDataArray.forEach(obj => {
                if (obj.imageFiles.length > 0) {
                    const photoObj = { itemName: obj.itemName, images: [] };
                    obj.imageFiles.forEach((file, idx) => {
                        pendingImages++;
                        const reader = new FileReader();
                        reader.onload = evt => {
                            photoObj.images[idx] = evt.target.result;
                            pendingImages--;
                            if (pendingImages === 0) finalizePDF();
                        };
                        reader.readAsDataURL(file);
                    });
                    photoStore.push(photoObj);
                }
            });

            // If no images, finalize immediately
            if (pendingImages === 0) finalizePDF();

            async function finalizePDF() {
                const pdf = new jsPDF('p', 'pt', 'a4');
                let currentY = 80;

                // Attempt to load the logo
                try {
                    const logoRef = storage.ref('Picture3.jpg');
                    const logoUrl = await logoRef.getDownloadURL();
                    const logoBlob = await fetch(logoUrl).then(res => res.blob());
                    const logoBase64 = await blobToBase64(logoBlob);

                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const imgProps = pdf.getImageProperties(logoBase64);
                    const imgWidth = pageWidth - 80;
                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                    const x = (pageWidth - imgWidth) / 2;
                    pdf.addImage(logoBase64, 'JPEG', x, 40, imgWidth, imgHeight);
                    pdf.setFontSize(12);
                    pdf.setTextColor('#000000');
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Farm Details:', 40, imgHeight + 60);
                    currentY = imgHeight + 80;
                } catch (err) {
                    console.error('No logo found or error retrieving logo. Generating PDF without logo.');
                    pdf.setFontSize(12);
                    pdf.setTextColor('#000000');
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Farm Details:', 40, currentY);
                    currentY += 20;
                }

                // Insert form fields (basic farm info)
                pdf.setFont('helvetica', 'normal');
                function addLine(text) {
                    pdf.text(text, 40, currentY);
                    currentY += 15;
                }
                addLine(`Dairy Company: ${fd.get('dairy-company') || ''}`);
                addLine(`Dairy Number: ${fd.get('dairy-number') || ''}`);
                addLine(`Address: ${fd.get('address') || ''}`);
                addLine(`Customer Name: ${fd.get('customer-name') || ''}`);
                addLine(`Region: ${fd.get('region') || ''}`);
                addLine(`Farm Name: ${fd.get('farm-name') || ''}`);
                addLine(`Island: ${fd.get('island') || ''}`);
                addLine(`Visit Date: ${fd.get('visit-date') || ''}`);
                addLine(`Visit Type: ${fd.get('visit-type') || ''}`);
                addLine(`Inspection Start Time: ${fd.get('inspection-start-time') || ''}`);
                addLine(`Inspection End Time: ${fd.get('inspection-end-time') || ''}`);
                addLine(`Inspection Completed By: ${fd.get('inspection-completed-by') || ''}`);
                addLine(`Call Type: ${fd.get('call-type') || ''}`);
                currentY += 15;

                // Create table of items
                const tableData = itemDataArray.map(obj => [obj.itemName, obj.status, obj.comments]);
                pdf.autoTable({
                    startY: currentY,
                    head: [['Item', 'Status', 'Comments']],
                    body: tableData,
                    styles: { fontSize: 10, cellPadding: 5 },
                    headStyles: { fillColor: '#002B5C', textColor: '#FFFFFF' }
                });
                let afterTableY = pdf.lastAutoTable.finalY + 20;

                // Temperature Measurements
                pdf.setFont('helvetica', 'bold');
                pdf.text('Temperature Measurements:', 40, afterTableY);
                afterTableY += 20;
                pdf.setFont('helvetica', 'normal');
                const hotWaterTemp = fd.get('hot-water-temp') || '';
                const hotWaterTime = fd.get('hot-water-time') || '';
                pdf.text(`Hot Water Temp: ${hotWaterTemp} Â°C`, 40, afterTableY);
                afterTableY += 15;
                pdf.text(`Time Taken: ${hotWaterTime}`, 40, afterTableY);
                afterTableY += 20;
                const milkTemp = fd.get('milk-temp') || '';
                const milkTime = fd.get('milk-time') || '';
                pdf.text(`Milk Temp: ${milkTemp} Â°C`, 40, afterTableY);
                afterTableY += 15;
                pdf.text(`Time Taken: ${milkTime}`, 40, afterTableY);
                afterTableY += 20;

                // Add photos after table
                let photoY = afterTableY + 20;
                const pageWidth = pdf.internal.pageSize.getWidth();
                photoStore.forEach(photoObj => {
                    const images = photoObj.images;
                    pdf.setFontSize(12);
                    pdf.text(photoObj.itemName, 40, photoY - 10);
                    if (images.length === 1) {
                        if (photoY > pdf.internal.pageSize.getHeight() - 220) {
                            pdf.addPage();
                            photoY = 60;
                        }
                        pdf.addImage(images[0], 'JPEG', 40, photoY, 250, 200);
                        photoY += 220;
                    } else if (images.length === 2) {
                        if (photoY > pdf.internal.pageSize.getHeight() - 220) {
                            pdf.addPage();
                            photoY = 60;
                        }
                        const imageWidth = (pageWidth - 120) / 2;
                        pdf.addImage(images[0], 'JPEG', 40, photoY, imageWidth, 200);
                        pdf.addImage(images[1], 'JPEG', 60 + imageWidth, photoY, imageWidth, 200);
                        photoY += 220;
                    }
                });

                // Output final PDF
                const pdfBlob = pdf.output('blob');
                pdf.save(`Dairy_Shed_Hygiene_Checklist_${dairyNumber}.pdf`);

                // Remove from Dexie so no prompt next time
                await db.forms.delete(dairyNumber);

                // If online, upload
                if (navigator.onLine) {
                    uploadPDF(dairyNumber, pdfBlob);
                }

                // Clear the form
                clearEntireForm();
            }

            function blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }
        }

        function uploadPDF(dairyNumber, pdfBlob) {
            const timestamp = new Date().toISOString().split('T')[0];
            const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
            const uploadRef = storage.ref(`customers/${dairyNumber}/${fileName}`);
            uploadRef.put(pdfBlob)
                .then(() => console.log('PDF uploaded successfully'))
                .catch(err => console.error('Error uploading PDF:', err));
        }

        /*******************************************
         * K: RECORDS VIEW PAGE
         *******************************************/
        function viewRecords() {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('record-container').style.display = 'block';
            loadAllRecords();
        }

        async function loadAllRecords() {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const storageRef = storage.ref('customers');
            try {
                const folderSnapshot = await storageRef.listAll();
                folderSnapshot.prefixes.forEach(folderRef => {
                    const dairyNumber = folderRef.name;
                    const link = document.createElement('a');
                    link.textContent = dairyNumber;
                    link.href = '#';
                    link.addEventListener('click', () => loadRecordFiles(dairyNumber));
                    recordList.appendChild(link);
                });
            } catch (error) {
                console.error('Error fetching records:', error);
            }
        }

        async function loadRecordFiles(dairyNumber) {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const folderRef = storage.ref(`customers/${dairyNumber}`);
            try {
                const fileSnapshot = await folderRef.listAll();
                fileSnapshot.items.forEach(fileRef => {
                    const fileName = fileRef.name;
                    const dateMatch = fileName.match(/(\d{4}-\d{2}-\d{2})/);
                    const displayName = dateMatch ? dateMatch[0] : fileName;

                    const fileLink = document.createElement('a');
                    fileLink.textContent = displayName;
                    fileLink.href = '#';
                    fileLink.addEventListener('click', async () => {
                        try {
                            const url = await fileRef.getDownloadURL();
                            window.open(url, '_blank');
                        } catch (err) {
                            console.error('Error fetching file:', err);
                        }
                    });
                    recordList.appendChild(fileLink);
                });
                const backBtn = document.createElement('button');
                backBtn.textContent = 'Back to Records';
                backBtn.className = 'back-button';
                backBtn.addEventListener('click', goBackToRecords);
                recordList.appendChild(backBtn);
            } catch (err) {
                console.error('Error fetching record files:', err);
            }
        }

        function filterRecords() {
            const searchValue = document.getElementById('search-dairy-number').value.toLowerCase();
            const recordList = document.getElementById('record-list');
            const links = recordList.getElementsByTagName('a');
            for (let i = 0; i < links.length; i++) {
                const link = links[i];
                const txt = link.textContent || link.innerText;
                link.style.display = (txt.toLowerCase().indexOf(searchValue) > -1) ? "" : "none";
            }
        }

        function goBack() {
            document.getElementById('form-container').style.display = 'block';
            document.getElementById('record-container').style.display = 'none';
        }
        function goBackToRecords() {
            loadAllRecords();
        }

        /*******************************************
         * L: DOMContentLoaded
         *******************************************/
        document.addEventListener("DOMContentLoaded", async () => {
            // 1) Setup Dairy Company List
            await setupDairyCompanyDatalist();

            // 2) Create all checklists
            createHealthSafetyItems('health-safety-top');
            createPlantChecklistItems();   // The "Plant Checklist"
            createSiloChecklistItems();    // The "Silo Checklist"
            await createAdditionalChecks();

            // 3) Check for existing form
            await checkForExistingForm();

            // 4) Save data on any input
            const form = document.getElementById('hygiene-checklist-form');
            form.addEventListener('input', saveFormData);
        });
    </script>
</body>

</html>
