<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta tags and CSS links -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Shed Hygiene Checklist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <!-- Your existing styles here -->
    <style>
        /* [Your existing styles here] */
        body {
            background-color: #002B5C;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }

        .container {
            background-color: #002B5C;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
        }

        h1,
        h2 {
            color: #a7ab01;
            text-align: center;
        }

        h1 {
            margin-bottom: 40px;
        }

        label {
            margin-top: 10px;
        }

        button {
            background-color: #FF851B;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            border-radius: 5px;
        }

        button:hover {
            background-color: #FF4136;
        }

        .checklist-item {
            margin-bottom: 30px;
        }

        .form-control,
        .form-select {
            margin-top: 5px;
        }

        .version {
            text-align: center;
            margin-top: 20px;
            color: #FFFFFF;
            font-size: 12px;
        }

        .logo {
            display: block;
            margin: 0 auto 20px;
            width: 250px;
        }

        .record-container {
            background-color: #FFFFFF;
            color: #000000;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            max-width: 1000px;
            width: 100%;
            margin: 20px auto;
        }

        .record-container h2 {
            color: #002B5C;
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-list a {
            text-decoration: none;
            color: #007bff;
            display: block;
            margin-bottom: 10px;
        }

        .back-button {
            margin-top: 20px;
            background-color: #002B5C;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .search-container {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container" id="form-container">
        <img src="https://i.postimg.cc/htZPjx5g/logo-89.png" alt="Logo" class="logo">
        <h1>Dairy Shed Hygiene Checklist</h1>

        <form id="hygiene-checklist-form">
            <!-- Form Fields -->
            <!-- [Your existing form fields here] -->
            <div class="section mb-4">
                <!-- [Farm Details Section] -->
                <!-- [Same as before] -->
                <!-- Form fields for farm details -->
                <h2>Farm Details</h2>
                <!-- [Your existing input fields] -->
                <!-- ... -->
            </div>

            <!-- Checklist Items Section -->
            <div class="section mb-4">
                <h2>Checklist Items</h2>
                <div id="checklist-items">
                    <!-- Checklist items will be dynamically added here -->
                </div>
            </div>

            <!-- Temperature Measurements Section -->
            <div class="section mb-4">
                <h2>Temperature Measurements</h2>
                <!-- [Your existing temperature input fields] -->
                <!-- ... -->
            </div>

            <button type="button" onclick="generatePDF()">Generate PDF</button>
            <button type="button" onclick="viewRecords()">View All Records</button>
        </form>
        <div class="version">Version 5.4</div>
    </div>

    <!-- Records Viewing Page -->
    <div id="record-container" class="record-container" style="display: none;">
        <!-- [Your existing record viewing section] -->
        <!-- ... -->
    </div>

    <!-- Include scripts at the end of the body for better performance -->
    <!-- Include Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- Include external libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- Your main script -->
    <script>
        // Ensure that jsPDF is properly initialized
        const { jsPDF } = window.jspdf;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
            authDomain: "dairy-farm-record-system.firebaseapp.com",
            projectId: "dairy-farm-record-system",
            storageBucket: "dairy-farm-record-system.appspot.com",
            messagingSenderId: "422124188212",
            appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const firestore = firebase.firestore();

        // Initialize IndexedDB using Dexie
        const db = new Dexie("OfflineData");
        db.version(1).stores({
            forms: "++id, dairyNumber, formData, pdfBlob"
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(err => {
                    console.error('Service Worker registration failed:', err);
                });
        }

        // Function definitions

        async function fetchFarmDetails() {
            const dairyNumber = document.getElementById('dairy-number').value;
            if (dairyNumber) {
                const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
                try {
                    const url = await storageRef.getDownloadURL();
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('Failed to fetch the farm details');
                    }
                    const data = await response.json();
                    if (data) {
                        document.getElementById('dairy-company').value = data.dairyCompany || '';
                        document.getElementById('address').value = data.address || '';
                        document.getElementById('customer-name').value = data.customerName || '';
                        document.getElementById('region').value = data.region || '';
                        document.getElementById('farm-name').value = data.farmName || '';
                        document.getElementById('island').value = data.island || '';
                    }
                } catch (error) {
                    console.error('Error fetching farm details:', error);
                }
            }
        }

        async function saveFarmDetails(formData) {
            const dairyNumber = formData.get('dairy-number');
            const farmDetails = {
                dairyCompany: formData.get('dairy-company'),
                address: formData.get('address'),
                customerName: formData.get('customer-name'),
                region: formData.get('region'),
                farmName: formData.get('farm-name'),
                island: formData.get('island'),
            };
            const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
            const metadata = {
                contentType: 'application/json',
            };
            try {
                await storageRef.put(new Blob([JSON.stringify(farmDetails)], { type: 'application/json' }), metadata);
                console.log('Farm details saved successfully.');
            } catch (error) {
                console.error('Error saving farm details:', error);
            }
        }

        async function generatePDF() {
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const dairyNumber = formData.get('dairy-number');

            await saveFarmDetails(formData); // Save farm details if not found

            const { jsPDF } = window.jspdf;
            let pdf = new jsPDF('p', 'pt', 'a4');

            // Add logo centered
            const logoStorageRef = storage.ref('Picture3.jpg');
            try {
                const logoUrl = await logoStorageRef.getDownloadURL();
                const logo = await fetch(logoUrl).then((res) => res.blob());
                const reader = new FileReader();
                reader.readAsDataURL(logo);
                reader.onload = function () {
                    const imgData = reader.result;
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgWidth = pageWidth - 80; // Leave some margins
                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                    const x = (pageWidth - imgWidth) / 2; // Center the image
                    pdf.addImage(imgData, 'JPEG', x, 40, imgWidth, imgHeight);

                    pdf.setFontSize(12);
                    pdf.setTextColor('#000000');
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Farm Details:', 40, imgHeight + 60);

                    let currentY = imgHeight + 80;

                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Dairy Company: ${formData.get('dairy-company')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Dairy Number: ${formData.get('dairy-number')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Address: ${formData.get('address')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Customer Name: ${formData.get('customer-name')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Region: ${formData.get('region')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Farm Name: ${formData.get('farm-name')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Island: ${formData.get('island')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Visit Date: ${formData.get('visit-date')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Visit Type: ${formData.get('visit-type')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection Start Time: ${formData.get('inspection-start-time')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection End Time: ${formData.get('inspection-end-time')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection Completed By: ${formData.get('inspection-completed-by')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Call Type: ${formData.get('call-type')}`, 40, currentY);
                    currentY += 30;

                    // Checklist Items Section
                    const checklistItemsDiv = document.getElementById('checklist-items').children;
                    const checklistTable = [];
                    const photos = [];

                    let pendingImages = 0;

                    for (let item of checklistItemsDiv) {
                        const itemName = item.querySelector('label').textContent;
                        const status = item.querySelector('select').value;
                        let comments = item.querySelector('input[type="text"]').value;
                        const imageFile = item.querySelector('input[type="file"]').files[0];

                        if (status === 'attention-required') {
                            if (imageFile) {
                                comments += " (See attached photo below)";
                            }
                        }

                        checklistTable.push([itemName, status, comments]);

                        if (imageFile) {
                            pendingImages++;
                            const imgReader = new FileReader();
                            imgReader.onload = function (event) {
                                photos.push({
                                    imageData: event.target.result,
                                    title: itemName
                                });
                                pendingImages--;
                                if (pendingImages === 0) {
                                    finalizePDF();
                                }
                            };
                            imgReader.readAsDataURL(imageFile);
                        }
                    }

                    if (pendingImages === 0) {
                        finalizePDF();
                    }

                    function finalizePDF() {
                        // Generate checklist items table
                        pdf.autoTable({
                            startY: currentY,
                            head: [['Item', 'Status', 'Comments']],
                            body: checklistTable,
                            styles: {
                                fontSize: 10,
                                cellPadding: 5,
                            },
                            headStyles: {
                                fillColor: '#002B5C',
                                textColor: '#FFFFFF'
                            }
                        });

                        // Add temperature data
                        let tempY = pdf.lastAutoTable.finalY + 20;

                        pdf.setFont('helvetica', 'bold');
                        pdf.text('Temperature Measurements:', 40, tempY);
                        tempY += 20;

                        pdf.setFont('helvetica', 'normal');
                        pdf.text(`Hot Water Temp: ${formData.get('hot-water-temp')} °C`, 40, tempY);
                        tempY += 15;
                        pdf.text(`Time Taken: ${formData.get('hot-water-time')}`, 40, tempY);
                        tempY += 20;

                        pdf.text(`Milk Temp: ${formData.get('milk-temp')} °C`, 40, tempY);
                        tempY += 15;
                        pdf.text(`Time Taken: ${formData.get('milk-time')}`, 40, tempY);
                        tempY += 20;

                        // Add photos after the checklist
                        let photoY = pdf.lastAutoTable.finalY + 120; // Start placing photos after the last auto table

                        photos.forEach((photo, index) => {
                            if (photoY > pdf.internal.pageSize.getHeight() - 220) {
                                // If we're getting close to the end of the page, add a new page
                                pdf.addPage();
                                photoY = 60; // Reset Y position for the new page
                            }

                            pdf.addImage(photo.imageData, 'JPEG', 40, photoY, 250, 200); // Adjust the size to fit more photos
                            pdf.setFontSize(12);
                            pdf.text(photo.title, 40, photoY - 10); // Add the title above the photo
                            photoY += 220; // Move Y position down for the next photo (image height + spacing)
                        });

                        // Save PDF and upload to Firebase
                        const pdfBlob = pdf.output('blob');

                        if (navigator.onLine) {
                            uploadPDF(dairyNumber, pdfBlob);
                        } else {
                            // Save data to IndexedDB
                            db.forms.add({
                                dairyNumber: dairyNumber,
                                formData: Object.fromEntries(formData.entries()),
                                pdfBlob: pdfBlob
                            }).then(() => {
                                console.log('Data saved locally. Will sync when back online.');
                            }).catch((error) => {
                                console.error('Error saving data locally:', error);
                            });
                        }

                        pdf.save('Dairy_Shed_Hygiene_Checklist.pdf');
                    }
                };
            } catch (error) {
                console.error('Error fetching logo:', error);
            }
        }

        function uploadPDF(dairyNumber, pdfBlob) {
            const timestamp = new Date().toISOString().split('T')[0];
            const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
            const storageRef = storage.ref(`customers/${dairyNumber}/${fileName}`);

            storageRef.put(pdfBlob).then(() => {
                console.log('PDF uploaded successfully');
            }).catch((error) => {
                console.error('Error uploading PDF:', error);
            });
        }

        window.addEventListener('online', syncDataWithFirebase);

        async function syncDataWithFirebase() {
            const offlineForms = await db.forms.toArray();

            for (const record of offlineForms) {
                const dairyNumber = record.dairyNumber;
                const pdfBlob = record.pdfBlob;

                uploadPDF(dairyNumber, pdfBlob);

                // Remove the record from IndexedDB after uploading
                db.forms.delete(record.id);
            }

            console.log('All offline data has been synced with Firebase.');
        }

        function createChecklistItems() {
            const checklistItems = [
                "Pulsator Airline", "Long Bend Elbows", "Automatic Cup and Remover", "Diaphragm", "Receiving Can",
                "Sanitary Trap", "Main Milk Line", "Milk Line Seals in Good Condition", "Stainless Droppers", "Long Milk Rubber",
                "Liner", "Cluster", "Cluster Seal", "Cluster Button", "Non Return Valve at Milk Pump", "Milk Pump",
                "Filter Housing", "Plate Cooler", "Interceptor", "Receiver Airline", "Flushing Pulsator", "Air Purge Valve",
                "Vacuum Level", "Main Airline", "Plant Drainage - Milk Pump", "Plant Drainage - Filter/s", "Plant Drainage - Plate Cooler",
                "Plant Drainage - Vat Entry", "Plant Wash Tap", "Wash Jetters", "Centre Gland", "Test Bucket",
                "Inlet Valve", "Non-Return Valve", "Spray Ball", "Agitator", "Silo Door", "Manhole Seal", "Vat Outlet", "Walls in Silo"
            ];

            const itemsToAutoFill = [
                "Inlet Valve",
                "Non-Return Valve",
                "Spray Ball",
                "Agitator",
                "Silo Door",
                "Manhole Seal",
                "Vat Outlet",
                "Walls in Silo"
            ];

            const checklistContainer = document.getElementById('checklist-items');
            checklistContainer.innerHTML = '';

            checklistItems.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('checklist-item');

                const label = document.createElement('label');
                label.textContent = item;
                itemContainer.appendChild(label);

                const statusSelect = document.createElement('select');
                statusSelect.classList.add('form-select');
                statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
                itemContainer.appendChild(statusSelect);

                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.classList.add('form-control');
                commentsInput.placeholder = 'Comments';
                itemContainer.appendChild(commentsInput);

                const imageUpload = document.createElement('input');
                imageUpload.type = 'file';
                imageUpload.classList.add('form-control', 'image-upload');
                imageUpload.style.display = 'none';
                itemContainer.appendChild(imageUpload);

                statusSelect.addEventListener('change', () => {
                    if (statusSelect.value === 'attention-required') {
                        imageUpload.style.display = 'block';
                    } else {
                        imageUpload.style.display = 'none';
                    }

                    if (statusSelect.value === 'not-checked' && itemsToAutoFill.includes(item)) {
                        commentsInput.value = "Milk in Vat";
                    } else if (commentsInput.value === "Milk in Vat") {
                        commentsInput.value = ""; // Clear the field if it was auto-filled
                    }
                });

                checklistContainer.appendChild(itemContainer);
            });
        }

        // Other functions (e.g., viewRecords, loadAllRecords, etc.)
        // [Your existing functions here]

        document.addEventListener("DOMContentLoaded", () => {
            createChecklistItems();
            // Other initialization code
        });

    </script>
</body>

</html>
