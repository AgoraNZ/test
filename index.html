<!DOCTYPE html>
<html lang="en">

<head>
    <!-- 
    PART 1: META & STYLES
    These tags set up the page and link to existing CSS/Bootstrap
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Shed Hygiene Checklist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">

    <!-- 
    Inline CSS for the design and layout.
    We keep the existing design here without changes, but feel free to adjust if needed.
    -->
    <style>
        body {
            background-color: #002B5C;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }

        .container {
            background-color: #002B5C;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
        }

        h1,
        h2 {
            color: #a7ab01;
            text-align: center;
        }

        h1 {
            margin-bottom: 40px;
        }

        label {
            margin-top: 10px;
        }

        button {
            background-color: #FF851B;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            border-radius: 5px;
        }

        button:hover {
            background-color: #FF4136;
        }

        .checklist-item {
            margin-bottom: 30px;
        }

        .form-control,
        .form-select {
            margin-top: 5px;
        }

        .version {
            text-align: center;
            margin-top: 20px;
            color: #FFFFFF;
            font-size: 12px;
        }

        .logo {
            display: block;
            margin: 0 auto 20px;
            width: 250px;
        }

        .record-container {
            background-color: #FFFFFF;
            color: #000000;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            max-width: 1000px;
            width: 100%;
            margin: 20px auto;
        }

        .record-container h2 {
            color: #002B5C;
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-list a {
            text-decoration: none;
            color: #007bff;
            display: block;
            margin-bottom: 10px;
        }

        .back-button {
            margin-top: 20px;
            background-color: #002B5C;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .search-container {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <!-- 
    PART 2: MAIN FORM CONTAINER
    Contains the entire checklist, plus the version label at bottom 
    -->
    <div class="container" id="form-container">
        <img src="https://i.postimg.cc/htZPjx5g/logo-89.png" alt="Logo" class="logo">
        <h1>Dairy Shed Hygiene Checklist</h1>

        <!-- 
        The main form that captures all data.
        ID: #hygiene-checklist-form
        -->
        <form id="hygiene-checklist-form">
            <!-- 
            SECTION: Farm Details 
            This chunk collects basic farm info, dairy #, address, etc.
            -->
            <div class="section mb-4">
                <h2>Farm Details</h2>

                <label for="dairy-number">Dairy Number:</label>
                <input type="text"
                       class="form-control"
                       id="dairy-number"
                       name="dairy-number"
                       onblur="fetchFarmDetails(); checkOrCreateFormRecord();"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <!-- 
                Single editable drop-down with datalist for Dairy Company
                -->
                <label for="dairy-company">Dairy Company:</label>
                <input type="text"
                       class="form-control"
                       id="dairy-company"
                       name="dairy-company"
                       list="dairy-company-list"
                       placeholder="Type or select..."
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">
                <datalist id="dairy-company-list"></datalist>

                <label for="address">Address:</label>
                <input type="text"
                       class="form-control"
                       id="address"
                       name="address"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="customer-name">Customer Name:</label>
                <input type="text"
                       class="form-control"
                       id="customer-name"
                       name="customer-name"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="region">Region:</label>
                <select id="region" name="region" class="form-select">
                    <option value="northland">Northland</option>
                    <option value="auckland">Auckland</option>
                    <option value="waikato">Waikato</option>
                    <option value="bay-of-plenty">Bay of Plenty</option>
                    <option value="gisborne">Gisborne</option>
                    <option value="hawkes-bay">Hawke's Bay</option>
                    <option value="taranaki">Taranaki</option>
                    <option value="manawatu-wanganui">Manawatu-Wanganui</option>
                    <option value="wellington">Wellington</option>
                    <option value="nelson">Nelson</option>
                    <option value="marlborough">Marlborough</option>
                    <option value="west-coast">West Coast</option>
                    <option value="canterbury">Canterbury</option>
                    <option value="otago">Otago</option>
                    <option value="southland">Southland</option>
                </select>

                <label for="farm-name">Farm Name:</label>
                <input type="text"
                       class="form-control"
                       id="farm-name"
                       name="farm-name"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="island">Island:</label>
                <select id="island" name="island" class="form-select">
                    <option value="north-island">North Island</option>
                    <option value="south-island">South Island</option>
                </select>

                <label for="visit-date">Visit Date:</label>
                <input type="date"
                       class="form-control"
                       id="visit-date"
                       name="visit-date">

                <label for="visit-type">Visit Type:</label>
                <input type="text"
                       class="form-control"
                       id="visit-type"
                       name="visit-type"
                       value="Milking Plant & Milk Vat Check"
                       readonly
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="inspection-start-time">Inspection Start Time:</label>
                <input type="time"
                       class="form-control"
                       id="inspection-start-time"
                       name="inspection-start-time">

                <label for="inspection-end-time">Inspection End Time:</label>
                <input type="time"
                       class="form-control"
                       id="inspection-end-time"
                       name="inspection-end-time">

                <label for="inspection-completed-by">Inspection Completed By:</label>
                <input type="text"
                       class="form-control"
                       id="inspection-completed-by"
                       name="inspection-completed-by"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="call-type">Call Type:</label>
                <select id="call-type" name="call-type" class="form-select">
                    <option value="alert">Alert</option>
                    <option value="grade-call">Grade Call</option>
                    <option value="regular-scheduled-visit" selected>Regular Scheduled Visit</option>
                </select>
            </div>

            <!-- 
            SECTION: Health & Safety (TOP)
            Additional items go here 
            -->
            <div class="section mb-4">
                <h2>Health & Safety</h2>
                <div id="health-safety-top"></div>
            </div>

            <!-- 
            SECTION: Main Checklist Items
            Dynamically created in JS 
            -->
            <div class="section mb-4">
                <h2>Checklist Items</h2>
                <div id="checklist-items"></div>
            </div>

            <!-- 
            SECTION: Additional Checks (Teat Spray, Chemical, etc.) 
            -->
            <div class="section mb-4">
                <h2>Additional Checks</h2>
                <div id="additional-checks"></div>
            </div>

            <!-- 
            SECTION: Temperature Measurements
            -->
            <div class="section mb-4">
                <h2>Temperature Measurements</h2>
                <div class="checklist-item">
                    <label for="hot-water-temp">Hot Water Temp (째C):</label>
                    <input type="text"
                           class="form-control"
                           id="hot-water-temp"
                           name="hot-water-temp"
                           step="0.1"
                           autocapitalize="words"
                           autocorrect="off"
                           spellcheck="false">

                    <label for="hot-water-time">Time Taken:</label>
                    <input type="time" class="form-control" id="hot-water-time" name="hot-water-time">
                </div>
                <div class="checklist-item">
                    <label for="milk-temp">Milk Temp (째C):</label>
                    <input type="text"
                           class="form-control"
                           id="milk-temp"
                           name="milk-temp"
                           step="0.1"
                           autocapitalize="words"
                           autocorrect="off"
                           spellcheck="false">

                    <label for="milk-time">Time Taken:</label>
                    <input type="time" class="form-control" id="milk-time" name="milk-time">
                </div>
            </div>

            <!-- 
            SECTION: Action Buttons 
            -->
            <button type="button" onclick="generatePDF()">Generate PDF</button>
            <button type="button" onclick="viewRecords()">View All Records</button>
        </form>

        <!-- Version label at bottom, unchanged -->
        <div class="version">Version 5.4</div>
    </div>

    <!-- 
    PART 3: RECORDS VIEWING PAGE 
    The page that shows existing PDF records from Firebase
    -->
    <div id="record-container" class="record-container" style="display: none;">
        <h2>All Dairy Shed Hygiene Records</h2>
        <div class="search-container">
            <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number" oninput="filterRecords()">
        </div>
        <div id="record-list" class="record-list"></div>
        <button class="back-button" onclick="goBack()">Back to Checklist</button>
    </div>

    <!-- 
    PART 4: SCRIPTS
    Includes Firebase, Dexie, jsPDF, etc., plus our main JS
    -->
    <!-- Firebase + Firestore + Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- Dexie (IndexedDB library) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>

    <!-- jsPDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- 
    PART 5: MAIN SCRIPT
    Contains all logic: Dexie setup, form caching, PDF generation, etc.
    -->

    <script>
        /*******************************************
         * SECTION A: FIREBASE & DEXIE INITIALIZATION
         *******************************************/
        const { jsPDF } = window.jspdf;

        // Firebase Config & Init
        const firebaseConfig = {
            apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
            authDomain: "dairy-farm-record-system.firebaseapp.com",
            projectId: "dairy-farm-record-system",
            storageBucket: "dairy-farm-record-system.appspot.com",
            messagingSenderId: "422124188212",
            appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
        };
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const firestore = firebase.firestore();

        // Dexie Setup
        // We'll keep forms: { dairyNumber, formData, creationTime }
        // Also keep user-defined dairyCompanies and user-defined Teat Spray Ratios
        const db = new Dexie("OfflineData");
        db.version(3).stores({
            forms: "dairyNumber",
            dairyCompanies: "++id, name",
            teatSprayRatios: "++id, ratio"
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registered:', reg.scope))
                .catch(err => console.error('SW registration failed:', err));
        }


        /*******************************************
         * SECTION B: DAIRY COMPANY DATALIST
         * Single line editable dropdown for Dairy Company
         *******************************************/
        async function setupDairyCompanyDatalist() {
            // Default companies
            const defaultCompanies = [
                "Fonterra",
                "Dairy Goat Co-op",
                "Green Valley Dairies",
                "Maui Milk",
                "Oceania",
                "OFI",
                "Synlait Milk LTD",
                "Tatua"
            ];
            // Load user-added from Dexie
            const userCompanies = await db.dairyCompanies.toArray();
            const allCompanies = [...defaultCompanies];

            userCompanies.forEach(u => {
                if (!allCompanies.includes(u.name)) {
                    allCompanies.push(u.name);
                }
            });

            // Populate datalist
            const datalist = document.getElementById('dairy-company-list');
            datalist.innerHTML = "";
            allCompanies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                datalist.appendChild(opt);
            });

            // If user types a new company and leaves the field, store in DB
            const dairyCompanyInput = document.getElementById('dairy-company');
            dairyCompanyInput.addEventListener('blur', async () => {
                const typedValue = dairyCompanyInput.value.trim();
                if (typedValue && !allCompanies.includes(typedValue)) {
                    await db.dairyCompanies.add({ name: typedValue });
                    allCompanies.push(typedValue);
                    const newOpt = document.createElement('option');
                    newOpt.value = typedValue;
                    datalist.appendChild(newOpt);
                }
            });
        }


        /*******************************************
         * SECTION C: FETCH FARM DETAILS (Firebase)
         * Called onblur of #dairy-number
         *******************************************/
        async function fetchFarmDetails() {
            const dairyNumber = document.getElementById('dairy-number').value.trim();
            if (!dairyNumber) return;
            // Attempt fetch from Firebase Storage
            const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
            try {
                const url = await storageRef.getDownloadURL();
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch the farm details');
                const data = await response.json();
                if (data) {
                    document.getElementById('dairy-company').value = data.dairyCompany || '';
                    document.getElementById('address').value = data.address || '';
                    document.getElementById('customer-name').value = data.customerName || '';
                    document.getElementById('region').value = data.region || '';
                    document.getElementById('farm-name').value = data.farmName || '';
                    document.getElementById('island').value = data.island || '';
                }
            } catch (error) {
                console.log('No farm details found or error fetching from Firebase.');
            }
        }


        /*******************************************
         * SECTION D: CREATE / LOAD FORM RECORD
         * So that data is cached as soon as user enters dairy number
         *******************************************/
        async function checkOrCreateFormRecord() {
            const dairyNumber = document.getElementById('dairy-number').value.trim();
            if (!dairyNumber) return;

            // Check if record already exists. If not, create it.
            let existing = await db.forms.get(dairyNumber);
            if (!existing) {
                // Add new record
                await db.forms.put({
                    dairyNumber: dairyNumber,
                    formData: {},
                    creationTime: Date.now()
                });
            }
        }


        /*******************************************
         * SECTION E: CREATE CHECKLIST ITEMS (Health & Safety, Main Items, Additional)
         *******************************************/
        function createHealthSafetyItems(containerId) {
            const itemContainer = document.createElement('div');
            itemContainer.classList.add('checklist-item');

            const label = document.createElement('label');
            label.textContent = "Health & Safety";
            itemContainer.appendChild(label);

            const statusSelect = document.createElement('select');
            statusSelect.classList.add('form-select');
            statusSelect.name = `status-health-safety-${containerId}`;
            statusSelect.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
            itemContainer.appendChild(statusSelect);

            const commentsInput = document.createElement('input');
            commentsInput.type = 'text';
            commentsInput.classList.add('form-control');
            commentsInput.name = `comments-health-safety-${containerId}`;
            commentsInput.placeholder = 'Comments';
            commentsInput.setAttribute('autocapitalize','words');
            commentsInput.setAttribute('autocorrect','off');
            commentsInput.setAttribute('spellcheck','false');
            itemContainer.appendChild(commentsInput);

            const imageUpload1 = document.createElement('input');
            imageUpload1.type = 'file';
            imageUpload1.classList.add('form-control', 'image-upload');
            imageUpload1.style.display = 'none';
            itemContainer.appendChild(imageUpload1);

            const imageUpload2 = document.createElement('input');
            imageUpload2.type = 'file';
            imageUpload2.classList.add('form-control', 'image-upload');
            imageUpload2.style.display = 'none';
            itemContainer.appendChild(imageUpload2);

            statusSelect.addEventListener('change', () => {
                if (statusSelect.value === 'attention-required') {
                    imageUpload1.style.display = 'block';
                    imageUpload2.style.display = 'block';
                } else {
                    imageUpload1.style.display = 'none';
                    imageUpload2.style.display = 'none';
                }
            });

            document.getElementById(containerId).appendChild(itemContainer);
        }

        function createChecklistItems() {
            const checklistItems = [
                "Pulsator Airline", "Long Bend Elbows", "Automatic Cup and Remover", "Diaphragm", "Receiving Can",
                "Sanitary Trap", "Main Milk Line", "Milk Line Seals in Good Condition", "Stainless Droppers", "Long Milk Rubber",
                "Liner", "Cluster", "Cluster Seal", "Cluster Button", "Non Return Valve at Milk Pump", "Milk Pump",
                "Filter Housing", "Plate Cooler", "Interceptor", "Receiver Airline", "Flushing Pulsator", "Air Purge Valve",
                "Vacuum Level", "Main Airline", "Plant Drainage - Milk Pump", "Plant Drainage - Filter/s", "Plant Drainage - Plate Cooler",
                "Plant Drainage - Vat Entry", "Plant Wash Tap", "Wash Jetters", "Centre Gland", "Test Bucket",
                "Inlet Valve", "Non-Return Valve", "Spray Ball", "Agitator", "Silo Door", "Manhole Seal", "Vat Outlet", "Walls in Silo"
            ];

            const itemsToAutoFill = [
                "Inlet Valve",
                "Non-Return Valve",
                "Spray Ball",
                "Agitator",
                "Silo Door",
                "Manhole Seal",
                "Vat Outlet",
                "Walls in Silo"
            ];

            const container = document.getElementById('checklist-items');
            container.innerHTML = '';

            checklistItems.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('checklist-item');

                const label = document.createElement('label');
                label.textContent = item;
                itemContainer.appendChild(label);

                const statusSelect = document.createElement('select');
                statusSelect.classList.add('form-select');
                statusSelect.name = `status-${item}`;
                statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
                itemContainer.appendChild(statusSelect);

                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.classList.add('form-control');
                commentsInput.name = `comments-${item}`;
                commentsInput.placeholder = 'Comments';
                commentsInput.setAttribute('autocapitalize','words');
                commentsInput.setAttribute('autocorrect','off');
                commentsInput.setAttribute('spellcheck','false');
                itemContainer.appendChild(commentsInput);

                const imageUpload1 = document.createElement('input');
                imageUpload1.type = 'file';
                imageUpload1.classList.add('form-control', 'image-upload');
                imageUpload1.style.display = 'none';
                itemContainer.appendChild(imageUpload1);

                const imageUpload2 = document.createElement('input');
                imageUpload2.type = 'file';
                imageUpload2.classList.add('form-control', 'image-upload');
                imageUpload2.style.display = 'none';
                itemContainer.appendChild(imageUpload2);

                // If status is "attention-required", show image fields
                statusSelect.addEventListener('change', () => {
                    if (statusSelect.value === 'attention-required') {
                        imageUpload1.style.display = 'block';
                        imageUpload2.style.display = 'block';
                    } else {
                        imageUpload1.style.display = 'none';
                        imageUpload2.style.display = 'none';
                    }
                    // Auto-fill "Milk in Vat" logic
                    if (statusSelect.value === 'not-checked' && itemsToAutoFill.includes(item)) {
                        commentsInput.value = "Milk in Vat";
                    } else if (commentsInput.value === "Milk in Vat") {
                        commentsInput.value = "";
                    }
                });

                container.appendChild(itemContainer);
            });
        }

        /*******************************************
         * SECTION F: ADDITIONAL CHECKS (Teat Spray as single editable dropdown, Chemical)
         *******************************************/
        async function createAdditionalChecks() {
            const container = document.getElementById('additional-checks');
            container.innerHTML = '';

            // 1) TEAT SPRAY CHECK
            const teatSprayContainer = document.createElement('div');
            teatSprayContainer.classList.add('checklist-item');

            const labelTeat = document.createElement('label');
            labelTeat.textContent = "Teat Spray Check";
            teatSprayContainer.appendChild(labelTeat);

            const statusSelectTeat = document.createElement('select');
            statusSelectTeat.classList.add('form-select');
            statusSelectTeat.name = "status-teat-spray-check";
            statusSelectTeat.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
            teatSprayContainer.appendChild(statusSelectTeat);

            const commentsInputTeat = document.createElement('input');
            commentsInputTeat.type = 'text';
            commentsInputTeat.classList.add('form-control');
            commentsInputTeat.name = "comments-teat-spray-check";
            commentsInputTeat.placeholder = 'Comments';
            commentsInputTeat.setAttribute('autocapitalize','words');
            commentsInputTeat.setAttribute('autocorrect','off');
            commentsInputTeat.setAttribute('spellcheck','false');
            teatSprayContainer.appendChild(commentsInputTeat);

            // Image fields
            const imageUploadTeat1 = document.createElement('input');
            imageUploadTeat1.type = 'file';
            imageUploadTeat1.classList.add('form-control', 'image-upload');
            imageUploadTeat1.style.display = 'none';
            teatSprayContainer.appendChild(imageUploadTeat1);

            const imageUploadTeat2 = document.createElement('input');
            imageUploadTeat2.type = 'file';
            imageUploadTeat2.classList.add('form-control', 'image-upload');
            imageUploadTeat2.style.display = 'none';
            teatSprayContainer.appendChild(imageUploadTeat2);

            statusSelectTeat.addEventListener('change', () => {
                if (statusSelectTeat.value === 'attention-required') {
                    imageUploadTeat1.style.display = 'block';
                    imageUploadTeat2.style.display = 'block';
                } else {
                    imageUploadTeat1.style.display = 'none';
                    imageUploadTeat2.style.display = 'none';
                }
            });

            // NEW: Single editable dropdown for Teat Spray Dilution ratio (like dairy company)
            // We'll name the input #teat-dilution so we can store new ratios in Dexie
            const dilutionLabel = document.createElement('label');
            dilutionLabel.textContent = "Teat Spray Dilution Ratio:";
            teatSprayContainer.appendChild(dilutionLabel);

            const ratioInput = document.createElement('input');
            ratioInput.type = 'text';
            ratioInput.classList.add('form-control');
            ratioInput.name = "teat-spray-dilution";
            ratioInput.id = "teat-dilution";
            ratioInput.setAttribute('list', 'teat-dilution-list');
            ratioInput.placeholder = "Type or select e.g. 1:5";
            ratioInput.setAttribute('autocapitalize','words');
            ratioInput.setAttribute('autocorrect','off');
            ratioInput.setAttribute('spellcheck','false');
            teatSprayContainer.appendChild(ratioInput);

            // We'll have a <datalist> for existing ratios
            const ratioDataList = document.createElement('datalist');
            ratioDataList.id = 'teat-dilution-list';
            teatSprayContainer.appendChild(ratioDataList);

            // Load existing ratios from Dexie
            const existingRatios = await db.teatSprayRatios.toArray();
            const allRatios = ["1:4"]; // default
            existingRatios.forEach(r => {
                if (!allRatios.includes(r.ratio)) {
                    allRatios.push(r.ratio);
                }
            });
            // Populate the datalist
            ratioDataList.innerHTML = "";
            allRatios.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                ratioDataList.appendChild(opt);
            });

            // If user types a new ratio and leaves field
            ratioInput.addEventListener('blur', async () => {
                const typedRatio = ratioInput.value.trim();
                if (typedRatio && !allRatios.includes(typedRatio)) {
                    // Add to Dexie
                    await db.teatSprayRatios.add({ ratio: typedRatio });
                    allRatios.push(typedRatio);
                    // also add to datalist
                    const newOpt = document.createElement('option');
                    newOpt.value = typedRatio;
                    ratioDataList.appendChild(newOpt);
                }
            });

            container.appendChild(teatSprayContainer);

            // 2) CHEMICAL CHECK
            const chemicalContainer = document.createElement('div');
            chemicalContainer.classList.add('checklist-item');

            const labelChemical = document.createElement('label');
            labelChemical.textContent = "Chemical Check";
            chemicalContainer.appendChild(labelChemical);

            const statusSelectChemical = document.createElement('select');
            statusSelectChemical.classList.add('form-select');
            statusSelectChemical.name = "status-chemical-check";
            statusSelectChemical.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
            chemicalContainer.appendChild(statusSelectChemical);

            const commentsInputChemical = document.createElement('input');
            commentsInputChemical.type = 'text';
            commentsInputChemical.classList.add('form-control');
            commentsInputChemical.name = "comments-chemical-check";
            commentsInputChemical.placeholder = 'Comments';
            commentsInputChemical.setAttribute('autocapitalize','words');
            commentsInputChemical.setAttribute('autocorrect','off');
            commentsInputChemical.setAttribute('spellcheck','false');
            chemicalContainer.appendChild(commentsInputChemical);

            const imageUploadChem1 = document.createElement('input');
            imageUploadChem1.type = 'file';
            imageUploadChem1.classList.add('form-control', 'image-upload');
            imageUploadChem1.style.display = 'none';
            chemicalContainer.appendChild(imageUploadChem1);

            const imageUploadChem2 = document.createElement('input');
            imageUploadChem2.type = 'file';
            imageUploadChem2.classList.add('form-control', 'image-upload');
            imageUploadChem2.style.display = 'none';
            chemicalContainer.appendChild(imageUploadChem2);

            statusSelectChemical.addEventListener('change', () => {
                if (statusSelectChemical.value === 'attention-required') {
                    imageUploadChem1.style.display = 'block';
                    imageUploadChem2.style.display = 'block';
                } else {
                    imageUploadChem1.style.display = 'none';
                    imageUploadChem2.style.display = 'none';
                }
            });

            container.appendChild(chemicalContainer);
        }


        /*******************************************
         * SECTION G: FORM CACHING & PROMPT ON PAGE LOAD
         *******************************************/
        async function cleanupExpiredForms() {
            const oneHour = 60 * 60 * 1000;
            const now = Date.now();
            const allForms = await db.forms.toArray();
            for (let f of allForms) {
                if (now - f.creationTime > oneHour) {
                    await db.forms.delete(f.dairyNumber);
                }
            }
        }

        // On page load, if there's exactly one non-expired form, prompt to continue
        async function checkForExistingForm() {
            await cleanupExpiredForms();
            const allForms = await db.forms.toArray();
            if (allForms.length === 1) {
                const existing = allForms[0];
                const confirmContinue = confirm(`Would you like to continue form #${existing.dairyNumber}?`);
                if (confirmContinue) {
                    loadFormDataFromRecord(existing);
                } else {
                    await db.forms.delete(existing.dairyNumber);
                    clearEntireForm();
                }
            } 
            // If more than one form exists, you can handle differently (not covered here)
        }

        // Load record data into fields
        function loadFormDataFromRecord(record) {
            const data = record.formData || {};
            // Place the dairy number in the field
            document.getElementById('dairy-number').value = record.dairyNumber;

            // Load standard fields (except checklistItems)
            for (let key in data) {
                if (key === 'checklistItems') continue;
                const field = document.getElementById(key) || document.getElementsByName(key)[0];
                if (field) {
                    field.value = data[key];
                }
            }

            // Load checklist items
            if (data.checklistItems) {
                const containers = [
                    ...document.getElementById('health-safety-top').children,
                    ...document.getElementById('checklist-items').children,
                    ...document.getElementById('additional-checks').children
                ];
                let idx = 0;
                for (let item of containers) {
                    if (!data.checklistItems[idx]) break;
                    const statusSelect = item.querySelector('select');
                    const commentsInput = item.querySelector('input[type="text"]');
                    if (statusSelect) {
                        statusSelect.value = data.checklistItems[idx].status;
                        statusSelect.dispatchEvent(new Event('change'));
                    }
                    if (commentsInput) {
                        commentsInput.value = data.checklistItems[idx].comments;
                    }
                    idx++;
                }
            }
        }

        // Clear form visuals
        function clearEntireForm() {
            document.getElementById('hygiene-checklist-form').reset();
            const imageUploads = document.querySelectorAll('.image-upload');
            imageUploads.forEach(inp => { inp.style.display = 'none'; });
        }


        /*******************************************
         * SECTION H: SAVE FORM DATA AS USER TYPES
         *******************************************/
        async function saveFormData() {
            const dairyNumber = document.getElementById('dairy-number').value.trim();
            if (!dairyNumber) return; // can't save if no ID

            // Check if record exists
            let record = await db.forms.get(dairyNumber);
            if (!record) {
                // create
                record = {
                    dairyNumber: dairyNumber,
                    formData: {},
                    creationTime: Date.now()
                };
            }
            // Gather current form data
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Get all checklist items
            const containersToCheck = [
                document.getElementById('health-safety-top').children,
                document.getElementById('checklist-items').children,
                document.getElementById('additional-checks').children
            ];
            const checklistItemsData = [];
            for (let container of containersToCheck) {
                for (let item of container) {
                    const label = item.querySelector('label');
                    if (!label) continue;
                    const itemName = label.textContent;
                    const statusSelect = item.querySelector('select');
                    let status = '';
                    let comments = '';
                    if (statusSelect) status = statusSelect.value;
                    const commentsInput = item.querySelector('input[type="text"]');
                    if (commentsInput) comments = commentsInput.value;
                    checklistItemsData.push({ itemName, status, comments });
                }
            }
            data.checklistItems = checklistItemsData;

            // Update record
            record.formData = data;
            record.creationTime = record.creationTime || Date.now();

            // Save to Dexie
            await db.forms.put(record);
        }


        /*******************************************
         * SECTION I: GENERATE PDF (removes record)
         *******************************************/
        async function generatePDF() {
            const dairyNumber = document.getElementById('dairy-number').value.trim();
            if (!dairyNumber) {
                alert("Please enter a Dairy Number.");
                return;
            }
            // We'll create the PDF, then remove the record from Dexie so no more prompt
            const pdf = new jsPDF('p', 'pt', 'a4');

            // Attempt to load a logo from Firebase
            try {
                const logoRef = storage.ref('Picture3.jpg');
                const logoUrl = await logoRef.getDownloadURL();
                const logoBlob = await fetch(logoUrl).then(res => res.blob());
                const reader = new FileReader();
                reader.readAsDataURL(logoBlob);
                reader.onload = function () {
                    finalizePDF(reader.result);
                };
            } catch (error) {
                console.error('Error fetching logo:', error);
                // finalize without logo
                finalizePDF(null);
            }

            async function finalizePDF(imgData) {
                // Collect form data
                const form = document.getElementById('hygiene-checklist-form');
                const fd = new FormData(form);
                const pageWidth = pdf.internal.pageSize.getWidth();
                let currentY = 80;

                if (imgData) {
                    // Insert the logo
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgWidth = pageWidth - 80;
                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                    const x = (pageWidth - imgWidth) / 2;
                    pdf.addImage(imgData, 'JPEG', x, 40, imgWidth, imgHeight);
                    pdf.setFontSize(12);
                    pdf.setTextColor('#000000');
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Farm Details:', 40, imgHeight + 60);
                    currentY = imgHeight + 80;
                } else {
                    pdf.setFontSize(12);
                    pdf.setTextColor('#000000');
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Farm Details:', 40, currentY);
                    currentY += 20;
                }

                // Print out the basic fields
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Dairy Company: ${fd.get('dairy-company')}`, 40, currentY); currentY += 15;
                pdf.text(`Dairy Number: ${fd.get('dairy-number')}`, 40, currentY); currentY += 15;
                pdf.text(`Address: ${fd.get('address')}`, 40, currentY); currentY += 15;
                pdf.text(`Customer Name: ${fd.get('customer-name')}`, 40, currentY); currentY += 15;
                pdf.text(`Region: ${fd.get('region')}`, 40, currentY); currentY += 15;
                pdf.text(`Farm Name: ${fd.get('farm-name')}`, 40, currentY); currentY += 15;
                pdf.text(`Island: ${fd.get('island')}`, 40, currentY); currentY += 15;
                pdf.text(`Visit Date: ${fd.get('visit-date')}`, 40, currentY); currentY += 15;
                pdf.text(`Visit Type: ${fd.get('visit-type')}`, 40, currentY); currentY += 15;
                pdf.text(`Inspection Start Time: ${fd.get('inspection-start-time')}`, 40, currentY); currentY += 15;
                pdf.text(`Inspection End Time: ${fd.get('inspection-end-time')}`, 40, currentY); currentY += 15;
                pdf.text(`Inspection Completed By: ${fd.get('inspection-completed-by')}`, 40, currentY); currentY += 15;
                pdf.text(`Call Type: ${fd.get('call-type')}`, 40, currentY); currentY += 30;

                // Table of checklist items
                const containers = [
                    document.getElementById('health-safety-top').children,
                    document.getElementById('checklist-items').children,
                    document.getElementById('additional-checks').children
                ];
                const checklistTable = [];
                containers.forEach(container => {
                    for (let item of container) {
                        const name = item.querySelector('label').textContent;
                        const sel = item.querySelector('select');
                        const status = sel ? sel.value : '';
                        const commentsInput = item.querySelector('input[type="text"]');
                        const comments = commentsInput ? commentsInput.value : '';
                        checklistTable.push([name, status, comments]);
                    }
                });

                pdf.autoTable({
                    startY: currentY,
                    head: [['Item', 'Status', 'Comments']],
                    body: checklistTable,
                    styles: { fontSize: 10, cellPadding: 5 },
                    headStyles: { fillColor: '#002B5C', textColor: '#FFFFFF' }
                });

                let afterTableY = pdf.lastAutoTable.finalY + 20;
                pdf.setFont('helvetica', 'bold');
                pdf.text('Temperature Measurements:', 40, afterTableY);
                afterTableY += 20;

                pdf.setFont('helvetica', 'normal');
                pdf.text(`Hot Water Temp: ${fd.get('hot-water-temp')} 째C`, 40, afterTableY);
                afterTableY += 15;
                pdf.text(`Time Taken: ${fd.get('hot-water-time')}`, 40, afterTableY);
                afterTableY += 20;
                pdf.text(`Milk Temp: ${fd.get('milk-temp')} 째C`, 40, afterTableY);
                afterTableY += 15;
                pdf.text(`Time Taken: ${fd.get('milk-time')}`, 40, afterTableY);
                afterTableY += 20;

                // Output
                const pdfBlob = pdf.output('blob');
                pdf.save(`Dairy_Shed_Hygiene_Checklist_${fd.get('dairy-number')}.pdf`);

                // Remove record from Dexie so no future prompt
                await db.forms.delete(fd.get('dairy-number'));

                // If online, upload to Firebase (optional)
                if (navigator.onLine) {
                    uploadPDF(fd.get('dairy-number'), pdfBlob);
                }

                // Clear the form visually
                clearEntireForm();
            }
        }

        function uploadPDF(dairyNumber, pdfBlob) {
            const timestamp = new Date().toISOString().split('T')[0];
            const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
            const uploadRef = storage.ref(`customers/${dairyNumber}/${fileName}`);
            uploadRef.put(pdfBlob)
                .then(() => console.log('PDF uploaded successfully'))
                .catch(err => console.error('Error uploading PDF:', err));
        }


        /*******************************************
         * SECTION J: RECORDS VIEW PAGE (LIST FILES)
         *******************************************/
        function viewRecords() {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('record-container').style.display = 'block';
            loadAllRecords();
        }

        async function loadAllRecords() {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const storageRef = storage.ref('customers');
            try {
                const folderSnapshot = await storageRef.listAll();
                folderSnapshot.prefixes.forEach(folderRef => {
                    const dairyNumber = folderRef.name;
                    const link = document.createElement('a');
                    link.textContent = dairyNumber;
                    link.href = '#';
                    link.addEventListener('click', () => {
                        loadRecordFiles(dairyNumber);
                    });
                    recordList.appendChild(link);
                });
            } catch (error) {
                console.error('Error fetching records:', error);
            }
        }

        async function loadRecordFiles(dairyNumber) {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const folderRef = storage.ref(`customers/${dairyNumber}`);
            try {
                const fileSnapshot = await folderRef.listAll();
                fileSnapshot.items.forEach(fileRef => {
                    const fileName = fileRef.name;
                    const dateMatch = fileName.match(/(\d{4}-\d{2}-\d{2})/);
                    const displayName = dateMatch ? dateMatch[0] : fileName;

                    const fileLink = document.createElement('a');
                    fileLink.textContent = displayName;
                    fileLink.href = '#';
                    fileLink.addEventListener('click', async () => {
                        try {
                            const url = await fileRef.getDownloadURL();
                            window.open(url, '_blank');
                        } catch (err) {
                            console.error('Error fetching file:', err);
                        }
                    });
                    recordList.appendChild(fileLink);
                });

                const backBtn = document.createElement('button');
                backBtn.textContent = 'Back to Records';
                backBtn.className = 'back-button';
                backBtn.addEventListener('click', goBackToRecords);
                recordList.appendChild(backBtn);
            } catch (err) {
                console.error('Error fetching record files:', err);
            }
        }

        function filterRecords() {
            const searchValue = document.getElementById('search-dairy-number').value.toLowerCase();
            const recordList = document.getElementById('record-list');
            const links = recordList.getElementsByTagName('a');
            for (let i = 0; i < links.length; i++) {
                const link = links[i];
                const txt = link.textContent || link.innerText;
                link.style.display = (txt.toLowerCase().indexOf(searchValue) > -1) ? "" : "none";
            }
        }

        function goBack() {
            document.getElementById('form-container').style.display = 'block';
            document.getElementById('record-container').style.display = 'none';
        }
        function goBackToRecords() {
            loadAllRecords();
        }


        /*******************************************
         * SECTION K: DOMContentLoaded
         * We set up everything, then check for existing form
         *******************************************/
        document.addEventListener("DOMContentLoaded", async () => {
            // 1) Setup the Dairy Company list
            await setupDairyCompanyDatalist();

            // 2) Create basic sections
            createHealthSafetyItems('health-safety-top');
            createChecklistItems();
            await createAdditionalChecks();

            // 3) Cleanup & prompt for existing single form
            await checkForExistingForm();

            // 4) Save data whenever user changes anything
            const form = document.getElementById('hygiene-checklist-form');
            form.addEventListener('input', saveFormData);
        });
    </script>
</body>

</html>
