<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta tags for responsiveness and character encoding -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Shed Hygiene Checklist</title>
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' https://cdnjs.cloudflare.com https://www.gstatic.com https://firebasestorage.googleapis.com https://storage.googleapis.com; 
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; 
        img-src 'self' data: https://storage.googleapis.com https://i.postimg.cc; 
        font-src 'self' data:; 
        connect-src 'self' https://www.googleapis.com https://firebasestorage.googleapis.com https://storage.googleapis.com; 
        object-src 'none'; 
        base-uri 'self'; 
        form-action 'self';
    ">

    <!-- Bootstrap CSS for responsive design -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    
    <!-- Custom Styles -->
    <style>
        /* Base Styles */
        body {
            background-color: #002B5C;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .container-custom {
            background-color: #002B5C;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
            margin: auto;
        }

        h1,
        h2 {
            color: #a7ab01;
            text-align: center;
        }

        h1 {
            margin-bottom: 40px;
        }

        label {
            margin-top: 10px;
            font-weight: bold;
        }

        button {
            background-color: #FF851B;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 10px 5px;
            border-radius: 5px;
            font-size: 16px;
            display: inline-block;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #FF4136;
        }

        .checklist-item {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #FFFFFF;
        }

        .form-control,
        .form-select {
            margin-top: 5px;
            background-color: #FFFFFF;
            color: #000000;
        }

        .version {
            text-align: center;
            margin-top: 20px;
            color: #FFFFFF;
            font-size: 12px;
        }

        .logo {
            display: block;
            margin: 0 auto 20px;
            width: 100%;
            max-width: 250px; /* Adjusted for responsiveness */
            height: auto; /* Maintain aspect ratio */
        }

        .record-container {
            background-color: #FFFFFF;
            color: #000000;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            max-width: 1000px;
            width: 100%;
            margin: 20px auto;
            overflow-y: auto; /* Enable vertical scroll if content overflows */
        }

        .record-container h2 {
            color: #002B5C;
            text-align: center;
            margin-bottom: 20px;
        }

        .record-list a {
            text-decoration: none;
            color: #007bff;
            display: block;
            margin-bottom: 10px;
        }

        .back-button {
            margin-top: 20px;
            background-color: #002B5C;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 16px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .back-button:hover {
            background-color: #001f3f;
        }

        .search-container {
            margin-bottom: 20px;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container-custom {
                padding: 20px;
                max-width: 100%;
            }

            .logo {
                max-width: 200px; /* Slightly smaller on mobile */
            }

            button {
                width: 100%;
                padding: 12px 0;
                font-size: 16px;
            }

            .record-container {
                max-width: 100%;
            }

            /* Increase touch target sizes */
            button,
            .form-control,
            .form-select {
                min-height: 44px;
                font-size: 16px;
            }

            /* Ensure checklist items stack properly on mobile */
            .checklist-item .row {
                flex-direction: column;
            }

            .checklist-item .col-md-4,
            .checklist-item .col-md-3,
            .checklist-item .col-md-2 {
                width: 100%;
            }

            .image-preview {
                max-width: 100px;
                margin-top: 10px;
            }
        }

        /* Image Preview Styles */
        .image-preview {
            max-width: 150px;
            display: block;
            margin-top: 10px;
            border: 1px solid #FFFFFF;
            border-radius: 5px;
        }

        /* Hide image upload button initially */
        .image-upload-button {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container-custom" id="form-container">
        <!-- Logo Image with Responsive Design -->
        <img src="https://i.postimg.cc/htZPjx5g/logo-89.png" alt="Logo" class="logo">
        <h1>Dairy Shed Hygiene Checklist</h1>

        <form id="hygiene-checklist-form">
            <!-- Farm Details Section -->
            <div class="section mb-4">
                <h2>Farm Details</h2>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="dairy-number">Dairy Number:</label>
                        <input type="text" class="form-control" id="dairy-number" name="dairy-number" onblur="fetchFarmDetails()">
                    </div>
                    <div class="col-md-6">
                        <label for="dairy-company">Dairy Company:</label>
                        <select id="dairy-company" name="dairy-company" class="form-select">
                            <option value="fonterra">Fonterra</option>
                            <option value="dairy-goat-coop">Dairy Goat Co-op</option>
                            <option value="green-valley">Green Valley Dairies</option>
                            <option value="maui-milk">Maui Milk</option>
                            <option value="oceania">Oceania</option>
                            <option value="ofi">OFI</option>
                            <option value="synlait">Synlait Milk LTD</option>
                            <option value="tatua">Tatua</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="address">Address:</label>
                        <input type="text" class="form-control" id="address" name="address">
                    </div>
                    <div class="col-md-6">
                        <label for="customer-name">Customer Name:</label>
                        <input type="text" class="form-control" id="customer-name" name="customer-name">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="region">Region:</label>
                        <select id="region" name="region" class="form-select">
                            <option value="northland">Northland</option>
                            <option value="auckland">Auckland</option>
                            <option value="waikato">Waikato</option>
                            <option value="bay-of-plenty">Bay of Plenty</option>
                            <option value="gisborne">Gisborne</option>
                            <option value="hawkes-bay">Hawke's Bay</option>
                            <option value="taranaki">Taranaki</option>
                            <option value="manawatu-wanganui">Manawatu-Wanganui</option>
                            <option value="wellington">Wellington</option>
                            <option value="nelson">Nelson</option>
                            <option value="marlborough">Marlborough</option>
                            <option value="west-coast">West Coast</option>
                            <option value="canterbury">Canterbury</option>
                            <option value="otago">Otago</option>
                            <option value="southland">Southland</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="farm-name">Farm Name:</label>
                        <input type="text" class="form-control" id="farm-name" name="farm-name">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="island">Island:</label>
                        <select id="island" name="island" class="form-select">
                            <option value="north-island">North Island</option>
                            <option value="south-island">South Island</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="visit-date">Visit Date:</label>
                        <input type="date" class="form-control" id="visit-date" name="visit-date">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="visit-type">Visit Type:</label>
                        <input type="text" class="form-control" id="visit-type" name="visit-type" value="Milking Plant & Milk Vat Check" readonly>
                    </div>
                    <div class="col-md-6">
                        <label for="inspection-start-time">Inspection Start Time:</label>
                        <input type="time" class="form-control" id="inspection-start-time" name="inspection-start-time">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="inspection-end-time">Inspection End Time:</label>
                        <input type="time" class="form-control" id="inspection-end-time" name="inspection-end-time">
                    </div>
                    <div class="col-md-6">
                        <label for="inspection-completed-by">Inspection Completed By:</label>
                        <input type="text" class="form-control" id="inspection-completed-by" name="inspection-completed-by">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="call-type">Call Type:</label>
                        <select id="call-type" name="call-type" class="form-select">
                            <option value="alert">Alert</option>
                            <option value="grade-call">Grade Call</option>
                            <option value="regular-scheduled-visit" selected>Regular Scheduled Visit</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Checklist Items Section -->
            <div class="section mb-4">
                <h2>Checklist Items</h2>
                <div id="checklist-items">
                    <!-- Checklist items will be dynamically added here -->
                </div>
            </div>

            <!-- Temperature Measurements Section -->
            <div class="section mb-4">
                <h2>Temperature Measurements</h2>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="hot-water-temp">Hot Water Temp (째C):</label>
                        <input type="number" step="0.1" class="form-control" id="hot-water-temp" name="hot-water-temp">
                    </div>
                    <div class="col-md-6">
                        <label for="hot-water-time">Time Taken:</label>
                        <input type="time" class="form-control" id="hot-water-time" name="hot-water-time">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="milk-temp">Milk Temp (째C):</label>
                        <input type="number" step="0.1" class="form-control" id="milk-temp" name="milk-temp">
                    </div>
                    <div class="col-md-6">
                        <label for="milk-time">Time Taken:</label>
                        <input type="time" class="form-control" id="milk-time" name="milk-time">
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-center">
                <button type="button" onclick="generatePDF()">Generate PDF</button>
                <button type="button" onclick="viewRecords()">View All Records</button>
            </div>
        </form>
        <div class="version">Version 5.4</div>
    </div>

    <!-- Records Viewing Page -->
    <div id="record-container" class="record-container" style="display: none;">
        <h2>All Dairy Shed Hygiene Records</h2>
        <div class="search-container">
            <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number" oninput="filterRecords()">
        </div>
        <div id="record-list" class="record-list"></div>
        <button class="back-button" onclick="goBack()">Back to Checklist</button>
    </div>

    <!-- Firebase and External Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- Main script -->
    <script>
        // Ensure that jsPDF is properly initialized
        const { jsPDF } = window.jspdf;

        // Firebase configuration
        // IMPORTANT: Replace the placeholders with your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const firestore = firebase.firestore();

        // Initialize IndexedDB using Dexie
        const db = new Dexie("OfflineData");
        db.version(2).stores({
            forms: "++id, dairyNumber, formData, pdfBlob",
            drafts: "++id, dairyNumber, formData, photos, timestamp"
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(err => {
                    console.error('Service Worker registration failed:', err);
                });
        }

        // Helper function to fetch and convert image to data URL
        async function fetchImageAsDataURL(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Failed to fetch the logo image.');
            }
            const blob = await response.blob();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Fetch and set the correct logo
        const logoUrl = "https://storage.googleapis.com/dairy-farm-record-system.appspot.com/Picture3.jpg?alt=media&token=c0bb53ff-e59b-4d7b-b5b1-bb7f8c8813cf";
        fetchImageAsDataURL(logoUrl)
            .then(logoDataURL => {
                document.querySelector('.logo').src = logoDataURL;
                window.correctLogoDataURL = logoDataURL; // Store globally for PDF generation
            })
            .catch(error => {
                console.error('Error fetching the correct logo:', error);
                // Fallback to default logo if needed
            });

        // Function to fetch farm details
        async function fetchFarmDetails() {
            const dairyNumber = document.getElementById('dairy-number').value;
            if (dairyNumber) {
                const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
                try {
                    if (navigator.onLine) { // Only attempt to fetch from Firebase if online
                        const url = await storageRef.getDownloadURL();
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error('Failed to fetch the farm details');
                        }
                        const data = await response.json();
                        if (data) {
                            document.getElementById('dairy-company').value = data.dairyCompany || '';
                            document.getElementById('address').value = data.address || '';
                            document.getElementById('customer-name').value = data.customerName || '';
                            document.getElementById('region').value = data.region || '';
                            document.getElementById('farm-name').value = data.farmName || '';
                            document.getElementById('island').value = data.island || '';

                            // Save fetched farm details to IndexedDB for offline use
                            await db.forms.put({
                                dairyNumber: dairyNumber,
                                formData: {
                                    'dairy-company': data.dairyCompany || '',
                                    'address': data.address || '',
                                    'customer-name': data.customerName || '',
                                    'region': data.region || '',
                                    'farm-name': data.farmName || '',
                                    'island': data.island || ''
                                },
                                pdfBlob: null,
                                timestamp: new Date().getTime()
                            });
                        }
                    } else {
                        console.log('Offline: Attempting to load farm details from IndexedDB.');
                        // Attempt to load farm details from IndexedDB
                        const offlineData = await db.forms.where('dairyNumber').equals(dairyNumber).first();
                        if (offlineData && offlineData.formData) {
                            const data = offlineData.formData;
                            document.getElementById('dairy-company').value = data['dairy-company'] || '';
                            document.getElementById('address').value = data['address'] || '';
                            document.getElementById('customer-name').value = data['customer-name'] || '';
                            document.getElementById('region').value = data['region'] || '';
                            document.getElementById('farm-name').value = data['farm-name'] || '';
                            document.getElementById('island').value = data['island'] || '';
                            console.log('Loaded farm details from IndexedDB.');
                        } else {
                            console.warn('No offline farm details available.');
                        }
                    }
                } catch (error) {
                    console.error('Error fetching farm details:', error);
                    // Attempt to load farm details from IndexedDB in case of any error
                    const offlineData = await db.forms.where('dairyNumber').equals(dairyNumber).first();
                    if (offlineData && offlineData.formData) {
                        const data = offlineData.formData;
                        document.getElementById('dairy-company').value = data['dairy-company'] || '';
                        document.getElementById('address').value = data['address'] || '';
                        document.getElementById('customer-name').value = data['customer-name'] || '';
                        document.getElementById('region').value = data['region'] || '';
                        document.getElementById('farm-name').value = data['farm-name'] || '';
                        document.getElementById('island').value = data['island'] || '';
                        console.log('Loaded farm details from IndexedDB after error.');
                    } else {
                        console.warn('No offline farm details available after error.');
                    }
                }
            }
        }

        // Function to save farm details
        async function saveFarmDetails(formData) {
            const dairyNumber = formData.get('dairy-number');
            if (dairyNumber) {
                const farmDetails = {
                    dairyCompany: formData.get('dairy-company'),
                    address: formData.get('address'),
                    customerName: formData.get('customer-name'),
                    region: formData.get('region'),
                    farmName: formData.get('farm-name'),
                    island: formData.get('island'),
                };
                const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
                const metadata = {
                    contentType: 'application/json',
                };

                try {
                    if (navigator.onLine) {
                        await storageRef.put(
                            new Blob([JSON.stringify(farmDetails)], { type: 'application/json' }),
                            metadata
                        );
                        console.log('Farm details saved successfully to Firebase.');

                        // Also save to IndexedDB
                        await db.forms.put({
                            dairyNumber: dairyNumber,
                            formData: farmDetails,
                            pdfBlob: null,
                            timestamp: new Date().getTime()
                        });
                    } else {
                        console.log('Offline: Saving farm details locally to IndexedDB.');
                        // Offline: Save farm details to IndexedDB without uploading
                        await db.forms.put({
                            dairyNumber: dairyNumber,
                            formData: farmDetails,
                            pdfBlob: null,
                            timestamp: new Date().getTime()
                        });
                    }
                } catch (error) {
                    console.error('Error saving farm details:', error);
                    if (!navigator.onLine) {
                        console.log('Offline: Farm details saved locally to IndexedDB despite error.');
                        // Attempt to save locally even if an error occurs
                        try {
                            await db.forms.put({
                                dairyNumber: dairyNumber,
                                formData: farmDetails,
                                pdfBlob: null,
                                timestamp: new Date().getTime()
                            });
                            console.log('Farm details saved locally to IndexedDB after error.');
                        } catch (dbError) {
                            console.error('Error saving farm details locally:', dbError);
                        }
                    }
                }
            }
        }

        // Function to generate PDF
        async function generatePDF() {
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const dairyNumber = formData.get('dairy-number');

            await saveFarmDetails(formData); // Save farm details if not found

            const pdf = new jsPDF('p', 'pt', 'a4');

            try {
                // Use the correct logo fetched earlier or fallback
                const embeddedLogo = window.correctLogoDataURL || "https://via.placeholder.com/250x100?text=Logo";

                const imgProps = pdf.getImageProperties(embeddedLogo);
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageMargins = 40; // Total horizontal margins (left + right)
                const imgWidth = pageWidth - pageMargins * 2; // Adjust based on desired margins
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                const x = pageMargins; // Start after left margin
                pdf.addImage(embeddedLogo, imgProps.fileType || 'PNG', x, 40, imgWidth, imgHeight);

                pdf.setFontSize(12);
                pdf.setTextColor('#000000');
                pdf.setFont('helvetica', 'bold');
                pdf.text('Farm Details:', pageMargins, 40 + imgHeight + 20);

                let currentY = 40 + imgHeight + 40;

                pdf.setFont('helvetica', 'normal');
                pdf.text(`Dairy Company: ${formData.get('dairy-company')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Dairy Number: ${formData.get('dairy-number')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Address: ${formData.get('address')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Customer Name: ${formData.get('customer-name')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Region: ${formData.get('region')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Farm Name: ${formData.get('farm-name')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Island: ${formData.get('island')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Visit Date: ${formData.get('visit-date')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Visit Type: ${formData.get('visit-type')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Inspection Start Time: ${formData.get('inspection-start-time')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Inspection End Time: ${formData.get('inspection-end-time')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Inspection Completed By: ${formData.get('inspection-completed-by')}`, pageMargins, currentY);
                currentY += 15;
                pdf.text(`Call Type: ${formData.get('call-type')}`, pageMargins, currentY);
                currentY += 30;

                // Checklist Items Section
                const checklistItemsDiv = document.getElementById('checklist-items').children;
                const checklistTable = [];
                const photos = [];

                // Load photos from IndexedDB draft
                const draft = await db.drafts.where('dairyNumber').equals(dairyNumber).first();
                const savedPhotos = draft ? draft.photos : [];

                for (let i = 0; i < checklistItemsDiv.length; i++) {
                    const item = checklistItemsDiv[i];
                    const itemName = item.querySelector('label').textContent;
                    const status = item.querySelector('select').value;
                    let comments = item.querySelector('input[type="text"]').value;

                    // Get the image data from the file inputs or from saved photos
                    const imageInput = item.querySelector('input[type="file"]');
                    const imageFiles = imageInput.files;
                    let imageDataUrls = [];

                    if (imageFiles.length > 0) {
                        // Read images from file input
                        const maxImages = Math.min(imageFiles.length, 2); // Limit to 2 images
                        for (let j = 0; j < maxImages; j++) {
                            const dataUrl = await readFileAsDataURL(imageFiles[j]);
                            imageDataUrls.push(dataUrl);
                        }
                    } else if (savedPhotos && savedPhotos.length > 0) {
                        // Find saved photos for this item
                        const photoDataArray = savedPhotos.filter(photo => photo.itemIndex === i);
                        for (const photoData of photoDataArray) {
                            const blob = new Blob([photoData.imageData], { type: photoData.imageType });
                            const dataUrl = await readBlobAsDataURL(blob);
                            imageDataUrls.push(dataUrl);
                        }
                    }

                    if (status === 'attention-required') {
                        if (imageDataUrls.length > 0) {
                            comments += " (See attached photo(s) below)";
                        }
                    }

                    checklistTable.push([itemName, status, comments]);

                    if (imageDataUrls.length > 0) {
                        // Determine the image types and prepare for PDF
                        imageDataUrls.forEach((dataUrl, index) => {
                            let imageType = dataUrl.substring(5, dataUrl.indexOf(';'));
                            if (imageType === 'image/jpeg' || imageType === 'image/jpg') {
                                imageType = 'JPEG';
                            } else if (imageType === 'image/png') {
                                imageType = 'PNG';
                            } else {
                                imageType = 'JPEG'; // Default to JPEG
                            }

                            photos.push({
                                itemIndex: i,
                                photoIndex: index,
                                imageData: dataUrl,
                                imageType: imageType,
                                title: itemName
                            });
                        });
                    }
                }

                // Generate checklist items table if not empty
                if (checklistTable.length > 0) {
                    pdf.autoTable({
                        startY: currentY,
                        head: [['Item', 'Status', 'Comments']],
                        body: checklistTable,
                        styles: {
                            fontSize: 10,
                            cellPadding: 5,
                        },
                        headStyles: {
                            fillColor: '#002B5C',
                            textColor: '#FFFFFF'
                        }
                    });
                    currentY = pdf.lastAutoTable.finalY + 20;
                } else {
                    currentY += 20;
                }

                // Add temperature data
                let tempY = currentY;

                pdf.setFont('helvetica', 'bold');
                pdf.text('Temperature Measurements:', 40, tempY);
                tempY += 20;

                pdf.setFont('helvetica', 'normal');
                const hotWaterTemp = formData.get('hot-water-temp') || '';
                const hotWaterTime = formData.get('hot-water-time') || '';
                pdf.text(`Hot Water Temp: ${hotWaterTemp} 째C`, 40, tempY);
                tempY += 15;
                pdf.text(`Time Taken: ${hotWaterTime}`, 40, tempY);
                tempY += 20;

                const milkTemp = formData.get('milk-temp') || '';
                const milkTime = formData.get('milk-time') || '';
                pdf.text(`Milk Temp: ${milkTemp} 째C`, 40, tempY);
                tempY += 15;
                pdf.text(`Time Taken: ${milkTime}`, 40, tempY);
                tempY += 20;

                // Add photos after the temperature data
                let photoY = tempY + 20; // Adjust as needed

                // Group photos by checklist item
                const photosByItem = {};
                photos.forEach(photo => {
                    if (!photosByItem[photo.itemIndex]) {
                        photosByItem[photo.itemIndex] = [];
                    }
                    photosByItem[photo.itemIndex].push(photo);
                });

                for (let i = 0; i < checklistItemsDiv.length; i++) {
                    const itemPhotos = photosByItem[i];
                    if (itemPhotos && itemPhotos.length > 0) {
                        // Handle up to 2 photos per item
                        const maxPhotos = Math.min(itemPhotos.length, 2);
                        for (let p = 0; p < maxPhotos; p++) {
                            const photo = itemPhotos[p];
                            if (photoY > pdf.internal.pageSize.getHeight() - 220) {
                                // If we're getting close to the end of the page, add a new page
                                pdf.addPage();
                                photoY = 60; // Reset Y position for the new page
                            }

                            try {
                                pdf.addImage(photo.imageData, photo.imageType, 40, photoY, 250, 200); // Adjust the size to fit more photos
                                pdf.setFontSize(12);
                                pdf.text(photo.title, 40, photoY - 10); // Add the title above the photo
                                photoY += 220; // Move Y position down for the next photo (image height + spacing)
                            } catch (error) {
                                console.error('Error adding image to PDF:', error);
                            }
                        }
                    }
                }

                // Save PDF and handle upload based on connectivity
                const pdfBlob = pdf.output('blob');

                if (navigator.onLine) {
                    // Online Mode
                    // Upload to Firebase
                    uploadPDF(dairyNumber, pdfBlob);

                    // Display PDF to user
                    pdf.save('Dairy_Shed_Hygiene_Checklist.pdf');

                    // Option A: Delete All Drafts After Submission
                    await db.drafts.clear();
                    console.log('All drafts have been cleared after submission.');
                } else {
                    // Offline Mode
                    // Save PDF and form data to 'forms' store
                    const formObject = {};
                    for (const [key, value] of formData.entries()) {
                        formObject[key] = value;
                    }

                    await db.forms.put({
                        dairyNumber: dairyNumber,
                        formData: formObject,
                        pdfBlob: pdfBlob,
                        timestamp: new Date().getTime()
                    });
                    console.log('Form data and PDF saved locally for later upload.');

                    // Display PDF to user in a new tab
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    window.open(pdfUrl, '_blank');

                    // Do not clear drafts
                }
            } catch (error) {
                console.error('Error generating PDF:', error);
            }

            function uploadPDF(dairyNumber, pdfBlob) {
                console.log('uploadPDF function called with dairyNumber:', dairyNumber);

                const timestamp = new Date().toISOString().split('T')[0];
                const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
                const storageRef = storage.ref(`customers/${dairyNumber}/${fileName}`);

                console.log(`Uploading PDF to path: customers/${dairyNumber}/${fileName}`);

                storageRef.put(pdfBlob).then(() => {
                    console.log('PDF uploaded successfully');
                }).catch((error) => {
                    console.error('Error uploading PDF:', error);
                });
            }
        }

        // Sync data with Firebase when online
        window.addEventListener('online', syncDataWithFirebase);

        async function syncDataWithFirebase() {
            console.log('Device is online. Syncing data with Firebase.');

            // Sync drafts
            const drafts = await db.drafts.toArray();
            for (const draft of drafts) {
                const dairyNumber = draft.dairyNumber;
                const pdfBlob = draft.pdfBlob; // Assuming pdfBlob is stored in drafts

                if (pdfBlob) {
                    // Upload the PDF
                    uploadPDF(dairyNumber, pdfBlob);
                }

                // Remove the draft after uploading
                await db.drafts.delete(draft.id);
                console.log(`Draft with ID ${draft.id} uploaded and deleted.`);
            }

            // Sync forms (offline-generated PDFs)
            const offlineForms = await db.forms.toArray();

            for (const record of offlineForms) {
                const dairyNumber = record.dairyNumber;
                const pdfBlob = record.pdfBlob;

                uploadPDF(dairyNumber, pdfBlob);

                // Remove the record from IndexedDB after uploading
                await db.forms.delete(record.id);
                console.log(`Offline form with ID ${record.id} uploaded and deleted.`);
            }

            console.log('All offline data has been synced with Firebase.');
        }

        // Function to create checklist items
        function createChecklistItems() {
            const checklistItems = [
                "Pulsator Airline", "Long Bend Elbows", "Automatic Cup and Remover", "Diaphragm", "Receiving Can",
                "Sanitary Trap", "Main Milk Line", "Milk Line Seals in Good Condition", "Stainless Droppers", "Long Milk Rubber",
                "Liner", "Cluster", "Cluster Seal", "Cluster Button", "Non Return Valve at Milk Pump", "Milk Pump",
                "Filter Housing", "Plate Cooler", "Interceptor", "Receiver Airline", "Flushing Pulsator", "Air Purge Valve",
                "Vacuum Level", "Main Airline", "Plant Drainage - Milk Pump", "Plant Drainage - Filter/s", "Plant Drainage - Plate Cooler",
                "Plant Drainage - Vat Entry", "Plant Wash Tap", "Wash Jetters", "Centre Gland", "Test Bucket",
                "Inlet Valve", "Non-Return Valve", "Spray Ball", "Agitator", "Silo Door", "Manhole Seal", "Vat Outlet", "Walls in Silo"
            ];

            const itemsToAutoFill = [
                "Inlet Valve",
                "Non-Return Valve",
                "Spray Ball",
                "Agitator",
                "Silo Door",
                "Manhole Seal",
                "Vat Outlet",
                "Walls in Silo"
            ];

            const checklistContainer = document.getElementById('checklist-items');
            checklistContainer.innerHTML = '';

            checklistItems.forEach((item, index) => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('checklist-item');

                const row = document.createElement('div');
                row.classList.add('row', 'align-items-center');

                // Label Column
                const labelCol = document.createElement('div');
                labelCol.classList.add('col-md-4', 'col-12', 'mb-2');
                const label = document.createElement('label');
                label.textContent = item;
                labelCol.appendChild(label);
                row.appendChild(labelCol);

                // Status Select Column
                const statusCol = document.createElement('div');
                statusCol.classList.add('col-md-3', 'col-6', 'mb-2');
                const statusSelect = document.createElement('select');
                statusSelect.classList.add('form-select');
                statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
                statusCol.appendChild(statusSelect);
                row.appendChild(statusCol);

                // Comments Input Column
                const commentsCol = document.createElement('div');
                commentsCol.classList.add('col-md-3', 'col-6', 'mb-2');
                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.classList.add('form-control');
                commentsInput.placeholder = 'Comments';
                commentsCol.appendChild(commentsInput);
                row.appendChild(commentsCol);

                // Image Upload Button Column
                const imageCol = document.createElement('div');
                imageCol.classList.add('col-md-2', 'col-12', 'mb-2');
                const imageButton = document.createElement('button');
                imageButton.type = 'button';
                imageButton.classList.add('btn', 'btn-secondary', 'btn-sm', 'w-100', 'image-upload-button');
                imageButton.textContent = 'Upload Photo';
                imageCol.appendChild(imageButton);
                row.appendChild(imageCol);

                // Image Upload File Input
                const imageInput = document.createElement('input');
                imageInput.type = 'file';
                imageInput.accept = 'image/*';
                imageInput.style.display = 'none';
                imageInput.multiple = true; // Allow multiple images
                imageInput.classList.add('form-control', 'mt-2');
                itemContainer.appendChild(imageInput);

                // Image Previews Container
                const imagePreviewsContainer = document.createElement('div');
                imagePreviewsContainer.classList.add('image-previews-container');
                itemContainer.appendChild(imagePreviewsContainer);

                // Event Listeners
                statusSelect.addEventListener('change', () => {
                    if (statusSelect.value === 'attention-required') {
                        imageButton.style.display = 'block';
                    } else {
                        imageButton.style.display = 'none';
                        imageInput.value = '';
                        imagePreviewsContainer.innerHTML = ''; // Clear previews
                    }

                    if (statusSelect.value === 'not-checked' && itemsToAutoFill.includes(item)) {
                        commentsInput.value = "Milk in Vat";
                    } else if (commentsInput.value === "Milk in Vat") {
                        commentsInput.value = ""; // Clear the field if it was auto-filled
                    }
                    saveFormData();
                });

                imageButton.addEventListener('click', () => {
                    imageInput.click();
                });

                imageInput.addEventListener('change', (event) => {
                    imagePreviewsContainer.innerHTML = ''; // Clear previous previews
                    const files = Array.from(event.target.files).slice(0, 2); // Limit to 2 images
                    files.forEach(file => {
                        const imageUrl = URL.createObjectURL(file);
                        const imgPreview = document.createElement('img');
                        imgPreview.src = imageUrl;
                        imgPreview.classList.add('image-preview');
                        imagePreviewsContainer.appendChild(imgPreview);
                    });
                    saveFormData();
                });

                // Save form data on input
                statusSelect.addEventListener('change', saveFormData);
                commentsInput.addEventListener('input', saveFormData);
                imageInput.addEventListener('change', saveFormData);

                itemContainer.appendChild(row);
                checklistContainer.appendChild(itemContainer);
            });
        }

        // Function to save form data to IndexedDB
        async function saveFormData() {
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const formObject = {};

            // Save standard form fields
            for (const [key, value] of formData.entries()) {
                formObject[key] = value;
            }

            // Save checklist items and photos
            const checklistItemsDiv = document.getElementById('checklist-items').children;
            const checklistData = [];
            const photos = [];

            for (let i = 0; i < checklistItemsDiv.length; i++) {
                const item = checklistItemsDiv[i];
                const itemName = item.querySelector('label').textContent;
                const status = item.querySelector('select').value;
                const comments = item.querySelector('input[type="text"]').value;
                const imageInput = item.querySelector('input[type="file"]');
                const imageFiles = imageInput.files;

                const hasImages = imageFiles.length > 0;

                if (hasImages) {
                    const files = Array.from(imageFiles).slice(0, 2); // Limit to 2 images
                    for (let j = 0; j < files.length; j++) {
                        const imageFile = files[j];
                        const imageData = await readFileAsArrayBuffer(imageFile);
                        photos.push({
                            itemIndex: i,
                            photoIndex: j,
                            imageData: imageData,
                            imageType: imageFile.type
                        });
                    }
                }

                checklistData.push({
                    itemName: itemName,
                    status: status,
                    comments: comments,
                    hasImages: hasImages
                });
            }

            formObject['checklistData'] = checklistData;

            const dairyNumber = formObject['dairy-number'] || 'unknown';

            // Save the form data and photos to IndexedDB
            await db.drafts.put({
                dairyNumber: dairyNumber,
                formData: formObject,
                photos: photos,
                timestamp: new Date().getTime()
            });
        }

        // Function to populate form with saved data
        async function populateForm(data) {
            const form = document.getElementById('hygiene-checklist-form');

            // Populate standard form fields
            for (const [key, value] of Object.entries(data.formData)) {
                if (key !== 'checklistData') {
                    const field = form.elements[key];
                    if (field) {
                        field.value = value;
                    }
                }
            }

            // Populate checklist items
            if (data.formData.checklistData) {
                const checklistItemsDiv = document.getElementById('checklist-items').children;

                for (let i = 0; i < checklistItemsDiv.length; i++) {
                    const item = checklistItemsDiv[i];
                    const checklistItemData = data.formData.checklistData[i];

                    const statusSelect = item.querySelector('select');
                    const commentsInput = item.querySelector('input[type="text"]');
                    const imageInput = item.querySelector('input[type="file"]');
                    const imagePreviewsContainer = item.querySelector('.image-previews-container');
                    const imageButton = item.querySelector('.image-upload-button');

                    if (statusSelect && commentsInput && checklistItemData) {
                        statusSelect.value = checklistItemData.status;
                        commentsInput.value = checklistItemData.comments;

                        if (checklistItemData.hasImages) {
                            const photoDataArray = data.photos.filter(photo => photo.itemIndex === i);
                            imagePreviewsContainer.innerHTML = '';
                            for (const photoData of photoDataArray) {
                                const blob = new Blob([photoData.imageData], { type: photoData.imageType });
                                const imageUrl = URL.createObjectURL(blob);

                                const imgPreview = document.createElement('img');
                                imgPreview.src = imageUrl;
                                imgPreview.classList.add('image-preview');
                                imagePreviewsContainer.appendChild(imgPreview);
                            }

                            // Show the upload button if necessary
                            if (checklistItemData.status === 'attention-required') {
                                imageButton.style.display = 'block';
                            }
                        }
                    }
                }
            }
        }

        // Helper functions to read files
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    resolve(event.target.result);
                };
                reader.onerror = function (error) {
                    reject(error);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function readBlobAsDataURL(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    resolve(event.target.result);
                };
                reader.onerror = function (error) {
                    reject(error);
                };
                reader.readAsDataURL(blob);
            });
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    resolve(event.target.result);
                };
                reader.onerror = function (error) {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }

        // View Records Functions

        function viewRecords() {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('record-container').style.display = 'block';
            loadAllRecords();
        }

        async function loadAllRecords() {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const storageRef = storage.ref('customers');

            try {
                if (navigator.onLine) {
                    const folderSnapshot = await storageRef.listAll();
                    folderSnapshot.prefixes.forEach(folderRef => {
                        const dairyNumber = folderRef.name;
                        const folderLink = document.createElement('a');
                        folderLink.textContent = dairyNumber;
                        folderLink.href = '#';
                        folderLink.classList.add('d-block', 'mb-2');
                        folderLink.addEventListener('click', () => {
                            loadRecordFiles(dairyNumber);
                        });
                        recordList.appendChild(folderLink);
                    });
                } else {
                    console.log('Offline: Loading records from IndexedDB.');
                    const offlineForms = await db.forms.toArray();
                    const dairyNumbers = [...new Set(offlineForms.map(record => record.dairyNumber))];
                    dairyNumbers.forEach(dairyNumber => {
                        const fileLink = document.createElement('a');
                        fileLink.textContent = `${dairyNumber} (Offline)`;
                        fileLink.href = '#';
                        fileLink.classList.add('d-block', 'mb-2');
                        fileLink.addEventListener('click', () => {
                            displayOfflineRecords(dairyNumber);
                        });
                        recordList.appendChild(fileLink);
                    });
                }
            } catch (error) {
                console.error('Error fetching records:', error);
                // Optionally, load records from IndexedDB when offline
                if (!navigator.onLine) {
                    console.log('Offline: Loading records from IndexedDB.');
                    const offlineForms = await db.forms.toArray();
                    const dairyNumbers = [...new Set(offlineForms.map(record => record.dairyNumber))];
                    dairyNumbers.forEach(dairyNumber => {
                        const fileLink = document.createElement('a');
                        fileLink.textContent = `${dairyNumber} (Offline)`;
                        fileLink.href = '#';
                        fileLink.classList.add('d-block', 'mb-2');
                        fileLink.addEventListener('click', () => {
                            displayOfflineRecords(dairyNumber);
                        });
                        recordList.appendChild(fileLink);
                    });
                }
            }
        }

        async function loadRecordFiles(dairyNumber) {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const storageRef = storage.ref(`customers/${dairyNumber}`);

            try {
                if (navigator.onLine) {
                    const fileSnapshot = await storageRef.listAll();
                    fileSnapshot.items.forEach(fileRef => {
                        const fileName = fileRef.name;
                        const dateOnly = fileName.match(/(\d{4}-\d{2}-\d{2})/);
                        const displayName = dateOnly ? dateOnly[0] : fileName;

                        const fileLink = document.createElement('a');
                        fileLink.textContent = displayName;
                        fileLink.href = '#';
                        fileLink.classList.add('d-block', 'mb-2');
                        fileLink.addEventListener('click', async () => {
                            try {
                                const url = await fileRef.getDownloadURL();
                                window.open(url, '_blank');
                            } catch (error) {
                                console.error('Error fetching file:', error);
                            }
                        });
                        recordList.appendChild(fileLink);
                    });
                } else {
                    console.log('Offline: Loading records from IndexedDB.');
                    displayOfflineRecords(dairyNumber);
                }

                const backButton = document.createElement('button');
                backButton.textContent = 'Back to Records';
                backButton.className = 'back-button';
                backButton.addEventListener('click', goBackToRecords);
                recordList.appendChild(backButton);
            } catch (error) {
                console.error('Error fetching record files:', error);
                // Optionally, load records from IndexedDB when offline
                if (!navigator.onLine) {
                    console.log('Offline: Loading records from IndexedDB.');
                    displayOfflineRecords(dairyNumber);
                }
            }
        }

        function goBack() {
            document.getElementById('form-container').style.display = 'block';
            document.getElementById('record-container').style.display = 'none';
        }

        function goBackToRecords() {
            loadAllRecords();
        }

        function filterRecords() {
            const searchInput = document.getElementById('search-dairy-number').value.toLowerCase();
            const recordList = document.getElementById('record-list');
            const records = recordList.getElementsByTagName('a');

            for (let i = 0; i < records.length; i++) {
                const record = records[i];
                const textValue = record.textContent || record.innerText;
                if (textValue.toLowerCase().indexOf(searchInput) > -1) {
                    record.style.display = "";
                } else {
                    record.style.display = "none";
                }
            }
        }

        // Function to display offline records from IndexedDB
        async function displayOfflineRecords(dairyNumber) {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const offlineForms = await db.forms.where('dairyNumber').equals(dairyNumber).toArray();

            offlineForms.forEach(record => {
                const fileName = `Offline Form - ${new Date(record.timestamp).toLocaleString()}`;
                const fileLink = document.createElement('a');
                fileLink.textContent = fileName;
                fileLink.href = '#';
                fileLink.classList.add('d-block', 'mb-2');
                fileLink.addEventListener('click', () => {
                    displayOfflinePDF(record);
                });
                recordList.appendChild(fileLink);
            });

            const backButton = document.createElement('button');
            backButton.textContent = 'Back to Records';
            backButton.className = 'back-button';
            backButton.addEventListener('click', goBackToRecords);
            recordList.appendChild(backButton);
        }

        // Function to display offline PDF from IndexedDB
        async function displayOfflinePDF(record) {
            try {
                const pdfBlob = record.pdfBlob;
                const pdfUrl = URL.createObjectURL(pdfBlob);
                window.open(pdfUrl, '_blank');
            } catch (error) {
                console.error('Error displaying offline PDF:', error);
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            createChecklistItems();

            // Get all drafts from IndexedDB
            let drafts = await db.drafts.toArray();

            // Get the current time in milliseconds
            const now = new Date().getTime();

            // Define the time limit (2 hours in milliseconds)
            const twoHoursInMillis = 2 * 60 * 60 * 1000;

            // Delete drafts older than 2 hours
            for (const draft of drafts) {
                if (now - draft.timestamp > twoHoursInMillis) {
                    await db.drafts.delete(draft.id);
                    console.log(`Deleted draft with ID ${draft.id} due to expiration.`);
                }
            }

            // Reload the drafts after deletion
            drafts = await db.drafts.toArray();

            if (drafts.length > 0) {
                const recentDraft = drafts[drafts.length - 1];
                const resume = confirm('You have an unsaved checklist. Would you like to resume?');
                if (resume) {
                    await populateForm(recentDraft);
                } else {
                    await db.drafts.delete(recentDraft.id);
                    console.log('Draft deleted as per user choice.');
                }
            }
        });
    </script>
</body>

</html>
