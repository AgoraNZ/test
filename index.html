<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta tags and CSS links -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Shed Hygiene Checklist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <!-- Your existing styles here -->
    <style>
        /* [Your existing styles here] */
        body {
            background-color: #002B5C;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }

        .container {
            background-color: #002B5C;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
        }

        h1,
        h2 {
            color: #a7ab01;
            text-align: center;
        }

        h1 {
            margin-bottom: 40px;
        }

        label {
            margin-top: 10px;
        }

        button {
            background-color: #FF851B;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            border-radius: 5px;
        }

        button:hover {
            background-color: #FF4136;
        }

        .checklist-item {
            margin-bottom: 30px;
        }

        .form-control,
        .form-select {
            margin-top: 5px;
        }

        .version {
            text-align: center;
            margin-top: 20px;
            color: #FFFFFF;
            font-size: 12px;
        }

        .logo {
            display: block;
            margin: 0 auto 20px;
            width: 250px;
        }

        .record-container {
            background-color: #FFFFFF;
            color: #000000;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            max-width: 1000px;
            width: 100%;
            margin: 20px auto;
        }

        .record-container h2 {
            color: #002B5C;
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-list a {
            text-decoration: none;
            color: #007bff;
            display: block;
            margin-bottom: 10px;
        }

        .back-button {
            margin-top: 20px;
            background-color: #002B5C;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .search-container {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container" id="form-container">
        <img src="https://i.postimg.cc/htZPjx5g/logo-89.png" alt="Logo" class="logo">
        <h1>Dairy Shed Hygiene Checklist</h1>

        <form id="hygiene-checklist-form">
            <!-- Form Fields -->
            <!-- Farm Details Section -->
            <div class="section mb-4">
                <h2>Farm Details</h2>

                <label for="dairy-number">Dairy Number:</label>
                <input type="text"
                       class="form-control"
                       id="dairy-number"
                       name="dairy-number"
                       onblur="onDairyNumberBlur()"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <!-- Single Editable Drop-Down (datalist) for Dairy Company -->
                <label for="dairy-company">Dairy Company:</label>
                <input type="text"
                       class="form-control"
                       id="dairy-company"
                       name="dairy-company"
                       list="dairy-company-list"
                       placeholder="Type or select..."
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">
                <datalist id="dairy-company-list"></datalist>

                <label for="address">Address:</label>
                <input type="text"
                       class="form-control"
                       id="address"
                       name="address"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="customer-name">Customer Name:</label>
                <input type="text"
                       class="form-control"
                       id="customer-name"
                       name="customer-name"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="region">Region:</label>
                <select id="region" name="region" class="form-select">
                    <option value="northland">Northland</option>
                    <option value="auckland">Auckland</option>
                    <option value="waikato">Waikato</option>
                    <option value="bay-of-plenty">Bay of Plenty</option>
                    <option value="gisborne">Gisborne</option>
                    <option value="hawkes-bay">Hawke's Bay</option>
                    <option value="taranaki">Taranaki</option>
                    <option value="manawatu-wanganui">Manawatu-Wanganui</option>
                    <option value="wellington">Wellington</option>
                    <option value="nelson">Nelson</option>
                    <option value="marlborough">Marlborough</option>
                    <option value="west-coast">West Coast</option>
                    <option value="canterbury">Canterbury</option>
                    <option value="otago">Otago</option>
                    <option value="southland">Southland</option>
                </select>

                <label for="farm-name">Farm Name:</label>
                <input type="text"
                       class="form-control"
                       id="farm-name"
                       name="farm-name"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="island">Island:</label>
                <select id="island" name="island" class="form-select">
                    <option value="north-island">North Island</option>
                    <option value="south-island">South Island</option>
                </select>

                <label for="visit-date">Visit Date:</label>
                <input type="date"
                       class="form-control"
                       id="visit-date"
                       name="visit-date">

                <label for="visit-type">Visit Type:</label>
                <input type="text"
                       class="form-control"
                       id="visit-type"
                       name="visit-type"
                       value="Milking Plant & Milk Vat Check"
                       readonly
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="inspection-start-time">Inspection Start Time:</label>
                <input type="time"
                       class="form-control"
                       id="inspection-start-time"
                       name="inspection-start-time">

                <label for="inspection-end-time">Inspection End Time:</label>
                <input type="time"
                       class="form-control"
                       id="inspection-end-time"
                       name="inspection-end-time">

                <label for="inspection-completed-by">Inspection Completed By:</label>
                <input type="text"
                       class="form-control"
                       id="inspection-completed-by"
                       name="inspection-completed-by"
                       autocapitalize="words"
                       autocorrect="off"
                       spellcheck="false">

                <label for="call-type">Call Type:</label>
                <select id="call-type" name="call-type" class="form-select">
                    <option value="alert">Alert</option>
                    <option value="grade-call">Grade Call</option>
                    <option value="regular-scheduled-visit" selected>Regular Scheduled Visit</option>
                </select>
            </div>

            <!-- Health & Safety Section -->
            <div class="section mb-4">
                <h2>Health & Safety</h2>
                <div id="health-safety-top"></div>
            </div>

            <!-- Checklist Items Section -->
            <div class="section mb-4">
                <h2>Checklist Items</h2>
                <div id="checklist-items">
                    <!-- Main Checklist items will be dynamically added here -->
                </div>
            </div>

            <!-- Additional Checks: Teat Spray Check & Chemical Check -->
            <div class="section mb-4">
                <h2>Additional Checks</h2>
                <div id="additional-checks"></div>
            </div>

            <!-- Temperature Measurements Section -->
            <div class="section mb-4">
                <h2>Temperature Measurements</h2>
                <div class="checklist-item">
                    <label for="hot-water-temp">Hot Water Temp (Â°C):</label>
                    <input type="text"
                           class="form-control"
                           id="hot-water-temp"
                           name="hot-water-temp"
                           step="0.1"
                           autocapitalize="words"
                           autocorrect="off"
                           spellcheck="false">
                    <label for="hot-water-time">Time Taken:</label>
                    <input type="time" class="form-control" id="hot-water-time" name="hot-water-time">
                </div>
                <div class="checklist-item">
                    <label for="milk-temp">Milk Temp (Â°C):</label>
                    <input type="text"
                           class="form-control"
                           id="milk-temp"
                           name="milk-temp"
                           step="0.1"
                           autocapitalize="words"
                           autocorrect="off"
                           spellcheck="false">
                    <label for="milk-time">Time Taken:</label>
                    <input type="time" class="form-control" id="milk-time" name="milk-time">
                </div>
            </div>

            <button type="button" onclick="generatePDF()">Generate PDF</button>
            <button type="button" onclick="viewRecords()">View All Records</button>
        </form>
        <div class="version">Version 5.4</div>
    </div>

    <!-- Records Viewing Page -->
    <div id="record-container" class="record-container" style="display: none;">
        <h2>All Dairy Shed Hygiene Records</h2>
        <div class="search-container">
            <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number" oninput="filterRecords()">
        </div>
        <div id="record-list" class="record-list"></div>
        <button class="back-button" onclick="goBack()">Back to Checklist</button>
    </div>

    <!-- Include scripts at the end of the body for better performance -->
    <!-- Include Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- Include external libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- Your main script -->
    <script>
        // Ensure that jsPDF is properly initialized
        const { jsPDF } = window.jspdf;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
            authDomain: "dairy-farm-record-system.firebaseapp.com",
            projectId: "dairy-farm-record-system",
            storageBucket: "dairy-farm-record-system.appspot.com",
            messagingSenderId: "422124188212",
            appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const firestore = firebase.firestore();

        // Initialize IndexedDB using Dexie
        // We'll store forms by dairyNumber as the 'id', plus creationTime for 1hr expiry
        // Also store user-defined dairy companies in a separate table
        // Also store teatSprayRatios for new ratios
        const db = new Dexie("OfflineData");
        db.version(3).stores({
            forms: "dairyNumber",       // each record: { dairyNumber, formData, images, creationTime }
            dairyCompanies: "++id, name",
            teatSprayRatios: "++id, ratio"
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(err => {
                    console.error('Service Worker registration failed:', err);
                });
        }

        /****************** 1. DAIRY COMPANY DATALIST SETUP ******************/
        async function setupDairyCompanyDatalist() {
            // Default companies
            const defaultCompanies = [
                "Fonterra",
                "Dairy Goat Co-op",
                "Green Valley Dairies",
                "Maui Milk",
                "Oceania",
                "OFI",
                "Synlait Milk LTD",
                "Tatua"
            ];
            // Load user-added companies from Dexie
            const userCompanies = await db.dairyCompanies.toArray();
            const allCompanies = [...defaultCompanies];

            userCompanies.forEach(u => {
                if (!allCompanies.includes(u.name)) {
                    allCompanies.push(u.name);
                }
            });

            // Populate the datalist
            const datalist = document.getElementById('dairy-company-list');
            datalist.innerHTML = ""; // Clear old
            allCompanies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                datalist.appendChild(opt);
            });

            // On blur, if new value not in allCompanies, add it
            const dairyCompanyInput = document.getElementById('dairy-company');
            dairyCompanyInput.addEventListener('blur', async () => {
                const typedValue = dairyCompanyInput.value.trim();
                if (typedValue && !allCompanies.includes(typedValue)) {
                    // Save to Dexie
                    await db.dairyCompanies.add({ name: typedValue });
                    allCompanies.push(typedValue);
                    // Also add to datalist
                    const newOpt = document.createElement('option');
                    newOpt.value = typedValue;
                    datalist.appendChild(newOpt);
                }
            });
        }

        /****************** 2. CREATE CHECKLIST ITEMS ******************/
        function createHealthSafetyItems(containerId) {
            const itemContainer = document.createElement('div');
            itemContainer.classList.add('checklist-item');

            const label = document.createElement('label');
            label.textContent = "Health & Safety";
            itemContainer.appendChild(label);

            const statusSelect = document.createElement('select');
            statusSelect.classList.add('form-select');
            statusSelect.name = `status-health-safety-${containerId}`;
            statusSelect.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
            itemContainer.appendChild(statusSelect);

            const commentsInput = document.createElement('input');
            commentsInput.type = 'text';
            commentsInput.classList.add('form-control');
            commentsInput.name = `comments-health-safety-${containerId}`;
            commentsInput.placeholder = 'Comments';
            commentsInput.setAttribute('autocapitalize','words');
            commentsInput.setAttribute('autocorrect','off');
            commentsInput.setAttribute('spellcheck','false');
            itemContainer.appendChild(commentsInput);

            // Image upload
            const imageUpload1 = document.createElement('input');
            imageUpload1.type = 'file';
            imageUpload1.classList.add('form-control', 'image-upload');
            imageUpload1.style.display = 'none';
            itemContainer.appendChild(imageUpload1);

            const imageUpload2 = document.createElement('input');
            imageUpload2.type = 'file';
            imageUpload2.classList.add('form-control', 'image-upload');
            imageUpload2.style.display = 'none';
            itemContainer.appendChild(imageUpload2);

            statusSelect.addEventListener('change', () => {
                if (statusSelect.value === 'attention-required') {
                    imageUpload1.style.display = 'block';
                    imageUpload2.style.display = 'block';
                } else {
                    imageUpload1.style.display = 'none';
                    imageUpload2.style.display = 'none';
                }
            });

            document.getElementById(containerId).appendChild(itemContainer);
        }

        function createChecklistItems() {
            const checklistItems = [
                "Pulsator Airline", "Long Bend Elbows", "Automatic Cup and Remover", "Diaphragm", "Receiving Can",
                "Sanitary Trap", "Main Milk Line", "Milk Line Seals in Good Condition", "Stainless Droppers", "Long Milk Rubber",
                "Liner", "Cluster", "Cluster Seal", "Cluster Button", "Non Return Valve at Milk Pump", "Milk Pump",
                "Filter Housing", "Plate Cooler", "Interceptor", "Receiver Airline", "Flushing Pulsator", "Air Purge Valve",
                "Vacuum Level", "Main Airline", "Plant Drainage - Milk Pump", "Plant Drainage - Filter/s", "Plant Drainage - Plate Cooler",
                "Plant Drainage - Vat Entry", "Plant Wash Tap", "Wash Jetters", "Centre Gland", "Test Bucket",
                "Inlet Valve", "Non-Return Valve", "Spray Ball", "Agitator", "Silo Door", "Manhole Seal", "Vat Outlet", "Walls in Silo"
            ];

            const itemsToAutoFill = [
                "Inlet Valve",
                "Non-Return Valve",
                "Spray Ball",
                "Agitator",
                "Silo Door",
                "Manhole Seal",
                "Vat Outlet",
                "Walls in Silo"
            ];

            const checklistContainer = document.getElementById('checklist-items');
            checklistContainer.innerHTML = '';

            checklistItems.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('checklist-item');

                const label = document.createElement('label');
                label.textContent = item;
                itemContainer.appendChild(label);

                const statusSelect = document.createElement('select');
                statusSelect.classList.add('form-select');
                statusSelect.name = `status-${item}`;
                statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
                itemContainer.appendChild(statusSelect);

                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.classList.add('form-control');
                commentsInput.name = `comments-${item}`;
                commentsInput.placeholder = 'Comments';
                commentsInput.setAttribute('autocapitalize','words');
                commentsInput.setAttribute('autocorrect','off');
                commentsInput.setAttribute('spellcheck','false');
                itemContainer.appendChild(commentsInput);

                // Create first image upload input
                const imageUpload1 = document.createElement('input');
                imageUpload1.type = 'file';
                imageUpload1.classList.add('form-control', 'image-upload');
                imageUpload1.style.display = 'none';
                itemContainer.appendChild(imageUpload1);

                // Create second image upload input
                const imageUpload2 = document.createElement('input');
                imageUpload2.type = 'file';
                imageUpload2.classList.add('form-control', 'image-upload');
                imageUpload2.style.display = 'none';
                itemContainer.appendChild(imageUpload2);

                statusSelect.addEventListener('change', () => {
                    if (statusSelect.value === 'attention-required') {
                        imageUpload1.style.display = 'block';
                        imageUpload2.style.display = 'block';
                    } else {
                        imageUpload1.style.display = 'none';
                        imageUpload2.style.display = 'none';
                    }
                    if (statusSelect.value === 'not-checked' && itemsToAutoFill.includes(item)) {
                        commentsInput.value = "Milk in Vat";
                    } else if (commentsInput.value === "Milk in Vat") {
                        commentsInput.value = ""; // Clear if it was auto-filled
                    }
                });

                checklistContainer.appendChild(itemContainer);
            });
        }

        async function createAdditionalChecks() {
            const additionalContainer = document.getElementById('additional-checks');
            additionalContainer.innerHTML = '';

            // Teat Spray Check
            const teatSprayContainer = document.createElement('div');
            teatSprayContainer.classList.add('checklist-item');

            const labelTeat = document.createElement('label');
            labelTeat.textContent = "Teat Spray Check";
            teatSprayContainer.appendChild(labelTeat);

            const statusSelectTeat = document.createElement('select');
            statusSelectTeat.classList.add('form-select');
            statusSelectTeat.name = "status-teat-spray-check";
            statusSelectTeat.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
            teatSprayContainer.appendChild(statusSelectTeat);

            const commentsInputTeat = document.createElement('input');
            commentsInputTeat.type = 'text';
            commentsInputTeat.classList.add('form-control');
            commentsInputTeat.name = "comments-teat-spray-check";
            commentsInputTeat.placeholder = 'Comments';
            commentsInputTeat.setAttribute('autocapitalize','words');
            commentsInputTeat.setAttribute('autocorrect','off');
            commentsInputTeat.setAttribute('spellcheck','false');
            teatSprayContainer.appendChild(commentsInputTeat);

            const imageUploadTeat1 = document.createElement('input');
            imageUploadTeat1.type = 'file';
            imageUploadTeat1.classList.add('form-control', 'image-upload');
            imageUploadTeat1.style.display = 'none';
            teatSprayContainer.appendChild(imageUploadTeat1);

            const imageUploadTeat2 = document.createElement('input');
            imageUploadTeat2.type = 'file';
            imageUploadTeat2.classList.add('form-control', 'image-upload');
            imageUploadTeat2.style.display = 'none';
            teatSprayContainer.appendChild(imageUploadTeat2);

            statusSelectTeat.addEventListener('change', () => {
                if (statusSelectTeat.value === 'attention-required') {
                    imageUploadTeat1.style.display = 'block';
                    imageUploadTeat2.style.display = 'block';
                } else {
                    imageUploadTeat1.style.display = 'none';
                    imageUploadTeat2.style.display = 'none';
                }
            });

            // Dilution rate
            const ratioContainer = document.createElement('div');
            ratioContainer.classList.add('mt-2');
            const ratioSelect = document.createElement('select');
            ratioSelect.classList.add('form-select', 'teat-dilution-select');
            ratioSelect.innerHTML = `<option value="1:4">1:4</option>`;
            // Load existing ratios
            const existingRatios = await db.teatSprayRatios.toArray();
            existingRatios.forEach(r => {
                if (r.ratio !== '1:4') {
                    const opt = document.createElement('option');
                    opt.value = r.ratio;
                    opt.textContent = r.ratio;
                    ratioSelect.appendChild(opt);
                }
            });
            ratioContainer.appendChild(ratioSelect);

            const ratioInput = document.createElement('input');
            ratioInput.type = 'text';
            ratioInput.placeholder = 'Enter new ratio e.g. 1:5';
            ratioInput.classList.add('form-control', 'mt-2', 'teat-dilution-input');
            ratioInput.setAttribute('autocapitalize','words');
            ratioInput.setAttribute('autocorrect','off');
            ratioInput.setAttribute('spellcheck','false');
            ratioInput.addEventListener('blur', async () => {
                const newRatio = ratioInput.value.trim();
                if (newRatio && !Array.from(ratioSelect.options).some(opt => opt.value === newRatio)) {
                    await db.teatSprayRatios.add({ ratio: newRatio });
                    const newOpt = document.createElement('option');
                    newOpt.value = newRatio;
                    newOpt.textContent = newRatio;
                    ratioSelect.appendChild(newOpt);
                    ratioSelect.value = newRatio;
                }
            });
            ratioContainer.appendChild(ratioInput);
            teatSprayContainer.appendChild(ratioContainer);
            additionalContainer.appendChild(teatSprayContainer);

            // Chemical Check
            const chemicalContainer = document.createElement('div');
            chemicalContainer.classList.add('checklist-item');

            const labelChemical = document.createElement('label');
            labelChemical.textContent = "Chemical Check";
            chemicalContainer.appendChild(labelChemical);

            const statusSelectChemical = document.createElement('select');
            statusSelectChemical.classList.add('form-select');
            statusSelectChemical.name = "status-chemical-check";
            statusSelectChemical.innerHTML = `
                <option value="ok">OK</option>
                <option value="attention-required">Attention Required</option>
                <option value="na">N/A</option>
                <option value="not-checked">Not Checked</option>
            `;
            chemicalContainer.appendChild(statusSelectChemical);

            const commentsInputChemical = document.createElement('input');
            commentsInputChemical.type = 'text';
            commentsInputChemical.classList.add('form-control');
            commentsInputChemical.name = "comments-chemical-check";
            commentsInputChemical.placeholder = 'Comments';
            commentsInputChemical.setAttribute('autocapitalize','words');
            commentsInputChemical.setAttribute('autocorrect','off');
            commentsInputChemical.setAttribute('spellcheck','false');
            chemicalContainer.appendChild(commentsInputChemical);

            const imageUploadChem1 = document.createElement('input');
            imageUploadChem1.type = 'file';
            imageUploadChem1.classList.add('form-control', 'image-upload');
            imageUploadChem1.style.display = 'none';
            chemicalContainer.appendChild(imageUploadChem1);

            const imageUploadChem2 = document.createElement('input');
            imageUploadChem2.type = 'file';
            imageUploadChem2.classList.add('form-control', 'image-upload');
            imageUploadChem2.style.display = 'none';
            chemicalContainer.appendChild(imageUploadChem2);

            statusSelectChemical.addEventListener('change', () => {
                if (statusSelectChemical.value === 'attention-required') {
                    imageUploadChem1.style.display = 'block';
                    imageUploadChem2.style.display = 'block';
                } else {
                    imageUploadChem1.style.display = 'none';
                    imageUploadChem2.style.display = 'none';
                }
            });

            additionalContainer.appendChild(chemicalContainer);
        }

        /****************** 3. FORM CACHING (1 HOUR EXPIRY) ******************/
        // Called when user enters/changes the dairy number field
        async function onDairyNumberBlur() {
            const dairyNumber = document.getElementById('dairy-number').value.trim();
            if (!dairyNumber) return;

            // Clean up old forms older than 1 hour
            await cleanupExpiredForms();

            // Check if there's an active form for this dairyNumber
            const existingForm = await db.forms.get(dairyNumber);
            if (existingForm) {
                // It's within 1 hour or it wouldn't exist now
                const continueForm = confirm(`Would you like to continue form #${dairyNumber}?`);
                if (continueForm) {
                    // Load existing data
                    loadFormDataFromRecord(existingForm);
                } else {
                    // Discard
                    await db.forms.delete(dairyNumber);
                    // Clear out the form visually
                    clearEntireForm();
                }
            } else {
                // If no existing form, just create a new record with creationTime now
                // We'll store an empty stub so we can track start time
                await db.forms.put({
                    dairyNumber: dairyNumber,
                    formData: {},   // will fill in as user types
                    images: {},     // optional if needed
                    creationTime: Date.now()
                });
            }
        }

        // Removes any form older than 1 hour from Dexie
        async function cleanupExpiredForms() {
            const oneHour = 60 * 60 * 1000;
            const now = Date.now();
            const allForms = await db.forms.toArray();
            for (let f of allForms) {
                if (now - f.creationTime > oneHour) {
                    await db.forms.delete(f.dairyNumber);
                }
            }
        }

        // Load form data from an existing Dexie record
        function loadFormDataFromRecord(record) {
            // Overwrite fields in the DOM
            const data = record.formData || {};
            const form = document.getElementById('hygiene-checklist-form');

            // Basic fields
            for (let key in data) {
                const field = form.elements[key];
                if (field) {
                    field.value = data[key];
                }
            }

            // Checklist items
            if (data.checklistItems) {
                loadChecklistItemsData(data.checklistItems);
            }
        }

        // Clear entire form visually
        function clearEntireForm() {
            document.getElementById('hygiene-checklist-form').reset();
            // Also hide any images or re-hide inputs
            const imageUploads = document.querySelectorAll('.image-upload');
            imageUploads.forEach((inp) => {
                inp.style.display = 'none';
            });
        }

        // Provide a helper to load the checklist items from data
        function loadChecklistItemsData(checklistData) {
            // Our checklist items (health-safety-top, main items, additional-checks)
            // We'll assume the order matches what we stored
            const containers = [
                ...document.getElementById('health-safety-top').children,
                ...document.getElementById('checklist-items').children,
                ...document.getElementById('additional-checks').children
            ];
            let idx = 0;
            for (let item of containers) {
                if (!checklistData[idx]) break;
                const statusSelect = item.querySelector('select');
                const commentsInput = item.querySelector('input[type="text"]');
                if (statusSelect) {
                    statusSelect.value = checklistData[idx].status;
                    statusSelect.dispatchEvent(new Event('change'));
                }
                if (commentsInput) {
                    commentsInput.value = checklistData[idx].comments;
                }
                idx++;
            }
        }

        // On each input, we save to Dexie
        async function saveFormData() {
            const dairyNumber = document.getElementById('dairy-number').value.trim();
            if (!dairyNumber) return;

            // Get existing record
            const record = await db.forms.get(dairyNumber);
            if (!record) {
                // Means user typed dairy number, but it wasn't set or we cleaned it up
                // Let's create a new one
                await db.forms.put({
                    dairyNumber: dairyNumber,
                    formData: {},
                    images: {},
                    creationTime: Date.now()
                });
            }
            // Gather data
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Gather checklist items
            const containersToCheck = [
                document.getElementById('health-safety-top').children,
                document.getElementById('checklist-items').children,
                document.getElementById('additional-checks').children
            ];
            const checklistItemsData = [];
            for (let container of containersToCheck) {
                for (let item of container) {
                    const label = item.querySelector('label');
                    if (!label) continue;
                    const itemName = label.textContent;
                    const statusSelect = item.querySelector('select');
                    let status = '';
                    let comments = '';
                    if (statusSelect) {
                        status = statusSelect.value;
                    }
                    const commentsInput = item.querySelector('input[type="text"]');
                    if (commentsInput) {
                        comments = commentsInput.value;
                    }
                    checklistItemsData.push({ itemName, status, comments });
                }
            }
            data.checklistItems = checklistItemsData;

            // Update record
            record.formData = data;
            // Optionally, if you want to store images, you can store them here in record.images
            // but that can be large. For now, we skip storing actual images to Dexie for brevity.

            await db.forms.put(record);
        }

        /****************** 4. GENERATE PDF (removes record from Dexie) ******************/
        async function generatePDF() {
            const dairyNumber = document.getElementById('dairy-number').value.trim();
            if (!dairyNumber) {
                alert("Please enter a Dairy Number.");
                return;
            }
            // We'll finalize the PDF, then remove from Dexie so the user can't continue it
            await finalizePDF(); 
            // Remove from Dexie
            await db.forms.delete(dairyNumber);
            // Clear the form
            clearEntireForm();
        }

        async function finalizePDF() {
            // (Existing PDF generation logic)
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const dairyNumber = formData.get('dairy-number');

            // ... Save to Firebase if needed
            // ... Then do the PDF creation as in your original code

            const pdf = new jsPDF('p', 'pt', 'a4');
            // Attempt to load logo from Firebase storage
            const logoStorageRef = storage.ref('Picture3.jpg');
            try {
                const logoUrl = await logoStorageRef.getDownloadURL();
                const logo = await fetch(logoUrl).then((res) => res.blob());
                const reader = new FileReader();
                reader.readAsDataURL(logo);
                reader.onload = function () {
                    const imgData = reader.result;
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgWidth = pageWidth - 80; 
                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                    const x = (pageWidth - imgWidth) / 2; 
                    pdf.addImage(imgData, 'JPEG', x, 40, imgWidth, imgHeight);

                    pdf.setFontSize(12);
                    pdf.setTextColor('#000000');
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Farm Details:', 40, imgHeight + 60);
                    let currentY = imgHeight + 80;

                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Dairy Company: ${formData.get('dairy-company')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Dairy Number: ${formData.get('dairy-number')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Address: ${formData.get('address')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Customer Name: ${formData.get('customer-name')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Region: ${formData.get('region')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Farm Name: ${formData.get('farm-name')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Island: ${formData.get('island')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Visit Date: ${formData.get('visit-date')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Visit Type: ${formData.get('visit-type')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection Start Time: ${formData.get('inspection-start-time')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection End Time: ${formData.get('inspection-end-time')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection Completed By: ${formData.get('inspection-completed-by')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Call Type: ${formData.get('call-type')}`, 40, currentY);
                    currentY += 30;

                    // Gather items for table
                    const containersToCheck = [
                        document.getElementById('health-safety-top').children,
                        document.getElementById('checklist-items').children,
                        document.getElementById('additional-checks').children
                    ];
                    const checklistTable = [];
                    for (let container of containersToCheck) {
                        for (let item of container) {
                            const name = item.querySelector('label').textContent;
                            const sel = item.querySelector('select');
                            const status = sel ? sel.value : '';
                            const inp = item.querySelector('input[type="text"]');
                            let comments = inp ? inp.value : '';
                            // If needed, handle image logic
                            // For brevity, we'll skip attaching images here
                            checklistTable.push([name, status, comments]);
                        }
                    }

                    pdf.autoTable({
                        startY: currentY,
                        head: [['Item', 'Status', 'Comments']],
                        body: checklistTable,
                        styles: {
                            fontSize: 10,
                            cellPadding: 5
                        },
                        headStyles: {
                            fillColor: '#002B5C',
                            textColor: '#FFFFFF'
                        }
                    });

                    let tempY = pdf.lastAutoTable.finalY + 20;
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Temperature Measurements:', 40, tempY);
                    tempY += 20;

                    pdf.setFont('helvetica', 'normal');
                    const hotWaterTemp = formData.get('hot-water-temp') || '';
                    const hotWaterTime = formData.get('hot-water-time') || '';
                    pdf.text(`Hot Water Temp: ${hotWaterTemp} Â°C`, 40, tempY);
                    tempY += 15;
                    pdf.text(`Time Taken: ${hotWaterTime}`, 40, tempY);
                    tempY += 20;

                    const milkTemp = formData.get('milk-temp') || '';
                    const milkTime = formData.get('milk-time') || '';
                    pdf.text(`Milk Temp: ${milkTemp} Â°C`, 40, tempY);
                    tempY += 15;
                    pdf.text(`Time Taken: ${milkTime}`, 40, tempY);
                    tempY += 20;

                    // Output PDF
                    const pdfBlob = pdf.output('blob');
                    pdf.save(`Dairy_Shed_Hygiene_Checklist_${dairyNumber}.pdf`);

                    // If desired, upload to Firebase
                    if (navigator.onLine) {
                        uploadPDF(dairyNumber, pdfBlob);
                    } else {
                        console.log("Offline: PDF not uploaded, but user has saved file locally.");
                    }
                };
            } catch (err) {
                console.error('Error fetching logo:', err);
            }
        }

        function uploadPDF(dairyNumber, pdfBlob) {
            const timestamp = new Date().toISOString().split('T')[0];
            const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
            const storageRef = storage.ref(`customers/${dairyNumber}/${fileName}`);

            storageRef.put(pdfBlob).then(() => {
                console.log('PDF uploaded successfully');
            }).catch((error) => {
                console.error('Error uploading PDF:', error);
            });
        }

        window.addEventListener('online', syncDataWithFirebase);
        async function syncDataWithFirebase() {
            // Not strictly needed for your 1 hour logic,
            // but if you want to handle offline -> online uploading, do so here
            console.log("Back online - No immediate form upload needed unless storing offline PDFs");
        }

        // View Records Functions
        function viewRecords() {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('record-container').style.display = 'block';
            loadAllRecords();
        }

        async function loadAllRecords() {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const storageRef = storage.ref('customers');

            try {
                const folderSnapshot = await storageRef.listAll();
                folderSnapshot.prefixes.forEach(folderRef => {
                    const dairyNumber = folderRef.name;
                    const folderLink = document.createElement('a');
                    folderLink.textContent = dairyNumber;
                    folderLink.href = '#';
                    folderLink.addEventListener('click', () => {
                        loadRecordFiles(dairyNumber);
                    });
                    recordList.appendChild(folderLink);
                });
            } catch (error) {
                console.error('Error fetching records:', error);
            }
        }

        async function loadRecordFiles(dairyNumber) {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const storageRef = storage.ref(`customers/${dairyNumber}`);

            try {
                const fileSnapshot = await storageRef.listAll();
                fileSnapshot.items.forEach(fileRef => {
                    const fileName = fileRef.name;
                    const dateOnly = fileName.match(/(\d{4}-\d{2}-\d{2})/);
                    const displayName = dateOnly ? dateOnly[0] : fileName;

                    const fileLink = document.createElement('a');
                    fileLink.textContent = displayName;
                    fileLink.href = '#';
                    fileLink.addEventListener('click', async () => {
                        try {
                            const url = await fileRef.getDownloadURL();
                            window.open(url, '_blank');
                        } catch (error) {
                            console.error('Error fetching file:', error);
                        }
                    });
                    recordList.appendChild(fileLink);
                });

                const backButton = document.createElement('button');
                backButton.textContent = 'Back to Records';
                backButton.className = 'back-button';
                backButton.addEventListener('click', goBackToRecords);
                recordList.appendChild(backButton);
            } catch (error) {
                console.error('Error fetching record files:', error);
            }
        }

        function goBack() {
            document.getElementById('form-container').style.display = 'block';
            document.getElementById('record-container').style.display = 'none';
        }

        function goBackToRecords() {
            loadAllRecords();
        }

        function filterRecords() {
            const searchInput = document.getElementById('search-dairy-number').value.toLowerCase();
            const recordList = document.getElementById('record-list');
            const records = recordList.getElementsByTagName('a');

            for (let i = 0; i < records.length; i++) {
                const record = records[i];
                const textValue = record.textContent || record.innerText;
                if (textValue.toLowerCase().indexOf(searchInput) > -1) {
                    record.style.display = "";
                } else {
                    record.style.display = "none";
                }
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            await setupDairyCompanyDatalist();
            createHealthSafetyItems('health-safety-top');
            createChecklistItems();
            await createAdditionalChecks();

            // Add event listeners for form caching
            const form = document.getElementById('hygiene-checklist-form');
            form.addEventListener('input', saveFormData);
        });
    </script>
</body>

</html>
