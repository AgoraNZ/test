<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta tags and CSS links -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Shed Hygiene Checklist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <!-- Your existing styles here -->
    <style>
        /* [Your existing styles here] */
        body {
            background-color: #002B5C;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }

        .container {
            background-color: #002B5C;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
        }

        h1,
        h2 {
            color: #a7ab01;
            text-align: center;
        }

        h1 {
            margin-bottom: 40px;
        }

        label {
            margin-top: 10px;
        }

        button {
            background-color: #FF851B;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            border-radius: 5px;
        }

        button:hover {
            background-color: #FF4136;
        }

        .checklist-item {
            margin-bottom: 30px;
        }

        .form-control,
        .form-select {
            margin-top: 5px;
        }

        .version {
            text-align: center;
            margin-top: 20px;
            color: #FFFFFF;
            font-size: 12px;
        }

        .logo {
            display: block;
            margin: 0 auto 20px;
            width: 250px;
        }

        .record-container {
            background-color: #FFFFFF;
            color: #000000;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            max-width: 1000px;
            width: 100%;
            margin: 20px auto;
        }

        .record-container h2 {
            color: #002B5C;
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-list a {
            text-decoration: none;
            color: #007bff;
            display: block;
            margin-bottom: 10px;
        }

        .back-button {
            margin-top: 20px;
            background-color: #002B5C;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .search-container {
            margin-bottom: 20px;
        }

        /* New styles for image preview */
        .image-preview {
            max-width: 100px;
            display: block;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container" id="form-container">
        <img src="https://i.postimg.cc/htZPjx5g/logo-89.png" alt="Logo" class="logo">
        <h1>Dairy Shed Hygiene Checklist</h1>

        <form id="hygiene-checklist-form">
            <!-- Form Fields -->
            <!-- Farm Details Section -->
            <div class="section mb-4">
                <h2>Farm Details</h2>
                <label for="dairy-number">Dairy Number:</label>
                <input type="text" class="form-control" id="dairy-number" name="dairy-number" onblur="fetchFarmDetails()">

                <label for="dairy-company">Dairy Company:</label>
                <select id="dairy-company" name="dairy-company" class="form-select">
                    <option value="fonterra">Fonterra</option>
                    <option value="dairy-goat-coop">Dairy Goat Co-op</option>
                    <option value="green-valley">Green Valley Dairies</option>
                    <option value="maui-milk">Maui Milk</option>
                    <option value="oceania">Oceania</option>
                    <option value="ofi">OFI</option>
                    <option value="synlait">Synlait Milk LTD</option>
                    <option value="tatua">Tatua</option>
                </select>
                <label for="address">Address:</label>
                <input type="text" class="form-control" id="address" name="address">
                <label for="customer-name">Customer Name:</label>
                <input type="text" class="form-control" id="customer-name" name="customer-name">
                <label for="region">Region:</label>
                <select id="region" name="region" class="form-select">
                    <option value="northland">Northland</option>
                    <option value="auckland">Auckland</option>
                    <option value="waikato">Waikato</option>
                    <option value="bay-of-plenty">Bay of Plenty</option>
                    <option value="gisborne">Gisborne</option>
                    <option value="hawkes-bay">Hawke's Bay</option>
                    <option value="taranaki">Taranaki</option>
                    <option value="manawatu-wanganui">Manawatu-Wanganui</option>
                    <option value="wellington">Wellington</option>
                    <option value="nelson">Nelson</option>
                    <option value="marlborough">Marlborough</option>
                    <option value="west-coast">West Coast</option>
                    <option value="canterbury">Canterbury</option>
                    <option value="otago">Otago</option>
                    <option value="southland">Southland</option>
                </select>
                <label for="farm-name">Farm Name:</label>
                <input type="text" class="form-control" id="farm-name" name="farm-name">
                <label for="island">Island:</label>
                <select id="island" name="island" class="form-select">
                    <option value="north-island">North Island</option>
                    <option value="south-island">South Island</option>
                </select>
                <label for="visit-date">Visit Date:</label>
                <input type="date" class="form-control" id="visit-date" name="visit-date">
                <label for="visit-type">Visit Type:</label>
                <input type="text" class="form-control" id="visit-type" name="visit-type" value="Milking Plant & Milk Vat Check" readonly>
                <label for="inspection-start-time">Inspection Start Time:</label>
                <input type="time" class="form-control" id="inspection-start-time" name="inspection-start-time">
                <label for="inspection-end-time">Inspection End Time:</label>
                <input type="time" class="form-control" id="inspection-end-time" name="inspection-end-time">
                <label for="inspection-completed-by">Inspection Completed By:</label>
                <input type="text" class="form-control" id="inspection-completed-by" name="inspection-completed-by">
                <label for="call-type">Call Type:</label>
                <select id="call-type" name="call-type" class="form-select">
                    <option value="alert">Alert</option>
                    <option value="grade-call">Grade Call</option>
                    <option value="regular-scheduled-visit" selected>Regular Scheduled Visit</option>
                </select>
            </div>

            <!-- Checklist Items Section -->
            <div class="section mb-4">
                <h2>Checklist Items</h2>
                <div id="checklist-items">
                    <!-- Checklist items will be dynamically added here -->
                </div>
            </div>

            <!-- Temperature Measurements Section -->
            <div class="section mb-4">
                <h2>Temperature Measurements</h2>
                <div class="checklist-item">
                    <label for="hot-water-temp">Hot Water Temp (°C):</label>
                    <input type="number" class="form-control" id="hot-water-temp" name="hot-water-temp" step="0.1">
                    <label for="hot-water-time">Time Taken:</label>
                    <input type="time" class="form-control" id="hot-water-time" name="hot-water-time">
                </div>
                <div class="checklist-item">
                    <label for="milk-temp">Milk Temp (°C):</label>
                    <input type="number" class="form-control" id="milk-temp" name="milk-temp" step="0.1">
                    <label for="milk-time">Time Taken:</label>
                    <input type="time" class="form-control" id="milk-time" name="milk-time">
                </div>
            </div>

            <button type="button" onclick="generatePDF()">Generate PDF</button>
            <button type="button" onclick="viewRecords()">View All Records</button>
        </form>
        <div class="version">Version 5.4</div>
    </div>

    <!-- Records Viewing Page -->
    <div id="record-container" class="record-container" style="display: none;">
        <h2>All Dairy Shed Hygiene Records</h2>
        <div class="search-container">
            <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number" oninput="filterRecords()">
        </div>
        <div id="record-list" class="record-list"></div>
        <button class="back-button" onclick="goBack()">Back to Checklist</button>
    </div>

    <!-- Include scripts at the end of the body for better performance -->
    <!-- Include Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- Include external libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- Your main script -->
    <script>
        // Ensure that jsPDF is properly initialized
        const { jsPDF } = window.jspdf;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "dairy-farm-record-system.firebaseapp.com",
            projectId: "dairy-farm-record-system",
            storageBucket: "dairy-farm-record-system.appspot.com",
            messagingSenderId: "422124188212",
            appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const firestore = firebase.firestore();

        // Initialize IndexedDB using Dexie
        const db = new Dexie("OfflineData");
        db.version(2).stores({
            forms: "++id, dairyNumber, formData, pdfBlob",
            drafts: "++id, dairyNumber, formData, photos, timestamp"
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(err => {
                    console.error('Service Worker registration failed:', err);
                });
        }

        // Function definitions

        async function fetchFarmDetails() {
            // [Your existing function code]
            const dairyNumber = document.getElementById('dairy-number').value;
            if (dairyNumber) {
                const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
                try {
                    const url = await storageRef.getDownloadURL();
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('Failed to fetch the farm details');
                    }
                    const data = await response.json();
                    if (data) {
                        document.getElementById('dairy-company').value = data.dairyCompany || '';
                        document.getElementById('address').value = data.address || '';
                        document.getElementById('customer-name').value = data.customerName || '';
                        document.getElementById('region').value = data.region || '';
                        document.getElementById('farm-name').value = data.farmName || '';
                        document.getElementById('island').value = data.island || '';
                    }
                } catch (error) {
                    console.error('Error fetching farm details:', error);
                }
            }
        }

        async function saveFarmDetails(formData) {
            // [Your existing function code]
            const dairyNumber = formData.get('dairy-number');
            const farmDetails = {
                dairyCompany: formData.get('dairy-company'),
                address: formData.get('address'),
                customerName: formData.get('customer-name'),
                region: formData.get('region'),
                farmName: formData.get('farm-name'),
                island: formData.get('island'),
            };
            const storageRef = storage.ref(`farm_details/${dairyNumber}.json`);
            const metadata = {
                contentType: 'application/json',
            };
            try {
                await storageRef.put(new Blob([JSON.stringify(farmDetails)], { type: 'application/json' }), metadata);
                console.log('Farm details saved successfully.');
            } catch (error) {
                console.error('Error saving farm details:', error);
            }
        }

        async function generatePDF() {
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const dairyNumber = formData.get('dairy-number');

            await saveFarmDetails(formData); // Save farm details if not found

            const pdf = new jsPDF('p', 'pt', 'a4');

            // Add logo centered
            const logoStorageRef = storage.ref('Picture3.jpg');
            try {
                const logoUrl = await logoStorageRef.getDownloadURL();
                const logo = await fetch(logoUrl).then((res) => res.blob());
                const reader = new FileReader();
                reader.readAsDataURL(logo);
                reader.onload = async function () {
                    const imgData = reader.result;
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const imgProps = pdf.getImageProperties(imgData);
                    const imgWidth = pageWidth - 80; // Leave some margins
                    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                    const x = (pageWidth - imgWidth) / 2; // Center the image
                    pdf.addImage(imgData, 'JPEG', x, 40, imgWidth, imgHeight);

                    pdf.setFontSize(12);
                    pdf.setTextColor('#000000');
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Farm Details:', 40, imgHeight + 60);

                    let currentY = imgHeight + 80;

                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Dairy Company: ${formData.get('dairy-company')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Dairy Number: ${formData.get('dairy-number')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Address: ${formData.get('address')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Customer Name: ${formData.get('customer-name')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Region: ${formData.get('region')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Farm Name: ${formData.get('farm-name')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Island: ${formData.get('island')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Visit Date: ${formData.get('visit-date')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Visit Type: ${formData.get('visit-type')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection Start Time: ${formData.get('inspection-start-time')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection End Time: ${formData.get('inspection-end-time')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Inspection Completed By: ${formData.get('inspection-completed-by')}`, 40, currentY);
                    currentY += 15;
                    pdf.text(`Call Type: ${formData.get('call-type')}`, 40, currentY);
                    currentY += 30;

                    // Checklist Items Section
                    const checklistItemsDiv = document.getElementById('checklist-items').children;
                    const checklistTable = [];
                    const photos = [];

                    // Load photos from IndexedDB draft
                    const draft = await db.drafts.where('dairyNumber').equals(dairyNumber).first();
                    const savedPhotos = draft ? draft.photos : [];

                    for (let i = 0; i < checklistItemsDiv.length; i++) {
                        const item = checklistItemsDiv[i];
                        const itemName = item.querySelector('label').textContent;
                        const status = item.querySelector('select').value;
                        let comments = item.querySelector('input[type="text"]').value;

                        // Get the image data from the file input or from saved photos
                        const imageInput = item.querySelector('input[type="file"]');
                        let imageFile = imageInput.files[0];
                        let imageDataUrl = null;

                        if (imageFile) {
                            // Read image from file input
                            imageDataUrl = await readFileAsDataURL(imageFile);
                        } else if (savedPhotos && savedPhotos.length > 0) {
                            // Find the saved photo for this item
                            const photoData = savedPhotos.find(photo => photo.itemIndex === i);
                            if (photoData) {
                                const blob = new Blob([photoData.imageData], { type: photoData.imageType });
                                imageDataUrl = await readBlobAsDataURL(blob);
                            }
                        }

                        if (status === 'attention-required') {
                            if (imageDataUrl) {
                                comments += " (See attached photo below)";
                            }
                        }

                        checklistTable.push([itemName, status, comments]);

                        if (imageDataUrl) {
                            // Determine the image type
                            let imageType = imageDataUrl.substring(5, imageDataUrl.indexOf(';'));
                            if (imageType === 'image/jpeg' || imageType === 'image/jpg') {
                                imageType = 'JPEG';
                            } else if (imageType === 'image/png') {
                                imageType = 'PNG';
                            } else {
                                imageType = 'JPEG'; // Default to JPEG
                            }

                            photos.push({
                                imageData: imageDataUrl,
                                title: itemName,
                                imageType: imageType
                            });
                        }
                    }

                    // Generate checklist items table
                    pdf.autoTable({
                        startY: currentY,
                        head: [['Item', 'Status', 'Comments']],
                        body: checklistTable,
                        styles: {
                            fontSize: 10,
                            cellPadding: 5,
                        },
                        headStyles: {
                            fillColor: '#002B5C',
                            textColor: '#FFFFFF'
                        }
                    });

                    // Add temperature data
                    let tempY = pdf.lastAutoTable.finalY + 20;

                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Temperature Measurements:', 40, tempY);
                    tempY += 20;

                    pdf.setFont('helvetica', 'normal');
                    const hotWaterTemp = document.getElementById('hot-water-temp').value.replace(',', '.');
                    const hotWaterTime = document.getElementById('hot-water-time').value;
                    pdf.text(`Hot Water Temp: ${hotWaterTemp} °C`, 40, tempY);
                    tempY += 15;
                    pdf.text(`Time Taken: ${hotWaterTime}`, 40, tempY);
                    tempY += 20;

                    const milkTemp = document.getElementById('milk-temp').value.replace(',', '.');
                    const milkTime = document.getElementById('milk-time').value;
                    pdf.text(`Milk Temp: ${milkTemp} °C`, 40, tempY);
                    tempY += 15;
                    pdf.text(`Time Taken: ${milkTime}`, 40, tempY);
                    tempY += 20;

                    // Add photos after the temperature data
                    let photoY = tempY + 20; // Adjust as needed

                    for (let photo of photos) {
                        if (photoY > pdf.internal.pageSize.getHeight() - 220) {
                            // If we're getting close to the end of the page, add a new page
                            pdf.addPage();
                            photoY = 60; // Reset Y position for the new page
                        }

                        try {
                            pdf.addImage(photo.imageData, photo.imageType, 40, photoY, 250, 200); // Adjust the size to fit more photos
                            pdf.setFontSize(12);
                            pdf.text(photo.title, 40, photoY - 10); // Add the title above the photo
                            photoY += 220; // Move Y position down for the next photo (image height + spacing)
                        } catch (error) {
                            console.error('Error adding image to PDF:', error);
                        }
                    }

                    // Save PDF and upload to Firebase
                    const pdfBlob = pdf.output('blob');

                    if (navigator.onLine) {
                        uploadPDF(dairyNumber, pdfBlob);
                    } else {
                        // Save data to IndexedDB
                        db.forms.add({
                            dairyNumber: dairyNumber,
                            formData: Object.fromEntries(formData.entries()),
                            pdfBlob: pdfBlob
                        }).then(() => {
                            console.log('Data saved locally. Will sync when back online.');
                        }).catch((error) => {
                            console.error('Error saving data locally:', error);
                        });
                    }

                    pdf.save('Dairy_Shed_Hygiene_Checklist.pdf');

                    // Clear the saved form data after submission
                    await db.drafts.where('dairyNumber').equals(dairyNumber).delete();
                };
            } catch (error) {
                console.error('Error fetching logo:', error);
            }
        }

        function uploadPDF(dairyNumber, pdfBlob) {
            // [Your existing function code]
            const timestamp = new Date().toISOString().split('T')[0];
            const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
            const storageRef = storage.ref(`customers/${dairyNumber}/${fileName}`);

            storageRef.put(pdfBlob).then(() => {
                console.log('PDF uploaded successfully');
            }).catch((error) => {
                console.error('Error uploading PDF:', error);
            });
        }

        window.addEventListener('online', syncDataWithFirebase);

        async function syncDataWithFirebase() {
            // [Your existing function code]
            const offlineForms = await db.forms.toArray();

            for (const record of offlineForms) {
                const dairyNumber = record.dairyNumber;
                const pdfBlob = record.pdfBlob;

                uploadPDF(dairyNumber, pdfBlob);

                // Remove the record from IndexedDB after uploading
                db.forms.delete(record.id);
            }

            console.log('All offline data has been synced with Firebase.');
        }

        function createChecklistItems() {
            const checklistItems = [
                "Pulsator Airline", "Long Bend Elbows", "Automatic Cup and Remover", "Diaphragm", "Receiving Can",
                "Sanitary Trap", "Main Milk Line", "Milk Line Seals in Good Condition", "Stainless Droppers", "Long Milk Rubber",
                "Liner", "Cluster", "Cluster Seal", "Cluster Button", "Non Return Valve at Milk Pump", "Milk Pump",
                "Filter Housing", "Plate Cooler", "Interceptor", "Receiver Airline", "Flushing Pulsator", "Air Purge Valve",
                "Vacuum Level", "Main Airline", "Plant Drainage - Milk Pump", "Plant Drainage - Filter/s", "Plant Drainage - Plate Cooler",
                "Plant Drainage - Vat Entry", "Plant Wash Tap", "Wash Jetters", "Centre Gland", "Test Bucket",
                "Inlet Valve", "Non-Return Valve", "Spray Ball", "Agitator", "Silo Door", "Manhole Seal", "Vat Outlet", "Walls in Silo"
            ];

            const itemsToAutoFill = [
                "Inlet Valve",
                "Non-Return Valve",
                "Spray Ball",
                "Agitator",
                "Silo Door",
                "Manhole Seal",
                "Vat Outlet",
                "Walls in Silo"
            ];

            const checklistContainer = document.getElementById('checklist-items');
            checklistContainer.innerHTML = '';

            checklistItems.forEach((item, index) => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('checklist-item');

                const label = document.createElement('label');
                label.textContent = item;
                itemContainer.appendChild(label);

                const statusSelect = document.createElement('select');
                statusSelect.classList.add('form-select');
                statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
                itemContainer.appendChild(statusSelect);

                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.classList.add('form-control');
                commentsInput.placeholder = 'Comments';
                itemContainer.appendChild(commentsInput);

                const imageUpload = document.createElement('input');
                imageUpload.type = 'file';
                imageUpload.classList.add('form-control', 'image-upload');
                imageUpload.style.display = 'none';
                itemContainer.appendChild(imageUpload);

                // Add image preview element
                const imagePreview = document.createElement('img');
                imagePreview.classList.add('image-preview');
                imagePreview.style.display = 'none'; // Initially hidden
                itemContainer.appendChild(imagePreview);

                statusSelect.addEventListener('change', () => {
                    if (statusSelect.value === 'attention-required') {
                        imageUpload.style.display = 'block';
                    } else {
                        imageUpload.style.display = 'none';
                    }

                    if (statusSelect.value === 'not-checked' && itemsToAutoFill.includes(item)) {
                        commentsInput.value = "Milk in Vat";
                    } else if (commentsInput.value === "Milk in Vat") {
                        commentsInput.value = ""; // Clear the field if it was auto-filled
                    }
                    saveFormData();
                });

                // Event listeners for saving data
                statusSelect.addEventListener('change', saveFormData);
                commentsInput.addEventListener('input', saveFormData);

                imageUpload.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const imageUrl = URL.createObjectURL(file);
                        imagePreview.src = imageUrl;
                        imagePreview.style.display = 'block';
                    } else {
                        imagePreview.style.display = 'none';
                    }
                    saveFormData();
                });

                checklistContainer.appendChild(itemContainer);
            });
        }

        // View Records Functions

        function viewRecords() {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('record-container').style.display = 'block';
            loadAllRecords();
        }

        async function loadAllRecords() {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const storageRef = storage.ref('customers');

            try {
                const folderSnapshot = await storageRef.listAll();
                folderSnapshot.prefixes.forEach(folderRef => {
                    const dairyNumber = folderRef.name;
                    const folderLink = document.createElement('a');
                    folderLink.textContent = dairyNumber;
                    folderLink.href = '#';
                    folderLink.addEventListener('click', () => {
                        loadRecordFiles(dairyNumber);
                    });
                    recordList.appendChild(folderLink);
                });
            } catch (error) {
                console.error('Error fetching records:', error);
            }
        }

        async function loadRecordFiles(dairyNumber) {
            const recordList = document.getElementById('record-list');
            recordList.innerHTML = '';
            const storageRef = storage.ref(`customers/${dairyNumber}`);

            try {
                const fileSnapshot = await storageRef.listAll();
                fileSnapshot.items.forEach(fileRef => {
                    const fileName = fileRef.name;
                    const dateOnly = fileName.match(/(\d{4}-\d{2}-\d{2})/);
                    const displayName = dateOnly ? dateOnly[0] : fileName;

                    const fileLink = document.createElement('a');
                    fileLink.textContent = displayName;
                    fileLink.href = '#';
                    fileLink.addEventListener('click', async () => {
                        try {
                            const url = await fileRef.getDownloadURL();
                            window.open(url, '_blank');
                        } catch (error) {
                            console.error('Error fetching file:', error);
                        }
                    });
                    recordList.appendChild(fileLink);
                });

                const backButton = document.createElement('button');
                backButton.textContent = 'Back to Records';
                backButton.className = 'back-button';
                backButton.addEventListener('click', goBackToRecords);
                recordList.appendChild(backButton);
            } catch (error) {
                console.error('Error fetching record files:', error);
            }
        }

        function goBack() {
            document.getElementById('form-container').style.display = 'block';
            document.getElementById('record-container').style.display = 'none';
        }

        function goBackToRecords() {
            loadAllRecords();
        }

        function filterRecords() {
            const searchInput = document.getElementById('search-dairy-number').value.toLowerCase();
            const recordList = document.getElementById('record-list');
            const records = recordList.getElementsByTagName('a');

            for (let i = 0; i < records.length; i++) {
                const record = records[i];
                const textValue = record.textContent || record.innerText;
                if (textValue.toLowerCase().indexOf(searchInput) > -1) {
                    record.style.display = "";
                } else {
                    record.style.display = "none";
                }
            }
        }

        // Function to save form data to IndexedDB
        async function saveFormData() {
            const form = document.getElementById('hygiene-checklist-form');
            const formData = new FormData(form);
            const formObject = {};

            // Save standard form fields
            for (const [key, value] of formData.entries()) {
                formObject[key] = value;
            }

            // Save checklist items and photos
            const checklistItemsDiv = document.getElementById('checklist-items').children;
            const checklistData = [];
            const photos = [];

            for (let i = 0; i < checklistItemsDiv.length; i++) {
                const item = checklistItemsDiv[i];
                const itemName = item.querySelector('label').textContent;
                const status = item.querySelector('select').value;
                const comments = item.querySelector('input[type="text"]').value;
                const imageInput = item.querySelector('input[type="file"]');
                const imageFile = imageInput.files[0];

                let imageData = null;

                if (imageFile) {
                    // Read the image file as ArrayBuffer to store in IndexedDB
                    imageData = await readFileAsArrayBuffer(imageFile);
                    photos.push({
                        itemIndex: i,
                        itemName: itemName,
                        imageData: imageData,
                        imageType: imageFile.type
                    });
                }

                checklistData.push({
                    itemName: itemName,
                    status: status,
                    comments: comments,
                    hasImage: !!imageFile
                });
            }

            formObject['checklistData'] = checklistData;

            const dairyNumber = formObject['dairy-number'] || 'unknown';

            // Save the form data and photos to IndexedDB
            await db.drafts.put({
                dairyNumber: dairyNumber,
                formData: formObject,
                photos: photos,
                timestamp: new Date().getTime()
            });
        }

        // Function to populate form with saved data
        async function populateForm(data) {
            const form = document.getElementById('hygiene-checklist-form');

            // Populate standard form fields
            for (const [key, value] of Object.entries(data.formData)) {
                if (key !== 'checklistData') {
                    const field = form.elements[key];
                    if (field) {
                        field.value = value;
                    }
                }
            }

            // Populate checklist items
            if (data.formData.checklistData) {
                const checklistItemsDiv = document.getElementById('checklist-items').children;

                for (let i = 0; i < checklistItemsDiv.length; i++) {
                    const item = checklistItemsDiv[i];
                    const checklistItemData = data.formData.checklistData[i];

                    const statusSelect = item.querySelector('select');
                    const commentsInput = item.querySelector('input[type="text"]');
                    const imageInput = item.querySelector('input[type="file"]');
                    const imagePreview = item.querySelector('.image-preview');

                    if (statusSelect && commentsInput && checklistItemData) {
                        statusSelect.value = checklistItemData.status;
                        commentsInput.value = checklistItemData.comments;

                        if (checklistItemData.hasImage) {
                            const photoData = data.photos.find(photo => photo.itemIndex === i);
                            if (photoData) {
                                // Create a Blob from the ArrayBuffer
                                const blob = new Blob([photoData.imageData], { type: photoData.imageType });
                                const imageUrl = URL.createObjectURL(blob);

                                // Display the image preview
                                imagePreview.src = imageUrl;
                                imagePreview.style.display = 'block';
                            }
                        }
                    }
                }
            }
        }

        // Helper functions to read files
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    resolve(event.target.result);
                };
                reader.onerror = function (error) {
                    reject(error);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function readBlobAsDataURL(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    resolve(event.target.result);
                };
                reader.onerror = function (error) {
                    reject(error);
                };
                reader.readAsDataURL(blob);
            });
        }

        // Add the missing helper function
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    resolve(event.target.result);
                };
                reader.onerror = function (error) {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }

        document.addEventListener("DOMContentLoaded", async () => {
            createChecklistItems();
            // Other initialization code

            const drafts = await db.drafts.toArray();
            if (drafts.length > 0) {
                const recentDraft = drafts[drafts.length - 1];
                const resume = confirm('You have an unsaved checklist. Would you like to resume?');
                if (resume) {
                    await populateForm(recentDraft);
                } else {
                    await db.drafts.delete(recentDraft.id);
                }
            }
        });

        // Add event listeners to save form data on input
        document.getElementById('hygiene-checklist-form').addEventListener('input', saveFormData);
    </script>
</body>

</html>
